# Configuration for default graph edge
apiVersion: "config.istio.io/v1alpha2"
kind: edge
metadata:
  name: default
  namespace: istio-system
spec:
  timestamp: request.time
  sourceUid: source.uid | "Unknown"
  sourceOwner: source.owner | "Unknown"
  sourceWorkloadName: source.workload.name | "Unknown"
  sourceWorkloadNamespace: source.workload.namespace | "Unknown"
  destinationUid: destination.uid | "Unknown"
  destinationOwner: destination.owner | "Unknown"
  destinationWorkloadName: destination.workload.name | "Unknown"
  destinationWorkloadNamespace: destination.workload.namespace | "Unknown"
  contextProtocol: context.protocol | "Unknown"
  apiProtocol: api.protocol | "Unknown"
---
# Configuration for a fluentd handler
apiVersion: "config.istio.io/v1alpha2"
kind: stackdriver
metadata:
  name: handler
  namespace: istio-system
spec:
  projectId: context-istio-test
  serviceAccountPath: /context-account/sa.json
---
# Rule to send logentry instances to the fluentd handler
apiVersion: "config.istio.io/v1alpha2"
kind: rule
metadata:
  name: edgetosd
  namespace: istio-system
spec:
  match: "true" # match for all requests
  actions:
   - handler: handler.stackdriver
     instances:
     - default.edge
---
# apiVersion: "config.istio.io/v1alpha2"
# kind: logentry
# metadata:
#   name: contextlog
#   namespace: istio-system
# spec:
#   severity: '"Info"'
#   timestamp: request.time
#   variables:
#     sourceName: source.name | "Unknown"
#     sourceNamespace: source.namespace | "Unknown"
#     sourceOwner: source.owner | "Unknown"
#     sourceWorkloadName: source.workload.name | "Unknown"
#     sourceWorkloadNamespace: source.workload.namespace | "Unknown"
#     destinationName: destination.name | "Unknown"
#     destinationNamespace: destination.namespace | "Unknown"
#     destinationOwner: destination.owner | "Unknown"
#     destinationWorkloadName: destination.workload.name | "Unknown"
#     destinationWorkloadNamespace: destination.workload.namespace | "Unknown"
#     contextProtocol: context.protocol | "Unknown"
#     apiProtocol: api.protocol | "Unknown"
#   monitored_resource_type: '"UNSPECIFIED"'
# ---
# apiVersion: "config.istio.io/v1alpha2"
# kind: rule
# metadata:
#   name: contextlogtostdout
#   namespace: istio-system
# spec:
#   match: "true" # If omitted match is true.
#   actions:
#   - handler: handler.stdio
#     instances:
#     - contextlog.logentry
# ---
