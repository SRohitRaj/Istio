#!/bin/bash
# Runs `make precommit` when running under git commit. If called directly,
# installs a pre-commit hook.
#
# Assumes that Istio is cloned to $GOPATH/src/istio.io/istio.

set -o errexit

REPO_ROOT=${GOPATH}/src/istio.io/istio

if [[ -z ${GIT_AUTHOR_DATE} ]]; then
    # Not running under git commit; install handler
    cd ${REPO_ROOT}/.git/hooks/
    if [[ -e pre-commit ]]; then
        echo "pre-commit hook already exists"
    else
        echo "Installing pre-commit hook to .git/hooks/pre-commit"
        ln -s ${REPO_ROOT}/bin/pre-commit
    fi
else
    # If we don't have a branch then we're in a detached state (e.g. mid
    # rebase) and don't want to execute our checks.
    BRANCH_NAME=$(git branch | grep '*' | sed 's/* //')
    if [[ ${BRANCH_NAME} != '(no branch)' ]]; then
        cd ${REPO_ROOT}
        make precommit
    fi
fi
