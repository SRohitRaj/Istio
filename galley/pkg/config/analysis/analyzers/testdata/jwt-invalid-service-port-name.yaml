apiVersion: authentication.istio.io/v1alpha1
kind: Policy
metadata:
  name: test-with-ports
  namespace: my-namespace
spec:
  targets:
    - name: my-service
      ports:
        - number: 8080
        - number: 8081
        - number: 8082
  origins:
    - jwt:
        issuer: "testing@secure.istio.io"
        jwksUri: "https://raw.githubusercontent.com/istio/istio/release-1.4/security/tools/jwt/samples/jwks.json"
---
apiVersion: v1
kind: Service
metadata:
  name: my-service
  namespace: my-namespace
spec:
  selector:
    app: my-service
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
      name: svc-8080
    - protocol: TCP
      port: 8081
      targetPort: 8081
      name: https-svc-8081
    - protocol: TCP
      port: 8082
      targetPort: 8082
      name: http2-svc-8082
---
apiVersion: authentication.istio.io/v1alpha1
kind: Policy
metadata:
  name: test-without-ports
  namespace: my-namespace-2
spec:
  targets:
    - name: my-service-no-target-ports-specified
  origins:
    - jwt:
        issuer: "testing@secure.istio.io"
        jwksUri: "https://raw.githubusercontent.com/istio/istio/release-1.4/security/tools/jwt/samples/jwks.json"
---
apiVersion: v1
kind: Service
metadata:
  name: my-service-no-target-ports-specified
  namespace: my-namespace-2
spec:
  selector:
    app: my-service-no-target-ports-specified
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
      name: http-svc-8080
    - protocol: TCP
      port: 8081
      targetPort: 8081
      name: svc-8081
    - protocol: TCP
      port: 8082
      targetPort: 8082
      name: svc-8082
---
apiVersion: authentication.istio.io/v1alpha1
kind: Policy
metadata:
  name: test-with-udp-port
  namespace: my-namespace-not-tcp
spec:
  targets:
    - name: my-service-no-target-ports-specified
  origins:
    - jwt:
        issuer: "testing@secure.istio.io"
        jwksUri: "https://raw.githubusercontent.com/istio/istio/release-1.4/security/tools/jwt/samples/jwks.json"
---
apiVersion: v1
kind: Service
metadata:
  name: my-service-no-target-ports-specified
  namespace: my-namespace-not-tcp
spec:
  selector:
    app: my-service-no-target-ports-specified
  ports:
    - protocol: UDP
      port: 8080
      targetPort: 8080
      name: http-svc-8080
---
