If you suffer an unexpected failure, please reference: https://github.com/istio/istio/wiki/Troubleshooting-Development-Environment
Building with the build container: gcr.io/istio-testing/build-tools:master-2020-02-14T13-09-14.
Using docker credential directory /Users/mariamjohn/.docker.
Using local Kubernetes configuration /Users/mariamjohn/.kube
base64: invalid input
KUBECONFIG="${KUBECONFIG:-${REPO_ROOT}/tests/util/kubeconfig}" \
make -e -f Makefile.core.mk --keep-going common-test pilot-test mixer-test security-test galley-test istioctl-test operator-test \
2>&1 | tee >(/usr/bin/go-junit-report > /work/out/darwin_amd64/junit.xml)
mkdir -p /work/out/darwin_amd64/logs
mkdir -p /work/out/darwin_amd64/release
STATIC=0 GOOS=linux GOARCH=amd64 LDFLAGS='-extldflags -static -s -w' common/scripts/gobuild.sh /work/out/linux_amd64/ ./istioctl/cmd/istioctl ./pilot/cmd/pilot-discovery ./pilot/cmd/pilot-agent ./mixer/cmd/mixs ./mixer/cmd/mixc ./mixer/tools/mixgen ./galley/cmd/galley ./security/cmd/node_agent ./security/cmd/istio_ca ./security/tools/sdsclient ./pkg/test/echo/cmd/client ./pkg/test/echo/cmd/server ./mixer/test/policybackend ./tools/istio-iptables ./tools/istio-clean-iptables ./operator/cmd/operator

real	1m35.720s
user	2m16.523s
sys	1m30.055s
# Execute bash shell unit tests scripts
LOCAL_OUT=/work/out/linux_amd64 ./tests/scripts/istio-iptables-test.sh
ok	istio.io/./tests/scripts/istio-iptables-test.sh/mode_redirect (golang)	0.000s
ok	istio.io/./tests/scripts/istio-iptables-test.sh/clean (golang_clean)	0.000s
ok	istio.io/./tests/scripts/istio-iptables-test.sh/mode_tproxy (golang)	0.000s
ok	istio.io/./tests/scripts/istio-iptables-test.sh/clean (golang_clean)	0.000s
ok	istio.io/./tests/scripts/istio-iptables-test.sh/clean (golang_clean)	0.000s
ok	istio.io/./tests/scripts/istio-iptables-test.sh/mode_tproxy_and_wildcard_port (golang)	0.000s
ok	istio.io/./tests/scripts/istio-iptables-test.sh/clean (golang_clean)	0.000s
ok	istio.io/./tests/scripts/istio-iptables-test.sh/empty_parameter (golang)	0.000s
ok	istio.io/./tests/scripts/istio-iptables-test.sh/clean (golang_clean)	0.000s
ok	istio.io/./tests/scripts/istio-iptables-test.sh/outbound_port_exclude (golang)	0.000s
ok	istio.io/./tests/scripts/istio-iptables-test.sh/clean (golang_clean)	0.000s
ok	istio.io/./tests/scripts/istio-iptables-test.sh/wildcard_include_ip_range (golang)	0.000s
ok	istio.io/./tests/scripts/istio-iptables-test.sh/clean (golang_clean)	0.000s

All tests were successful
go test  -race ./pkg/... ./tests/common/... ./tools/istio-iptables/...
?   	istio.io/istio/pkg/adsc	[no test files]
ok  	istio.io/istio/pkg/bootstrap	5.077s
?   	istio.io/istio/pkg/bootstrap/auth	[no test files]
ok  	istio.io/istio/pkg/bootstrap/option	(cached)
ok  	istio.io/istio/pkg/bootstrap/platform	(cached)
ok  	istio.io/istio/pkg/cmd	(cached)
?   	istio.io/istio/pkg/config	[no test files]
?   	istio.io/istio/pkg/config/constants	[no test files]
ok  	istio.io/istio/pkg/config/event	(cached)
?   	istio.io/istio/pkg/config/gateway	[no test files]
ok  	istio.io/istio/pkg/config/host	(cached)
?   	istio.io/istio/pkg/config/kube	[no test files]
ok  	istio.io/istio/pkg/config/labels	(cached)
ok  	istio.io/istio/pkg/config/mesh	(cached)
ok  	istio.io/istio/pkg/config/protocol	(cached)
ok  	istio.io/istio/pkg/config/resource	(cached)
ok  	istio.io/istio/pkg/config/schema	(cached)
ok  	istio.io/istio/pkg/config/schema/ast	(cached)
ok  	istio.io/istio/pkg/config/schema/codegen	(cached)
ok  	istio.io/istio/pkg/config/schema/collection	(cached)
ok  	istio.io/istio/pkg/config/schema/collections	(cached)
ok  	istio.io/istio/pkg/config/schema/resource	(cached)
?   	istio.io/istio/pkg/config/schema/snapshots	[no test files]
ok  	istio.io/istio/pkg/config/security	(cached)
ok  	istio.io/istio/pkg/config/validation	(cached)
?   	istio.io/istio/pkg/config/visibility	[no test files]
?   	istio.io/istio/pkg/config/xds	[no test files]
ok  	istio.io/istio/pkg/envoy	19.367s
?   	istio.io/istio/pkg/istio-agent	[no test files]
?   	istio.io/istio/pkg/jwt	[no test files]
ok  	istio.io/istio/pkg/keepalive	(cached)
ok  	istio.io/istio/pkg/kube	(cached)
ok  	istio.io/istio/pkg/kube/inject	129.792s
ok  	istio.io/istio/pkg/kube/secretcontroller	(cached)
ok  	istio.io/istio/pkg/mcp/configz/client	(cached)
?   	istio.io/istio/pkg/mcp/configz/client/assets	[no test files]
ok  	istio.io/istio/pkg/mcp/configz/server	(cached)
?   	istio.io/istio/pkg/mcp/configz/server/assets	[no test files]
ok  	istio.io/istio/pkg/mcp/creds	(cached)
ok  	istio.io/istio/pkg/mcp/internal	(cached)
?   	istio.io/istio/pkg/mcp/internal/test	[no test files]
?   	istio.io/istio/pkg/mcp/monitoring	[no test files]
?   	istio.io/istio/pkg/mcp/rate	[no test files]
ok  	istio.io/istio/pkg/mcp/server	(cached)
ok  	istio.io/istio/pkg/mcp/sink	(cached)
ok  	istio.io/istio/pkg/mcp/snapshot	(cached)
ok  	istio.io/istio/pkg/mcp/source	(cached)
?   	istio.io/istio/pkg/mcp/status	[no test files]
?   	istio.io/istio/pkg/mcp/testing	[no test files]
?   	istio.io/istio/pkg/mcp/testing/groups	[no test files]
?   	istio.io/istio/pkg/mcp/testing/monitoring	[no test files]
?   	istio.io/istio/pkg/mcp/testing/testcerts	[no test files]
ok  	istio.io/istio/pkg/mcp/tests/stress	(cached)
?   	istio.io/istio/pkg/proto	[no test files]
ok  	istio.io/istio/pkg/queue	(cached)
ok  	istio.io/istio/pkg/spiffe	(cached)
?   	istio.io/istio/pkg/test	[no test files]
?   	istio.io/istio/pkg/test/config	[no test files]
ok  	istio.io/istio/pkg/test/conformance	(cached)
ok  	istio.io/istio/pkg/test/conformance/constraint	(cached)
?   	istio.io/istio/pkg/test/deployment	[no test files]
?   	istio.io/istio/pkg/test/deps	[no test files]
?   	istio.io/istio/pkg/test/docker	[no test files]
?   	istio.io/istio/pkg/test/echo/client	[no test files]
?   	istio.io/istio/pkg/test/echo/cmd/client	[no test files]
?   	istio.io/istio/pkg/test/echo/cmd/server	[no test files]
?   	istio.io/istio/pkg/test/echo/common	[no test files]
?   	istio.io/istio/pkg/test/echo/common/response	[no test files]
?   	istio.io/istio/pkg/test/echo/common/scheme	[no test files]
?   	istio.io/istio/pkg/test/echo/proto	[no test files]
?   	istio.io/istio/pkg/test/echo/server	[no test files]
?   	istio.io/istio/pkg/test/echo/server/endpoint	[no test files]
?   	istio.io/istio/pkg/test/echo/server/forwarder	[no test files]
?   	istio.io/istio/pkg/test/env	[no test files]
ok  	istio.io/istio/pkg/test/envoy	(cached)
?   	istio.io/istio/pkg/test/fakes/policy	[no test files]
ok  	istio.io/istio/pkg/test/framework	(cached)
?   	istio.io/istio/pkg/test/framework/components/bookinfo	[no test files]
?   	istio.io/istio/pkg/test/framework/components/chiron	[no test files]
?   	istio.io/istio/pkg/test/framework/components/citadel	[no test files]
?   	istio.io/istio/pkg/test/framework/components/deployment	[no test files]
?   	istio.io/istio/pkg/test/framework/components/echo	[no test files]
ok  	istio.io/istio/pkg/test/framework/components/echo/common	(cached)
?   	istio.io/istio/pkg/test/framework/components/echo/docker	[no test files]
?   	istio.io/istio/pkg/test/framework/components/echo/docker/images	[no test files]
?   	istio.io/istio/pkg/test/framework/components/echo/echoboot	[no test files]
?   	istio.io/istio/pkg/test/framework/components/echo/kube	[no test files]
?   	istio.io/istio/pkg/test/framework/components/environment	[no test files]
?   	istio.io/istio/pkg/test/framework/components/environment/api	[no test files]
?   	istio.io/istio/pkg/test/framework/components/environment/kube	[no test files]
?   	istio.io/istio/pkg/test/framework/components/environment/native	[no test files]
ok  	istio.io/istio/pkg/test/framework/components/galley	(cached)
?   	istio.io/istio/pkg/test/framework/components/ingress	[no test files]
?   	istio.io/istio/pkg/test/framework/components/istio	[no test files]
?   	istio.io/istio/pkg/test/framework/components/istioctl	[no test files]
?   	istio.io/istio/pkg/test/framework/components/mcpserver	[no test files]
?   	istio.io/istio/pkg/test/framework/components/mixer	[no test files]
?   	istio.io/istio/pkg/test/framework/components/namespace	[no test files]
?   	istio.io/istio/pkg/test/framework/components/pilot	[no test files]
?   	istio.io/istio/pkg/test/framework/components/policybackend	[no test files]
?   	istio.io/istio/pkg/test/framework/components/prometheus	[no test files]
?   	istio.io/istio/pkg/test/framework/components/redis	[no test files]
?   	istio.io/istio/pkg/test/framework/components/zipkin	[no test files]
?   	istio.io/istio/pkg/test/framework/core	[no test files]
?   	istio.io/istio/pkg/test/framework/core/image	[no test files]
?   	istio.io/istio/pkg/test/framework/errors	[no test files]
ok  	istio.io/istio/pkg/test/framework/integration	(cached)
ok  	istio.io/istio/pkg/test/framework/label	(cached)
?   	istio.io/istio/pkg/test/framework/resource	[no test files]
?   	istio.io/istio/pkg/test/kube	[no test files]
?   	istio.io/istio/pkg/test/scopes	[no test files]
?   	istio.io/istio/pkg/test/shell	[no test files]
?   	istio.io/istio/pkg/test/util	[no test files]
?   	istio.io/istio/pkg/test/util/crosscompile	[no test files]
ok  	istio.io/istio/pkg/test/util/curl	(cached)
?   	istio.io/istio/pkg/test/util/file	[no test files]
?   	istio.io/istio/pkg/test/util/reserveport	[no test files]
?   	istio.io/istio/pkg/test/util/retry	[no test files]
ok  	istio.io/istio/pkg/test/util/structpath	(cached)
?   	istio.io/istio/pkg/test/util/tmpl	[no test files]
ok  	istio.io/istio/pkg/test/util/yml	(cached)
ok  	istio.io/istio/pkg/tracing	(cached)
ok  	istio.io/istio/pkg/util	(cached)
?   	istio.io/istio/pkg/util/gogo	[no test files]
?   	istio.io/istio/pkg/util/gogoprotomarshal	[no test files]
?   	istio.io/istio/pkg/util/protomarshal	[no test files]
ok  	istio.io/istio/pkg/util/strcase	(cached)
ok  	istio.io/istio/pkg/webhooks/validation/controller	(cached)
ok  	istio.io/istio/pkg/webhooks/validation/server	(cached)
ok  	istio.io/istio/tests/common/jwt	(cached)
?   	istio.io/istio/tools/istio-iptables	[no test files]
ok  	istio.io/istio/tools/istio-iptables/pkg/builder	(cached)
ok  	istio.io/istio/tools/istio-iptables/pkg/cmd	(cached)
?   	istio.io/istio/tools/istio-iptables/pkg/config	[no test files]
?   	istio.io/istio/tools/istio-iptables/pkg/constants	[no test files]
?   	istio.io/istio/tools/istio-iptables/pkg/dependencies	[no test files]
ok  	istio.io/istio/tools/istio-iptables/pkg/validation	(cached)
go test  -race ./pilot/...
ok  	istio.io/istio/pilot/cmd/pilot-agent	(cached)
ok  	istio.io/istio/pilot/cmd/pilot-agent/status	(cached)
ok  	istio.io/istio/pilot/cmd/pilot-agent/status/ready	(cached)
?   	istio.io/istio/pilot/cmd/pilot-agent/status/util	[no test files]
?   	istio.io/istio/pilot/cmd/pilot-discovery	[no test files]
ok  	istio.io/istio/pilot/pkg/bootstrap	(cached)
ok  	istio.io/istio/pilot/pkg/config/aggregate	(cached)
?   	istio.io/istio/pilot/pkg/config/aggregate/fakes	[no test files]
ok  	istio.io/istio/pilot/pkg/config/kube/crd	(cached)
?   	istio.io/istio/pilot/pkg/config/kube/crd/codegen	[no test files]
?   	istio.io/istio/pilot/pkg/config/kube/crd/controller	[no test files]
ok  	istio.io/istio/pilot/pkg/config/kube/gateway	(cached)
ok  	istio.io/istio/pilot/pkg/config/kube/ingress	(cached)
ok  	istio.io/istio/pilot/pkg/config/memory	(cached)
ok  	istio.io/istio/pilot/pkg/config/monitor	(cached)
ok  	istio.io/istio/pilot/pkg/features	(cached)
ok  	istio.io/istio/pilot/pkg/leaderelection	(cached)
ok  	istio.io/istio/pilot/pkg/model	(cached)
?   	istio.io/istio/pilot/pkg/model/test	[no test files]
ok  	istio.io/istio/pilot/pkg/networking	(cached)
?   	istio.io/istio/pilot/pkg/networking/core	[no test files]
ok  	istio.io/istio/pilot/pkg/networking/core/v1alpha3	(cached)
ok  	istio.io/istio/pilot/pkg/networking/core/v1alpha3/envoyfilter	(cached)
?   	istio.io/istio/pilot/pkg/networking/core/v1alpha3/fakes	[no test files]
ok  	istio.io/istio/pilot/pkg/networking/core/v1alpha3/loadbalancer	(cached)
ok  	istio.io/istio/pilot/pkg/networking/core/v1alpha3/route	(cached)
ok  	istio.io/istio/pilot/pkg/networking/core/v1alpha3/route/retry	(cached)
?   	istio.io/istio/pilot/pkg/networking/plugin	[no test files]
?   	istio.io/istio/pilot/pkg/networking/plugin/authn	[no test files]
?   	istio.io/istio/pilot/pkg/networking/plugin/authz	[no test files]
ok  	istio.io/istio/pilot/pkg/networking/plugin/health	(cached)
ok  	istio.io/istio/pilot/pkg/networking/plugin/mixer	(cached)
?   	istio.io/istio/pilot/pkg/networking/plugin/mixer/client	[no test files]
ok  	istio.io/istio/pilot/pkg/networking/plugin/registry	(cached)
ok  	istio.io/istio/pilot/pkg/networking/util	(cached)
ok  	istio.io/istio/pilot/pkg/proxy	(cached)
ok  	istio.io/istio/pilot/pkg/proxy/envoy	(cached)
ok  	istio.io/istio/pilot/pkg/proxy/envoy/v2	67.684s
fine
fine
fine
not-found
<html><head><meta http-equiv="refresh" content="0;url=http://dnserrorassist.att.net/search/?q=http://notpilot%2Fwant%2Fpath&bc="/></head><body><script type="text/javascript">window.location="http://dnserrorassist.att.net/search/?q="+escape(window.location)+"&r="+escape(document.referrer)+"&bc=";</script></body></html>
--- FAIL: Test_command_do (0.25s)
    --- FAIL: Test_command_do/errors_if_Pilot_is_unreachable (0.23s)
        command_test.go:146: Expected an error but received none
FAIL
FAIL	istio.io/istio/pilot/pkg/request	0.415s
?   	istio.io/istio/pilot/pkg/security/authn	[no test files]
?   	istio.io/istio/pilot/pkg/security/authn/factory	[no test files]
ok  	istio.io/istio/pilot/pkg/security/authn/utils	(cached)
ok  	istio.io/istio/pilot/pkg/security/authn/v1alpha1	(cached)
2020-03-03T12:17:22.165143Z	info	Successfully serving on http://localhost:45875
--- FAIL: TestJwtFilter (0.67s)
    --- FAIL: TestJwtFilter/JWT_policy_with_bad_Jwks_URI (0.35s)
        policy_applier_test.go:615: got:
            (*envoy_config_filter_network_http_connection_manager_v2.HttpFilter)(0xc00033a240)(name:"envoy.filters.http.jwt_authn" typed_config:<type_url:"type.googleapis.com/envoy.config.filter.http.jwt_authn.v2alpha.JwtAuthentication" value:"\n\376\002\n\torigins-0\022\360\002\n\026https://secret.foo.comJ\026https://secret.foo.com\"\275\002\032\272\002<html><head><meta http-equiv=\"refresh\" content=\"0;url=http://dnserrorassist.att.net/search/?q=http://site.not.exist%2F&bc=\"/></head><body><script type=\"text/javascript\">window.location=\"http://dnserrorassist.att.net/search/?q=\"+escape(window.location)+\"&r=\"+escape(document.referrer)+\"&bc=\";</script></body></html>\022\032\n\003\n\001/\022\023\032\021\n\013\n\torigins-0\n\0022\000" > )
            
            wanted:
            (*envoy_config_filter_network_http_connection_manager_v2.HttpFilter)(0xc0003e3ec0)(name:"envoy.filters.http.jwt_authn" typed_config:<type_url:"type.googleapis.com/envoy.config.filter.http.jwt_authn.v2alpha.JwtAuthentication" value:"\nA\n\torigins-0\0224\n\026https://secret.foo.comJ\026https://secret.foo.com\"\002\032\000\022\032\n\003\n\001/\022\023\032\021\n\013\n\torigins-0\n\0022\000" > )
2020-03-03T12:17:22.825245Z	info	Successfully serving on http://localhost:39375
2020-03-03T12:17:22.830470Z	error	model	Failed to fetch public key from "": Get : unsupported protocol scheme ""
2020-03-03T12:17:22.830593Z	error	Failed to fetch jwt public key from "": Get : unsupported protocol scheme ""
--- FAIL: TestConvertToEnvoyJwtConfig (0.31s)
    --- FAIL: TestConvertToEnvoyJwtConfig/Unreachable_Jwks_URI (0.00s)
        policy_applier_test.go:911: got:
            (*envoy_config_filter_http_jwt_authn_v2alpha.JwtAuthentication)(0xc0002ff040)(providers:<key:"origins-0" value:<issuer:"https://secret.foo.com" local_jwks:<inline_string:"<html><head><meta http-equiv=\"refresh\" content=\"0;url=http://dnserrorassist.att.net/search/?q=http://site.not.exist%2F&bc=\"/></head><body><script type=\"text/javascript\">window.location=\"http://dnserrorassist.att.net/search/?q=\"+escape(window.location)+\"&r=\"+escape(document.referrer)+\"&bc=\";</script></body></html>" > payload_in_metadata:"https://secret.foo.com" > > rules:<match:<prefix:"/" > requires:<requires_any:<requirements:<provider_name:"origins-0" > requirements:<allow_missing:<> > > > > )
            
            wanted:
            (*envoy_config_filter_http_jwt_authn_v2alpha.JwtAuthentication)(0xc00023e190)(providers:<key:"origins-0" value:<issuer:"https://secret.foo.com" local_jwks:<inline_string:"" > payload_in_metadata:"https://secret.foo.com" > > rules:<match:<prefix:"/" > requires:<requires_any:<requirements:<provider_name:"origins-0" > requirements:<allow_missing:<> > > > > )
            
2020-03-03T12:17:23.136630Z	info	Successfully serving on http://localhost:39101
FAIL
FAIL	istio.io/istio/pilot/pkg/security/authn/v1beta1	1.428s
ok  	istio.io/istio/pilot/pkg/security/authz/builder	(cached)
?   	istio.io/istio/pilot/pkg/security/authz/converter	[no test files]
ok  	istio.io/istio/pilot/pkg/security/authz/model	(cached)
ok  	istio.io/istio/pilot/pkg/security/authz/model/matcher	(cached)
?   	istio.io/istio/pilot/pkg/security/authz/policy	[no test files]
ok  	istio.io/istio/pilot/pkg/security/authz/policy/v1alpha1	(cached)
ok  	istio.io/istio/pilot/pkg/security/authz/policy/v1beta1	(cached)
ok  	istio.io/istio/pilot/pkg/security/model	(cached)
ok  	istio.io/istio/pilot/pkg/security/trustdomain	(cached)
?   	istio.io/istio/pilot/pkg/serviceregistry	[no test files]
ok  	istio.io/istio/pilot/pkg/serviceregistry/aggregate	(cached)
ok  	istio.io/istio/pilot/pkg/serviceregistry/consul	(cached)
ok  	istio.io/istio/pilot/pkg/serviceregistry/external	(cached)
ok  	istio.io/istio/pilot/pkg/serviceregistry/kube	(cached)
ok  	istio.io/istio/pilot/pkg/serviceregistry/kube/controller	(cached)
ok  	istio.io/istio/pilot/pkg/serviceregistry/mcp	(cached)
ok  	istio.io/istio/pilot/pkg/serviceregistry/mock	(cached)
ok  	istio.io/istio/pilot/pkg/util/runtime	(cached)
ok  	istio.io/istio/pilot/pkg/util/sets	(cached)
?   	istio.io/istio/pilot/test/mock	[no test files]
?   	istio.io/istio/pilot/test/util	[no test files]
?   	istio.io/istio/pilot/tools/debug	[no test files]
FAIL
Makefile.core.mk:513: recipe for target 'pilot-racetest' failed
make[1]: *** [pilot-racetest] Error 1
make[1]: Target 'pilot-test' not remade because of errors.
go test  -race ./mixer/...
?   	istio.io/istio/mixer/adapter	[no test files]
ok  	istio.io/istio/mixer/adapter/bypass	(cached)
?   	istio.io/istio/mixer/adapter/bypass/config	[no test files]
ok  	istio.io/istio/mixer/adapter/circonus	(cached)
?   	istio.io/istio/mixer/adapter/circonus/config	[no test files]
ok  	istio.io/istio/mixer/adapter/cloudwatch	(cached)
?   	istio.io/istio/mixer/adapter/cloudwatch/config	[no test files]
ok  	istio.io/istio/mixer/adapter/denier	(cached)
?   	istio.io/istio/mixer/adapter/denier/config	[no test files]
ok  	istio.io/istio/mixer/adapter/dogstatsd	(cached)
?   	istio.io/istio/mixer/adapter/dogstatsd/config	[no test files]
ok  	istio.io/istio/mixer/adapter/fluentd	(cached)
?   	istio.io/istio/mixer/adapter/fluentd/config	[no test files]
ok  	istio.io/istio/mixer/adapter/kubernetesenv	(cached)
?   	istio.io/istio/mixer/adapter/kubernetesenv/config	[no test files]
?   	istio.io/istio/mixer/adapter/kubernetesenv/template	[no test files]
ok  	istio.io/istio/mixer/adapter/list	(cached)
?   	istio.io/istio/mixer/adapter/list/config	[no test files]
ok  	istio.io/istio/mixer/adapter/memquota	(cached)
?   	istio.io/istio/mixer/adapter/memquota/config	[no test files]
?   	istio.io/istio/mixer/adapter/metadata	[no test files]
ok  	istio.io/istio/mixer/adapter/noop	(cached)
ok  	istio.io/istio/mixer/adapter/opa	(cached)
?   	istio.io/istio/mixer/adapter/opa/config	[no test files]
ok  	istio.io/istio/mixer/adapter/prometheus	(cached)
?   	istio.io/istio/mixer/adapter/prometheus/config	[no test files]
ok  	istio.io/istio/mixer/adapter/redisquota	(cached)
?   	istio.io/istio/mixer/adapter/redisquota/config	[no test files]
ok  	istio.io/istio/mixer/adapter/solarwinds	(cached)
?   	istio.io/istio/mixer/adapter/solarwinds/config	[no test files]
ok  	istio.io/istio/mixer/adapter/solarwinds/internal/appoptics	(cached)
ok  	istio.io/istio/mixer/adapter/solarwinds/internal/papertrail	(cached)
ok  	istio.io/istio/mixer/adapter/stackdriver	(cached)
?   	istio.io/istio/mixer/adapter/stackdriver/config	[no test files]
ok  	istio.io/istio/mixer/adapter/stackdriver/contextgraph	(cached)
ok  	istio.io/istio/mixer/adapter/stackdriver/helper	(cached)
ok  	istio.io/istio/mixer/adapter/stackdriver/internal/cloud.google.com/go/contextgraph/apiv1alpha1	(cached)
?   	istio.io/istio/mixer/adapter/stackdriver/internal/cloud.google.com/go/internal/version	[no test files]
?   	istio.io/istio/mixer/adapter/stackdriver/internal/google.golang.org/genproto/googleapis/cloud/contextgraph/v1alpha1	[no test files]
?   	istio.io/istio/mixer/adapter/stackdriver/internal/google.golang.org/genproto/googleapis/graphservice/v0	[no test files]
ok  	istio.io/istio/mixer/adapter/stackdriver/log	(cached)
ok  	istio.io/istio/mixer/adapter/stackdriver/metric	(cached)
ok  	istio.io/istio/mixer/adapter/stackdriver/trace	(cached)
ok  	istio.io/istio/mixer/adapter/statsd	(cached)
?   	istio.io/istio/mixer/adapter/statsd/config	[no test files]
ok  	istio.io/istio/mixer/adapter/stdio	(cached)
?   	istio.io/istio/mixer/adapter/stdio/config	[no test files]
ok  	istio.io/istio/mixer/adapter/zipkin	(cached)
?   	istio.io/istio/mixer/adapter/zipkin/config	[no test files]
?   	istio.io/istio/mixer/cmd/mixc	[no test files]
ok  	istio.io/istio/mixer/cmd/mixc/cmd	(cached)
?   	istio.io/istio/mixer/cmd/mixs	[no test files]
?   	istio.io/istio/mixer/cmd/mixs/cmd	[no test files]
?   	istio.io/istio/mixer/cmd/shared	[no test files]
ok  	istio.io/istio/mixer/pkg/adapter	(cached)
ok  	istio.io/istio/mixer/pkg/adapter/opencensus	(cached)
?   	istio.io/istio/mixer/pkg/adapter/test	[no test files]
ok  	istio.io/istio/mixer/pkg/api	(cached)
ok  	istio.io/istio/mixer/pkg/attribute	(cached)
ok  	istio.io/istio/mixer/pkg/checkcache	(cached)
ok  	istio.io/istio/mixer/pkg/config	(cached)
ok  	istio.io/istio/mixer/pkg/config/crd	(cached)
ok  	istio.io/istio/mixer/pkg/config/mcp	(cached)
ok  	istio.io/istio/mixer/pkg/config/store	(cached)
ok  	istio.io/istio/mixer/pkg/config/storetest	(cached)
ok  	istio.io/istio/mixer/pkg/il	(cached)
ok  	istio.io/istio/mixer/pkg/il/interpreter	(cached)
?   	istio.io/istio/mixer/pkg/il/testing	[no test files]
ok  	istio.io/istio/mixer/pkg/il/text	(cached)
ok  	istio.io/istio/mixer/pkg/lang	(cached)
ok  	istio.io/istio/mixer/pkg/lang/ast	(cached)
ok  	istio.io/istio/mixer/pkg/lang/cel	(cached)
ok  	istio.io/istio/mixer/pkg/lang/checker	(cached)
ok  	istio.io/istio/mixer/pkg/lang/compiled	(cached)
ok  	istio.io/istio/mixer/pkg/lang/compiler	(cached)
ok  	istio.io/istio/mixer/pkg/loadshedding	(cached)
ok  	istio.io/istio/mixer/pkg/mockapi	(cached)
ok  	istio.io/istio/mixer/pkg/perf	(cached)
ok  	istio.io/istio/mixer/pkg/protobuf/descriptor	(cached)
ok  	istio.io/istio/mixer/pkg/protobuf/yaml	(cached)
ok  	istio.io/istio/mixer/pkg/protobuf/yaml/dynamic	(cached)
ok  	istio.io/istio/mixer/pkg/protobuf/yaml/wire	(cached)
ok  	istio.io/istio/mixer/pkg/runtime	(cached)
ok  	istio.io/istio/mixer/pkg/runtime/config	(cached)
?   	istio.io/istio/mixer/pkg/runtime/config/constant	[no test files]
ok  	istio.io/istio/mixer/pkg/runtime/dispatcher	(cached)
ok  	istio.io/istio/mixer/pkg/runtime/handler	(cached)
ok  	istio.io/istio/mixer/pkg/runtime/lang	(cached)
?   	istio.io/istio/mixer/pkg/runtime/monitoring	[no test files]
ok  	istio.io/istio/mixer/pkg/runtime/routing	(cached)
ok  	istio.io/istio/mixer/pkg/runtime/safecall	(cached)
ok  	istio.io/istio/mixer/pkg/runtime/testing/data	(cached)
ok  	istio.io/istio/mixer/pkg/server	(cached)
ok  	istio.io/istio/mixer/pkg/status	(cached)
ok  	istio.io/istio/mixer/pkg/template	(cached)
ok  	istio.io/istio/mixer/pkg/validate	(cached)
?   	istio.io/istio/mixer/template	[no test files]
?   	istio.io/istio/mixer/template/apikey	[no test files]
?   	istio.io/istio/mixer/template/authorization	[no test files]
?   	istio.io/istio/mixer/template/checknothing	[no test files]
?   	istio.io/istio/mixer/template/edge	[no test files]
?   	istio.io/istio/mixer/template/listentry	[no test files]
?   	istio.io/istio/mixer/template/logentry	[no test files]
?   	istio.io/istio/mixer/template/metric	[no test files]
?   	istio.io/istio/mixer/template/quota	[no test files]
?   	istio.io/istio/mixer/template/reportnothing	[no test files]
ok  	istio.io/istio/mixer/template/sample	(cached)
?   	istio.io/istio/mixer/template/sample/apa	[no test files]
?   	istio.io/istio/mixer/template/sample/check	[no test files]
?   	istio.io/istio/mixer/template/sample/quota	[no test files]
?   	istio.io/istio/mixer/template/sample/report	[no test files]
?   	istio.io/istio/mixer/template/tracespan	[no test files]
ok  	istio.io/istio/mixer/test/client/check_cache	(cached)
ok  	istio.io/istio/mixer/test/client/check_cache_hit	(cached)
ok  	istio.io/istio/mixer/test/client/check_report	(cached)
ok  	istio.io/istio/mixer/test/client/check_report_disable	(cached)
ok  	istio.io/istio/mixer/test/client/check_report_large_post_request	(cached)
ok  	istio.io/istio/mixer/test/client/disable_check_cache	(cached)
ok  	istio.io/istio/mixer/test/client/disable_tcp_check_calls	(cached)
ok  	istio.io/istio/mixer/test/client/dynamic_attribute	(cached)
ok  	istio.io/istio/mixer/test/client/dynamic_listener	(cached)
?   	istio.io/istio/mixer/test/client/env	[no test files]
ok  	istio.io/istio/mixer/test/client/failed_request	(cached)
ok  	istio.io/istio/mixer/test/client/fault_inject	(cached)
ok  	istio.io/istio/mixer/test/client/gateway	(cached)
ok  	istio.io/istio/mixer/test/client/global_dictionary	(cached)
ok  	istio.io/istio/mixer/test/client/istio_authn_origin_jwt_bound_origin	(cached)
ok  	istio.io/istio/mixer/test/client/istio_authn_origin_jwt_bound_peer	(cached)
ok  	istio.io/istio/mixer/test/client/istio_authn_origin_reject_no_jwt	(cached)
ok  	istio.io/istio/mixer/test/client/istio_authn_peer_jwt_bound_origin	(cached)
ok  	istio.io/istio/mixer/test/client/istio_authn_peer_jwt_bound_peer	(cached)
ok  	istio.io/istio/mixer/test/client/istio_authn_peer_reject_no_jwt	(cached)
ok  	istio.io/istio/mixer/test/client/istio_authn_peer_reject_no_mtls	(cached)
ok  	istio.io/istio/mixer/test/client/istio_authn_peer_reject_no_tls	(cached)
ok  	istio.io/istio/mixer/test/client/mixer_internal_fail	(cached)
ok  	istio.io/istio/mixer/test/client/network_policy	(cached)
ok  	istio.io/istio/mixer/test/client/pilotplugin	(cached)
ok  	istio.io/istio/mixer/test/client/pilotplugin_mtls	(cached)
ok  	istio.io/istio/mixer/test/client/pilotplugin_tcp	(cached)
ok  	istio.io/istio/mixer/test/client/quota	(cached)
ok  	istio.io/istio/mixer/test/client/quota_cache	(cached)
ok  	istio.io/istio/mixer/test/client/rbac_permissive_global	(cached)
ok  	istio.io/istio/mixer/test/client/rbac_permissive_policy	(cached)
ok  	istio.io/istio/mixer/test/client/report_batch	(cached)
ok  	istio.io/istio/mixer/test/client/route_directive	(cached)
ok  	istio.io/istio/mixer/test/client/tcp_filter	(cached)
ok  	istio.io/istio/mixer/test/client/tcp_filter_periodical_report	(cached)
?   	istio.io/istio/mixer/test/client/test_data	[no test files]
ok  	istio.io/istio/mixer/test/client/tracing_header	(cached)
ok  	istio.io/istio/mixer/test/e2e	(cached)
?   	istio.io/istio/mixer/test/keyval	[no test files]
?   	istio.io/istio/mixer/test/keyval/main	[no test files]
ok  	istio.io/istio/mixer/test/listbackend	(cached)
?   	istio.io/istio/mixer/test/listbackend/cmd	[no test files]
ok  	istio.io/istio/mixer/test/perf	(cached) [no tests to run]
?   	istio.io/istio/mixer/test/perf/perfclient	[no test files]
?   	istio.io/istio/mixer/test/policybackend	[no test files]
ok  	istio.io/istio/mixer/test/prometheus	(cached)
?   	istio.io/istio/mixer/test/prometheus/cmd	[no test files]
?   	istio.io/istio/mixer/test/spyAdapter	[no test files]
?   	istio.io/istio/mixer/test/spyAdapter/template	[no test files]
?   	istio.io/istio/mixer/test/spyAdapter/template/apa	[no test files]
?   	istio.io/istio/mixer/test/spyAdapter/template/check	[no test files]
?   	istio.io/istio/mixer/test/spyAdapter/template/checkoutput	[no test files]
?   	istio.io/istio/mixer/test/spyAdapter/template/quota	[no test files]
?   	istio.io/istio/mixer/test/spyAdapter/template/report	[no test files]
ok  	istio.io/istio/mixer/test/spybackend	(cached)
ok  	istio.io/istio/mixer/tools/adapterlinter	(cached)
?   	istio.io/istio/mixer/tools/codegen/cmd/mixgenbootstrap	[no test files]
?   	istio.io/istio/mixer/tools/codegen/cmd/mixgeninventory	[no test files]
ok  	istio.io/istio/mixer/tools/codegen/pkg/bootstrapgen	(cached)
?   	istio.io/istio/mixer/tools/codegen/pkg/bootstrapgen/template	[no test files]
ok  	istio.io/istio/mixer/tools/codegen/pkg/inventory	(cached)
ok  	istio.io/istio/mixer/tools/codegen/pkg/modelgen	(cached)
?   	istio.io/istio/mixer/tools/mixgen	[no test files]
ok  	istio.io/istio/mixer/tools/mixgen/cmd	(cached)
go test  -race ./security/pkg/... ./security/cmd/...
?   	istio.io/istio/security/pkg/adapter/vault	[no test files]
ok  	istio.io/istio/security/pkg/caclient	(cached)
ok  	istio.io/istio/security/pkg/caclient/protocol	(cached)
?   	istio.io/istio/security/pkg/caclient/protocol/mock	[no test files]
ok  	istio.io/istio/security/pkg/cmd	(cached)
?   	istio.io/istio/security/pkg/credential	[no test files]
ok  	istio.io/istio/security/pkg/k8s/chiron	(cached)
ok  	istio.io/istio/security/pkg/k8s/configmap	(cached)
ok  	istio.io/istio/security/pkg/k8s/controller	(cached)
ok  	istio.io/istio/security/pkg/k8s/secret	(cached)
ok  	istio.io/istio/security/pkg/k8s/tokenreview	(cached)
ok  	istio.io/istio/security/pkg/listwatch	(cached)
ok  	istio.io/istio/security/pkg/nodeagent/cache	(cached)
?   	istio.io/istio/security/pkg/nodeagent/cache/mock	[no test files]
ok  	istio.io/istio/security/pkg/nodeagent/caclient	(cached)
?   	istio.io/istio/security/pkg/nodeagent/caclient/interface	[no test files]
ok  	istio.io/istio/security/pkg/nodeagent/caclient/providers/citadel	(cached)
ok  	istio.io/istio/security/pkg/nodeagent/caclient/providers/google	(cached)
?   	istio.io/istio/security/pkg/nodeagent/caclient/providers/google/mock	[no test files]
ok  	istio.io/istio/security/pkg/nodeagent/caclient/providers/vault	(cached)
?   	istio.io/istio/security/pkg/nodeagent/model	[no test files]
?   	istio.io/istio/security/pkg/nodeagent/plugin	[no test files]
ok  	istio.io/istio/security/pkg/nodeagent/plugin/providers/google/stsclient	(cached)
ok  	istio.io/istio/security/pkg/nodeagent/sds	(cached)
ok  	istio.io/istio/security/pkg/nodeagent/secretfetcher	(cached)
?   	istio.io/istio/security/pkg/nodeagent/util	[no test files]
ok  	istio.io/istio/security/pkg/nodeagent/vm	(cached)
ok  	istio.io/istio/security/pkg/pki/ca	(cached)
?   	istio.io/istio/security/pkg/pki/ca/mock	[no test files]
ok  	istio.io/istio/security/pkg/pki/error	(cached)
ok  	istio.io/istio/security/pkg/pki/util	(cached)
?   	istio.io/istio/security/pkg/pki/util/mock	[no test files]
ok  	istio.io/istio/security/pkg/platform	(cached)
?   	istio.io/istio/security/pkg/platform/mock	[no test files]
ok  	istio.io/istio/security/pkg/probe	(cached)
ok  	istio.io/istio/security/pkg/registry	(cached)
ok  	istio.io/istio/security/pkg/registry/kube	(cached)
ok  	istio.io/istio/security/pkg/server/ca	(cached)
ok  	istio.io/istio/security/pkg/server/ca/authenticate	(cached)
?   	istio.io/istio/security/pkg/server/monitoring	[no test files]
?   	istio.io/istio/security/pkg/stsservice	[no test files]
?   	istio.io/istio/security/pkg/stsservice/mock	[no test files]
ok  	istio.io/istio/security/pkg/stsservice/server	(cached)
?   	istio.io/istio/security/pkg/stsservice/test	[no test files]
ok  	istio.io/istio/security/pkg/stsservice/test/failure_sts_token_fetch	(cached)
ok  	istio.io/istio/security/pkg/stsservice/test/proxy_cached_sts_token	(cached)
ok  	istio.io/istio/security/pkg/stsservice/test/renew_sts_token	(cached)
ok  	istio.io/istio/security/pkg/stsservice/test/server_cached_short_lived_sts_token	(cached)
ok  	istio.io/istio/security/pkg/stsservice/test/server_cached_sts_token	(cached)
ok  	istio.io/istio/security/pkg/stsservice/test/sts_fetch_timeout	(cached)
ok  	istio.io/istio/security/pkg/stsservice/test/success_sts	(cached)
ok  	istio.io/istio/security/pkg/stsservice/tokenmanager	(cached)
ok  	istio.io/istio/security/pkg/stsservice/tokenmanager/google	(cached)
?   	istio.io/istio/security/pkg/stsservice/tokenmanager/google/mock	[no test files]
?   	istio.io/istio/security/pkg/testing/sdsc	[no test files]
ok  	istio.io/istio/security/pkg/util	(cached)
?   	istio.io/istio/security/pkg/util/mock	[no test files]
?   	istio.io/istio/security/cmd/chiron	[no test files]
ok  	istio.io/istio/security/cmd/istio_ca	(cached)
?   	istio.io/istio/security/cmd/node_agent	[no test files]
go test  -race ./galley/...
?   	istio.io/istio/galley/cmd/galley	[no test files]
ok  	istio.io/istio/galley/cmd/galley/cmd	(cached)
?   	istio.io/istio/galley/pkg/authplugin	[no test files]
ok  	istio.io/istio/galley/pkg/authplugins	(cached)
ok  	istio.io/istio/galley/pkg/authplugins/google	(cached)
ok  	istio.io/istio/galley/pkg/authplugins/none	(cached)
ok  	istio.io/istio/galley/pkg/config/analysis	(cached)
ok  	istio.io/istio/galley/pkg/config/analysis/analyzers	(cached)
?   	istio.io/istio/galley/pkg/config/analysis/analyzers/annotations	[no test files]
?   	istio.io/istio/galley/pkg/config/analysis/analyzers/auth	[no test files]
ok  	istio.io/istio/galley/pkg/config/analysis/analyzers/auth/mtls	(cached)
?   	istio.io/istio/galley/pkg/config/analysis/analyzers/deployment	[no test files]
?   	istio.io/istio/galley/pkg/config/analysis/analyzers/deprecation	[no test files]
?   	istio.io/istio/galley/pkg/config/analysis/analyzers/gateway	[no test files]
?   	istio.io/istio/galley/pkg/config/analysis/analyzers/injection	[no test files]
?   	istio.io/istio/galley/pkg/config/analysis/analyzers/policy	[no test files]
ok  	istio.io/istio/galley/pkg/config/analysis/analyzers/schema	(cached)
?   	istio.io/istio/galley/pkg/config/analysis/analyzers/service	[no test files]
?   	istio.io/istio/galley/pkg/config/analysis/analyzers/sidecar	[no test files]
ok  	istio.io/istio/galley/pkg/config/analysis/analyzers/util	(cached)
?   	istio.io/istio/galley/pkg/config/analysis/analyzers/virtualservice	[no test files]
ok  	istio.io/istio/galley/pkg/config/analysis/diag	(cached)
ok  	istio.io/istio/galley/pkg/config/analysis/local	(cached)
?   	istio.io/istio/galley/pkg/config/analysis/msg	[no test files]
?   	istio.io/istio/galley/pkg/config/analysis/testing/fixtures	[no test files]
ok  	istio.io/istio/galley/pkg/config/collection	(cached)
ok  	istio.io/istio/galley/pkg/config/meshcfg	(cached)
?   	istio.io/istio/galley/pkg/config/monitoring	[no test files]
ok  	istio.io/istio/galley/pkg/config/processing	(cached)
ok  	istio.io/istio/galley/pkg/config/processing/snapshotter	(cached)
ok  	istio.io/istio/galley/pkg/config/processing/snapshotter/strategy	(cached)
ok  	istio.io/istio/galley/pkg/config/processing/transformer	(cached)
ok  	istio.io/istio/galley/pkg/config/processor	(cached)
ok  	istio.io/istio/galley/pkg/config/processor/groups	(cached)
?   	istio.io/istio/galley/pkg/config/processor/transforms	[no test files]
ok  	istio.io/istio/galley/pkg/config/processor/transforms/authpolicy	(cached)
ok  	istio.io/istio/galley/pkg/config/processor/transforms/direct	(cached)
ok  	istio.io/istio/galley/pkg/config/processor/transforms/ingress	(cached)
?   	istio.io/istio/galley/pkg/config/scope	[no test files]
ok  	istio.io/istio/galley/pkg/config/source/inmemory	(cached)
ok  	istio.io/istio/galley/pkg/config/source/kube	(cached)
ok  	istio.io/istio/galley/pkg/config/source/kube/apiserver	(cached)
?   	istio.io/istio/galley/pkg/config/source/kube/apiserver/stats	[no test files]
ok  	istio.io/istio/galley/pkg/config/source/kube/apiserver/status	(cached)
ok  	istio.io/istio/galley/pkg/config/source/kube/apiserver/tombstone	(cached)
ok  	istio.io/istio/galley/pkg/config/source/kube/fs	(cached)
ok  	istio.io/istio/galley/pkg/config/source/kube/inmemory	(cached)
ok  	istio.io/istio/galley/pkg/config/source/kube/rt	(cached)
ok  	istio.io/istio/galley/pkg/config/source/mcp	(cached)
ok  	istio.io/istio/galley/pkg/config/synthesize	(cached)
?   	istio.io/istio/galley/pkg/config/testing/basicmeta	[no test files]
?   	istio.io/istio/galley/pkg/config/testing/data	[no test files]
ok  	istio.io/istio/galley/pkg/config/testing/fixtures	(cached)
?   	istio.io/istio/galley/pkg/config/testing/k8smeta	[no test files]
?   	istio.io/istio/galley/pkg/config/util/kuberesource	[no test files]
ok  	istio.io/istio/galley/pkg/config/util/kubeyaml	(cached)
ok  	istio.io/istio/galley/pkg/config/util/pb	(cached)
?   	istio.io/istio/galley/pkg/envvar	[no test files]
ok  	istio.io/istio/galley/pkg/meshconfig	(cached)
ok  	istio.io/istio/galley/pkg/server	(cached)
ok  	istio.io/istio/galley/pkg/server/components	(cached)
ok  	istio.io/istio/galley/pkg/server/process	(cached)
ok  	istio.io/istio/galley/pkg/server/settings	(cached)
?   	istio.io/istio/galley/pkg/testing/mock	[no test files]
?   	istio.io/istio/galley/testdatasets/conversion	[no test files]
?   	istio.io/istio/galley/testdatasets/validation	[no test files]
?   	istio.io/istio/galley/tools/mcpc	[no test files]
go test  -race ./istioctl/...
ok  	istio.io/istio/istioctl/cmd	(cached)
ok  	istio.io/istio/istioctl/cmd/istioctl	(cached)
?   	istio.io/istio/istioctl/pkg/authz	[no test files]
?   	istio.io/istio/istioctl/pkg/convert	[no test files]
ok  	istio.io/istio/istioctl/pkg/install	(cached)
?   	istio.io/istio/istioctl/pkg/kubernetes	[no test files]
ok  	istio.io/istio/istioctl/pkg/multicluster	(cached)
?   	istio.io/istio/istioctl/pkg/util/clusters	[no test files]
ok  	istio.io/istio/istioctl/pkg/util/configdump	(cached)
ok  	istio.io/istio/istioctl/pkg/util/handlers	(cached)
?   	istio.io/istio/istioctl/pkg/util/proto	[no test files]
ok  	istio.io/istio/istioctl/pkg/validate	(cached)
ok  	istio.io/istio/istioctl/pkg/writer/compare	(cached)
ok  	istio.io/istio/istioctl/pkg/writer/compare/sds	(cached)
ok  	istio.io/istio/istioctl/pkg/writer/envoy/clusters	(cached)
ok  	istio.io/istio/istioctl/pkg/writer/envoy/configdump	(cached)
ok  	istio.io/istio/istioctl/pkg/writer/pilot	(cached)
go test  ./operator/...
?   	istio.io/istio/operator/cmd	[no test files]
proto: tag has too few fields: "-"
2020-03-03T12:19:53.723241Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:19:53.723299Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:19:53.723321Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:19:53.723341Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:19:53.822137Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:19:53.822247Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:19:55.487858Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:19:55.487978Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:19:55.488046Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:19:55.488105Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:19:55.658785Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:19:55.658853Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:19:55.658872Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:19:55.658891Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:19:55.902035Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:19:55.902072Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:19:56.163216Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:19:56.163268Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:19:57.284833Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:19:57.284888Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:19:58.324467Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:19:58.325144Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:19:58.748393Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:19:58.748498Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:19:58.748654Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:19:58.748673Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:19:59.018559Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:19:59.018616Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:19:59.018636Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:19:59.018653Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:19:59.144070Z	info	installer	Component dependencies tree: 
Base
  Pilot

Component dependencies tree: 
Base
  Pilot

2020-03-03T12:19:59.144262Z	info	installer	Rendering manifests to output dir /tmp/flag-output663551298
Rendering manifests to output dir /tmp/flag-output663551298
2020-03-03T12:19:59.144411Z	info	installer	Rendering: Base
Rendering: Base
2020-03-03T12:19:59.144621Z	info	installer	Writing manifest to /tmp/flag-output663551298/Base/Base.yaml
Writing manifest to /tmp/flag-output663551298/Base/Base.yaml
2020-03-03T12:19:59.144807Z	info	installer	Rendering: Pilot
Rendering: Pilot
2020-03-03T12:19:59.144913Z	info	installer	Writing manifest to /tmp/flag-output663551298/Base/Pilot/Pilot.yaml
Writing manifest to /tmp/flag-output663551298/Base/Pilot/Pilot.yaml
2020-03-03T12:19:59.145091Z	info	installer	Rendering: EgressGateways
Rendering: EgressGateways
2020-03-03T12:19:59.145203Z	info	installer	Writing manifest to /tmp/flag-output663551298/Base/Pilot/EgressGateways/EgressGateways.yaml
Writing manifest to /tmp/flag-output663551298/Base/Pilot/EgressGateways/EgressGateways.yaml
2020-03-03T12:19:59.145341Z	info	installer	Rendering: AddonComponents
Rendering: AddonComponents
2020-03-03T12:19:59.145447Z	info	installer	Writing manifest to /tmp/flag-output663551298/Base/Pilot/AddonComponents/AddonComponents.yaml
Writing manifest to /tmp/flag-output663551298/Base/Pilot/AddonComponents/AddonComponents.yaml
2020-03-03T12:19:59.145644Z	info	installer	Rendering: Policy
Rendering: Policy
2020-03-03T12:19:59.145755Z	info	installer	Writing manifest to /tmp/flag-output663551298/Base/Pilot/Policy/Policy.yaml
Writing manifest to /tmp/flag-output663551298/Base/Pilot/Policy/Policy.yaml
2020-03-03T12:19:59.145858Z	info	installer	Rendering: Telemetry
Rendering: Telemetry
2020-03-03T12:19:59.145976Z	info	installer	Writing manifest to /tmp/flag-output663551298/Base/Pilot/Telemetry/Telemetry.yaml
Writing manifest to /tmp/flag-output663551298/Base/Pilot/Telemetry/Telemetry.yaml
2020-03-03T12:19:59.146072Z	info	installer	Rendering: Galley
Rendering: Galley
2020-03-03T12:19:59.146181Z	info	installer	Writing manifest to /tmp/flag-output663551298/Base/Pilot/Galley/Galley.yaml
Writing manifest to /tmp/flag-output663551298/Base/Pilot/Galley/Galley.yaml
2020-03-03T12:19:59.146286Z	info	installer	Rendering: Citadel
Rendering: Citadel
2020-03-03T12:19:59.146390Z	info	installer	Writing manifest to /tmp/flag-output663551298/Base/Pilot/Citadel/Citadel.yaml
Writing manifest to /tmp/flag-output663551298/Base/Pilot/Citadel/Citadel.yaml
2020-03-03T12:19:59.146492Z	info	installer	Rendering: Cni
Rendering: Cni
2020-03-03T12:19:59.146656Z	info	installer	Writing manifest to /tmp/flag-output663551298/Base/Pilot/Cni/Cni.yaml
Writing manifest to /tmp/flag-output663551298/Base/Pilot/Cni/Cni.yaml
2020-03-03T12:19:59.146800Z	info	installer	Rendering: IngressGateways
Rendering: IngressGateways
2020-03-03T12:19:59.146908Z	info	installer	Writing manifest to /tmp/flag-output663551298/Base/Pilot/IngressGateways/IngressGateways.yaml
Writing manifest to /tmp/flag-output663551298/Base/Pilot/IngressGateways/IngressGateways.yaml
2020-03-03T12:19:59.300401Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:19:59.300458Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:19:59.587092Z	info	installer	Component dependencies tree: 
Base
  Pilot

Component dependencies tree: 
Base
  Pilot

2020-03-03T12:19:59.587151Z	info	installer	Rendering manifests to output dir /tmp/flag-output-values653401017
Rendering manifests to output dir /tmp/flag-output-values653401017
2020-03-03T12:19:59.587170Z	info	installer	Rendering: Base
Rendering: Base
2020-03-03T12:19:59.587348Z	info	installer	Writing manifest to /tmp/flag-output-values653401017/Base/Base.yaml
Writing manifest to /tmp/flag-output-values653401017/Base/Base.yaml
2020-03-03T12:19:59.587882Z	info	installer	Rendering: Pilot
Rendering: Pilot
2020-03-03T12:19:59.587996Z	info	installer	Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/Pilot.yaml
Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/Pilot.yaml
2020-03-03T12:19:59.588269Z	info	installer	Rendering: AddonComponents
Rendering: AddonComponents
2020-03-03T12:19:59.588361Z	info	installer	Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/AddonComponents/AddonComponents.yaml
Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/AddonComponents/AddonComponents.yaml
2020-03-03T12:19:59.588487Z	info	installer	Rendering: Policy
Rendering: Policy
2020-03-03T12:19:59.588684Z	info	installer	Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/Policy/Policy.yaml
Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/Policy/Policy.yaml
2020-03-03T12:19:59.588808Z	info	installer	Rendering: Telemetry
Rendering: Telemetry
2020-03-03T12:19:59.588947Z	info	installer	Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/Telemetry/Telemetry.yaml
Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/Telemetry/Telemetry.yaml
2020-03-03T12:19:59.589083Z	info	installer	Rendering: Galley
Rendering: Galley
2020-03-03T12:19:59.589221Z	info	installer	Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/Galley/Galley.yaml
Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/Galley/Galley.yaml
2020-03-03T12:19:59.589342Z	info	installer	Rendering: Citadel
Rendering: Citadel
2020-03-03T12:19:59.589471Z	info	installer	Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/Citadel/Citadel.yaml
Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/Citadel/Citadel.yaml
2020-03-03T12:19:59.589634Z	info	installer	Rendering: Cni
Rendering: Cni
2020-03-03T12:19:59.589764Z	info	installer	Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/Cni/Cni.yaml
Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/Cni/Cni.yaml
2020-03-03T12:19:59.589985Z	info	installer	Rendering: IngressGateways
Rendering: IngressGateways
2020-03-03T12:19:59.590120Z	info	installer	Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/IngressGateways/IngressGateways.yaml
Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/IngressGateways/IngressGateways.yaml
2020-03-03T12:19:59.590211Z	info	installer	Rendering: EgressGateways
Rendering: EgressGateways
2020-03-03T12:19:59.590344Z	info	installer	Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/EgressGateways/EgressGateways.yaml
Writing manifest to /tmp/flag-output-values653401017/Base/Pilot/EgressGateways/EgressGateways.yaml
2020-03-03T12:20:00.371396Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:20:00.371452Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:20:00.371471Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:00.371485Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:00.494960Z	error	Failed to parse YAML to a k8s object: error decoding object: error converting YAML to JSON: yaml: line 3: could not find expected ':'
2020-03-03T12:20:00.510215Z	error	Failed to parse YAML to a k8s object: error decoding object: error converting YAML to JSON: yaml: line 3: could not find expected ':'
2020-03-03T12:20:00.545660Z	error	Failed to parse YAML to a k8s object: error decoding object: error converting YAML to JSON: yaml: line 3: could not find expected ':'
2020-03-03T12:20:00.557228Z	error	Failed to parse YAML to a k8s object: error decoding object: error converting YAML to JSON: yaml: line 3: could not find expected ':'
2020-03-03T12:20:00.608439Z	info	installer	ReadProfileYAML for profile name: minimal
2020-03-03T12:20:00.608501Z	info	installer	Loading values from compiled in VFS at path profiles/minimal.yaml
2020-03-03T12:20:00.608524Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:00.608539Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:01.518864Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:20:01.518920Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:20:01.518940Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:01.518959Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:01.782274Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:20:01.782331Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:20:01.782353Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:01.782368Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:02.062230Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:20:02.062265Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:20:02.062286Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:02.062305Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:02.248334Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:20:02.248390Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:20:02.248410Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:02.248428Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:02.384019Z	info	installer	Applying Kubernetes overlay: 
- kind: Deployment
  name: istiod
  patches:
  - path: spec.template.spec.containers.[name:discovery].args.[30m]
    value: 60m
  - path: spec.template.spec.containers.[name:discovery].ports.[containerPort:8080].containerPort
    value: 1234
- kind: Service
  name: istio-pilot
  patches:
  - path: spec.ports.[name:grpc-xds].port
    value: 11111


2020-03-03T12:20:02.401049Z	info	installer	Manifest after resources and overlay: 
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: istiod
    istio: pilot
    release: istio
  name: istiod
  namespace: istio-control
spec:
  selector:
    matchLabels:
      istio: pilot
  strategy:
    rollingUpdate:
      maxSurge: 100%
      maxUnavailable: 25%
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
      labels:
        app: istiod
        istio: pilot
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - preference:
              matchExpressions:
              - key: beta.kubernetes.io/arch
                operator: In
                values:
                - amd64
            weight: 2
          - preference:
              matchExpressions:
              - key: beta.kubernetes.io/arch
                operator: In
                values:
                - ppc64le
            weight: 2
          - preference:
              matchExpressions:
              - key: beta.kubernetes.io/arch
                operator: In
                values:
                - s390x
            weight: 2
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: beta.kubernetes.io/arch
                operator: In
                values:
                - amd64
                - ppc64le
                - s390x
      containers:
      - args:
        - discovery
        - --monitoringAddr=:15014
        - --log_output_level=default:info
        - --domain
        - cluster.local
        - --secureGrpcAddr=:15011
        - --trust-domain=cluster.local
        - --keepaliveMaxServerConnectionAge
        - 60m
        - --disable-install-crds=true
        env:
        - name: JWT_POLICY
          value: third-party-jwt
        - name: PILOT_CERT_PROVIDER
          value: istiod
        - name: POD_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: SERVICE_ACCOUNT
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.serviceAccountName
        - name: PILOT_TRACE_SAMPLING
          value: "1"
        - name: CONFIG_NAMESPACE
          value: istio-config
        - name: PILOT_ENABLE_PROTOCOL_SNIFFING_FOR_OUTBOUND
          value: "true"
        - name: PILOT_ENABLE_PROTOCOL_SNIFFING_FOR_INBOUND
          value: "false"
        - name: INJECTION_WEBHOOK_CONFIG_NAME
          value: istio-sidecar-injector
        - name: ISTIOD_ADDR
          value: istiod.istio-control.svc:15012
        - name: PILOT_EXTERNAL_GALLEY
          value: "false"
        envFrom:
        - configMapRef:
            name: istiod
            optional: true
        image: docker.io/istio/pilot:1.1.4
        name: discovery
        ports:
        - containerPort: 1234
        - containerPort: 15010
        - containerPort: 15017
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 5
        resources:
          requests:
            cpu: 123m
            memory: 2048Mi
        securityContext:
          capabilities:
            drop:
            - ALL
          runAsGroup: 1337
          runAsNonRoot: true
          runAsUser: 1337
        volumeMounts:
        - mountPath: /etc/istio/config
          name: config-volume
        - mountPath: /var/run/secrets/tokens
          name: istio-token
          readOnly: true
        - mountPath: /var/run/secrets/istio-dns
          name: local-certs
        - mountPath: /etc/cacerts
          name: cacerts
          readOnly: true
        - mountPath: /var/lib/istio/inject
          name: inject
          readOnly: true
        - mountPath: /var/lib/istio/local
          name: istiod
          readOnly: true
      securityContext:
        fsGroup: 1337
      serviceAccountName: istio-pilot-service-account
      volumes:
      - emptyDir:
          medium: Memory
        name: local-certs
      - name: istio-token
        projected:
          sources:
          - serviceAccountToken:
              audience: istio-ca
              expirationSeconds: 43200
              path: istio-token
      - configMap:
          name: istiod
          optional: true
        name: istiod
      - name: cacerts
        secret:
          optional: true
          secretName: cacerts
      - configMap:
          name: istio-sidecar-injector
          optional: true
        name: inject
      - configMap:
          name: istio
        name: config-volume

---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: pilot
    istio: pilot
    release: istio
  name: istio-pilot
  namespace: istio-control
spec:
  ports:
  - name: grpc-xds
    port: 11111
  - name: https-xds
    port: 15011
  - name: https-dns
    port: 15012
  - name: http-legacy-discovery
    port: 8080
  - name: http-monitoring
    port: 15014
  - name: https-webhook
    port: 443
    targetPort: 15017
  selector:
    istio: pilot

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: istio-galley-istio-control
  labels:
    release: istio
rules:
  # For reading Istio resources
  - apiGroups: [
    "authentication.istio.io",
    "config.istio.io",
    "networking.istio.io",
    "rbac.istio.io",
    "security.istio.io"]
    resources: ["*"]
    verbs: ["get", "list", "watch"]
    # For updating Istio resource statuses
  - apiGroups: [
    "authentication.istio.io",
    "config.istio.io",
    "networking.istio.io",
    "rbac.istio.io",
    "security.istio.io"]
    resources: ["*/status"]
    verbs: ["update"]

    # Remove galley's permissions to reconcile the validation config when istiod is present.
    # Notably missing here is the permission to modify webhooks.

  - apiGroups: ["extensions","apps"]
    resources: ["deployments"]
    resourceNames: ["istio-galley"]
    verbs: ["get"]
  - apiGroups: [""]
    resources: ["pods", "nodes", "services", "endpoints", "namespaces"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["extensions"]
    resources: ["ingresses"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["extensions"]
    resources: ["deployments/finalizers"]
    resourceNames: ["istio-galley"]
    verbs: ["update"]
  - apiGroups: ["apiextensions.k8s.io"]
    resources: ["customresourcedefinitions"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources: ["clusterroles"]
    verbs: ["get", "list", "watch"]
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: istio
  namespace: istio-control
  labels:
    release: istio
data:

  # Configuration file for the mesh networks to be used by the Split Horizon EDS.
  meshNetworks: |-
    networks: {}

  values.yaml: |-
    appNamespaces: []
    autoscaleEnabled: true
    autoscaleMax: 5
    autoscaleMin: 1
    configMap: true
    configNamespace: istio-config
    configSource:
      subscribedResources: []
    cpu:
      targetAverageUtilization: 80
    deploymentLabels: {}
    enableProtocolSniffingForInbound: false
    enableProtocolSniffingForOutbound: true
    enabled: true
    env: {}
    hub: ""
    image: pilot
    ingress:
      ingressClass: istio
      ingressControllerMode: STRICT
      ingressService: istio-ingressgateway
    jwksResolverExtraRootCA: ""
    keepaliveMaxServerConnectionAge: 30m
    meshNetworks:
      networks: {}
    namespace: istio-control
    nodeSelector: {}
    plugins: []
    podAnnotations: {}
    podAntiAffinityLabelSelector: []
    podAntiAffinityTermLabelSelector: []
    policy:
      enabled: false
    replicaCount: 1
    resources:
      requests:
        cpu: 500m
        memory: 2048Mi
    rollingMaxSurge: 100%
    rollingMaxUnavailable: 25%
    tag: ""
    tolerations: []
    traceSampling: 1

  mesh: |-
    # Set enableTracing to false to disable request tracing.
    enableTracing: true

    # Set accessLogFile to empty string to disable access log.
    accessLogFile: ""

    accessLogFormat: ""

    accessLogEncoding: 'TEXT'

    enableEnvoyAccessLogService: false
    # reportBatchMaxEntries is the number of requests that are batched before telemetry data is sent to the mixer server
    reportBatchMaxEntries: 100
    # reportBatchMaxTime is the max waiting time before the telemetry data of a request is sent to the mixer server
    reportBatchMaxTime: 1s
    disableMixerHttpReports: true

    # Set the following variable to true to disable policy checks by the Mixer.
    # Note that metrics will still be reported to the Mixer.
    disablePolicyChecks: true

    # Automatic protocol detection uses a set of heuristics to
    # determine whether the connection is using TLS or not (on the
    # server side), as well as the application protocol being used
    # (e.g., http vs tcp). These heuristics rely on the client sending
    # the first bits of data. For server first protocols like MySQL,
    # MongoDB, etc., Envoy will timeout on the protocol detection after
    # the specified period, defaulting to non mTLS plain TCP
    # traffic. Set this field to tweak the period that Envoy will wait
    # for the client to send the first bits of data. (MUST BE >=1ms)
    protocolDetectionTimeout: 100ms

    # This is the k8s ingress service name, update if you used a different name
    ingressService: "istio-ingressgateway"
    ingressControllerMode: "STRICT"
    ingressClass: "istio"

    # The trust domain corresponds to the trust root of a system.
    # Refer to https://github.com/spiffe/spiffe/blob/master/standards/SPIFFE-ID.md#21-trust-domain
    trustDomain: "cluster.local"

    #  The trust domain aliases represent the aliases of trust_domain.
    #  For example, if we have
    #  trustDomain: td1
    #  trustDomainAliases: [“td2”, "td3"]
    #  Any service with the identity "td1/ns/foo/sa/a-service-account", "td2/ns/foo/sa/a-service-account",
    #  or "td3/ns/foo/sa/a-service-account" will be treated the same in the Istio mesh.
    trustDomainAliases:

    # Used by pilot-agent
    sdsUdsPath: "unix:/etc/istio/proxy/SDS"

    # If true, automatically configure client side mTLS settings to match the corresponding service's
    # server side mTLS authentication policy, when destination rule for that service does not specify
    # TLS settings.
    enableAutoMtls: true

    outboundTrafficPolicy:
      mode: ALLOW_ANY
    localityLbSetting:
      enabled: true

    # Configures DNS certificates provisioned through Chiron linked into Pilot.
    # The DNS certificate provisioning is enabled by default now so it get tested.
    # TODO (lei-tang): we'll decide whether enable it by default or not before Istio 1.4 Release.
    certificates:
      []

    defaultConfig:
      #
      # TCP connection timeout between Envoy & the application, and between Envoys.
      connectTimeout: 10s
      #
      ### ADVANCED SETTINGS #############
      # Where should envoy's configuration be stored in the istio-proxy container
      configPath: "/etc/istio/proxy"
      # The pseudo service name used for Envoy.
      serviceCluster: istio-proxy
      # These settings that determine how long an old Envoy
      # process should be kept alive after an occasional reload.
      drainDuration: 45s
      parentShutdownDuration: 1m0s
      #
      # Port where Envoy listens (on local host) for admin commands
      # You can exec into the istio-proxy container in a pod and
      # curl the admin port (curl http://localhost:15000/) to obtain
      # diagnostic information from Envoy. See
      # https://lyft.github.io/envoy/docs/operations/admin.html
      # for more details
      proxyAdminPort: 15000
      #
      # Set concurrency to a specific number to control the number of Proxy worker threads.
      # If set to 0 (default), then start worker thread for each CPU thread/core.
      concurrency: 2
      #
      tracing:
        zipkin:
          # Address of the Zipkin collector
          address: zipkin.istio-system:9411

      # controlPlaneAuthPolicy is for mounted secrets, will wait for the files.
      controlPlaneAuthPolicy: NONE
      discoveryAddress: istiod.istio-control.svc:15012
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: istio-sidecar-injector
  namespace: istio-control
  labels:
    release: istio
data:

  values: |-
    {
      "global": {
        "arch": {
          "amd64": 2,
          "ppc64le": 2,
          "s390x": 2
        },
        "certificates": [],
        "configNamespace": "istio-system",
        "configValidation": true,
        "controlPlaneSecurityEnabled": true,
        "defaultNodeSelector": {},
        "defaultPodDisruptionBudget": {
          "enabled": true
        },
        "defaultResources": {
          "requests": {
            "cpu": "10m"
          }
        },
        "disablePolicyChecks": true,
        "enableHelmTest": false,
        "enableTracing": true,
        "enabled": false,
        "hub": "docker.io/istio",
        "imagePullPolicy": "",
        "imagePullSecrets": [],
        "istioNamespace": "istio-system",
        "istiod": {
          "enabled": true
        },
        "jwtPolicy": "third-party-jwt",
        "k8sIngress": {
          "enableHttps": false,
          "enabled": false,
          "gatewayName": "ingressgateway"
        },
        "localityLbSetting": {
          "enabled": true
        },
        "logAsJson": false,
        "logging": {
          "level": "default:info"
        },
        "meshExpansion": {
          "enabled": false,
          "useILB": false
        },
        "meshNetworks": {},
        "mountMtlsCerts": false,
        "mtls": {
          "auto": true,
          "enabled": false
        },
        "multiCluster": {
          "clusterName": "",
          "enabled": false
        },
        "namespace": "istio-system",
        "network": "",
        "omitSidecarInjectorConfigMap": false,
        "oneNamespace": false,
        "operatorManageWebhooks": false,
        "outboundTrafficPolicy": {
          "mode": "ALLOW_ANY"
        },
        "pilotCertProvider": "istiod",
        "policyCheckFailOpen": false,
        "policyNamespace": "istio-system",
        "priorityClassName": "",
        "prometheusNamespace": "istio-system",
        "proxy": {
          "accessLogEncoding": "TEXT",
          "accessLogFile": "",
          "accessLogFormat": "",
          "autoInject": "enabled",
          "clusterDomain": "cluster.local",
          "componentLogLevel": "misc:error",
          "concurrency": 2,
          "dnsRefreshRate": "300s",
          "enableCoreDump": false,
          "envoyAccessLogService": {
            "enabled": false
          },
          "envoyMetricsService": {
            "enabled": false,
            "tcpKeepalive": {
              "interval": "10s",
              "probes": 3,
              "time": "10s"
            },
            "tlsSettings": {
              "mode": "DISABLE",
              "subjectAltNames": []
            }
          },
          "envoyStatsd": {
            "enabled": false
          },
          "excludeIPRanges": "",
          "excludeInboundPorts": "",
          "excludeOutboundPorts": "",
          "image": "proxyv2",
          "includeIPRanges": "*",
          "includeInboundPorts": "*",
          "kubevirtInterfaces": "",
          "logLevel": "warning",
          "privileged": false,
          "protocolDetectionTimeout": "100ms",
          "readinessFailureThreshold": 30,
          "readinessInitialDelaySeconds": 1,
          "readinessPeriodSeconds": 2,
          "resources": {
            "limits": {
              "cpu": "2000m",
              "memory": "1024Mi"
            },
            "requests": {
              "cpu": "100m",
              "memory": "128Mi"
            }
          },
          "statusPort": 15020,
          "tracer": "zipkin"
        },
        "proxy_init": {
          "image": "proxyv2",
          "resources": {
            "limits": {
              "cpu": "100m",
              "memory": "50Mi"
            },
            "requests": {
              "cpu": "10m",
              "memory": "10Mi"
            }
          }
        },
        "sds": {
          "token": {
            "aud": "istio-ca"
          }
        },
        "securityNamespace": "istio-system",
        "sts": {
          "servicePort": 0
        },
        "tag": "1.1.4",
        "telemetryNamespace": "istio-system",
        "tracer": {
          "datadog": {
            "address": "$(HOST_IP):8126"
          },
          "lightstep": {
            "accessToken": "",
            "address": "",
            "cacertPath": "",
            "secure": true
          },
          "stackdriver": {
            "debug": false,
            "maxNumberOfAnnotations": 200,
            "maxNumberOfAttributes": 200,
            "maxNumberOfMessageEvents": 200
          },
          "zipkin": {
            "address": ""
          }
        },
        "trustDomain": "cluster.local",
        "useMCP": false
      },
      "istio_cni": {
        "enabled": false
      },
      "sidecarInjectorWebhook": {
        "alwaysInjectSelector": [],
        "enableNamespacesByDefault": false,
        "enabled": false,
        "injectLabel": "istio-injection",
        "injectedAnnotations": {},
        "namespace": "istio-system",
        "neverInjectSelector": [],
        "objectSelector": {
          "autoInject": true,
          "enabled": false
        },
        "rewriteAppHTTPProbe": false
      }
    }

  # To disable injection: use omitSidecarInjectorConfigMap, which disables the webhook patching
  # and istiod webhook functionality.
  #
  # New fields should not use Values - it is a 'primary' config object, users should be able
  # to fine tune it or use it with kube-inject.
  config: |-
    policy: enabled
    alwaysInjectSelector:
            []
    neverInjectSelector:
            []
    injectedAnnotations:

    # Configmap optimized for Istiod. Please DO NOT MERGE all changes from istio - in particular those dependent on
    # Values.yaml, which should not be used by istiod.
    
    # Istiod only uses SDS based config ( files will mapped/handled by SDS).
    
    template: |
      rewriteAppHTTPProbe: {{ valueOrDefault .Values.sidecarInjectorWebhook.rewriteAppHTTPProbe false }}
      initContainers:
      {{ if ne (annotation .ObjectMeta `sidecar.istio.io/interceptionMode` .ProxyConfig.InterceptionMode) `NONE` }}
      {{ if .Values.istio_cni.enabled -}}
      - name: istio-validation
      {{ else -}}
      - name: istio-init
      {{ end -}}
      {{- if contains "/" .Values.global.proxy_init.image }}
        image: "{{ .Values.global.proxy_init.image }}"
      {{- else }}
        image: "{{ .Values.global.hub }}/{{ .Values.global.proxy_init.image }}:{{ .Values.global.tag }}"
      {{- end }}
        command:
        - istio-iptables
        - "-p"
        - 15001
        - "-z"
        - "15006"
        - "-u"
        - 1337
        - "-m"
        - "{{ annotation .ObjectMeta `sidecar.istio.io/interceptionMode` .ProxyConfig.InterceptionMode }}"
        - "-i"
        - "{{ annotation .ObjectMeta `traffic.sidecar.istio.io/includeOutboundIPRanges` .Values.global.proxy.includeIPRanges }}"
        - "-x"
        - "{{ annotation .ObjectMeta `traffic.sidecar.istio.io/excludeOutboundIPRanges` .Values.global.proxy.excludeIPRanges }}"
        - "-b"
        - "{{ annotation .ObjectMeta `traffic.sidecar.istio.io/includeInboundPorts` `*` }}"
        - "-d"
        - "15090,{{ excludeInboundPort (annotation .ObjectMeta `status.sidecar.istio.io/port` .Values.global.proxy.statusPort) (annotation .ObjectMeta `traffic.sidecar.istio.io/excludeInboundPorts` .Values.global.proxy.excludeInboundPorts) }}"
        {{ if or (isset .ObjectMeta.Annotations `traffic.sidecar.istio.io/excludeOutboundPorts`) (ne (valueOrDefault .Values.global.proxy.excludeOutboundPorts "") "") -}}
        - "-o"
        - "{{ annotation .ObjectMeta `traffic.sidecar.istio.io/excludeOutboundPorts` .Values.global.proxy.excludeOutboundPorts }}"
        {{ end -}}
        {{ if (isset .ObjectMeta.Annotations `traffic.sidecar.istio.io/kubevirtInterfaces`) -}}
        - "-k"
        - "{{ index .ObjectMeta.Annotations `traffic.sidecar.istio.io/kubevirtInterfaces` }}"
        {{ end -}}
        {{ if .Values.istio_cni.enabled -}}
        - "--run-validation"
        - "--skip-rule-apply"
        {{ end -}}
        imagePullPolicy: "{{ valueOrDefault .Values.global.imagePullPolicy `Always` }}"
      {{- if .Values.global.proxy_init.resources }}
        resources:
          {{ toYaml .Values.global.proxy_init.resources | indent 4 }}
      {{- else }}
        resources: {}
      {{- end }}
        securityContext:
          allowPrivilegeEscalation: {{ .Values.global.proxy.privileged }}
          privileged: {{ .Values.global.proxy.privileged }}
          capabilities:
        {{- if not .Values.istio_cni.enabled }}
            add:
            - NET_ADMIN
            - NET_RAW
        {{- end }}
            drop:
            - ALL
          readOnlyRootFilesystem: false
        {{- if not .Values.istio_cni.enabled }}
          runAsGroup: 0
          runAsNonRoot: false
          runAsUser: 0
        {{- else }}
          runAsGroup: 1337
          runAsUser: 1337
          runAsNonRoot: true
        {{- end }}
        restartPolicy: Always
      {{ end -}}
      {{- if eq .Values.global.proxy.enableCoreDump true }}
      - name: enable-core-dump
        args:
        - -c
        - sysctl -w kernel.core_pattern=/var/lib/istio/core.proxy && ulimit -c unlimited
        command:
          - /bin/sh
      {{- if contains "/" .Values.global.proxy_init.image }}
        image: "{{ .Values.global.proxy_init.image }}"
      {{- else }}
        image: "{{ .Values.global.hub }}/{{ .Values.global.proxy_init.image }}:{{ .Values.global.tag }}"
      {{- end }}
        imagePullPolicy: "{{ valueOrDefault .Values.global.imagePullPolicy `Always` }}"
        resources: {}
        securityContext:
          allowPrivilegeEscalation: true
          capabilities:
            add:
            - SYS_ADMIN
            drop:
            - ALL
          privileged: true
          readOnlyRootFilesystem: false
          runAsGroup: 0
          runAsNonRoot: false
          runAsUser: 0
      {{ end }}
      containers:
      - name: istio-proxy
      {{- if contains "/" (annotation .ObjectMeta `sidecar.istio.io/proxyImage` .Values.global.proxy.image) }}
        image: "{{ annotation .ObjectMeta `sidecar.istio.io/proxyImage` .Values.global.proxy.image }}"
      {{- else }}
        image: "{{ .Values.global.hub }}/{{ .Values.global.proxy.image }}:{{ .Values.global.tag }}"
      {{- end }}
        ports:
        - containerPort: 15090
          protocol: TCP
          name: http-envoy-prom
        args:
        - proxy
        - sidecar
        - --domain
        - $(POD_NAMESPACE).svc.{{ .Values.global.proxy.clusterDomain }}
        - --serviceCluster
        {{ if ne "" (index .ObjectMeta.Labels "app") -}}
        - "{{ index .ObjectMeta.Labels `app` }}.$(POD_NAMESPACE)"
        {{ else -}}
        - "{{ valueOrDefault .DeploymentMeta.Name `istio-proxy` }}.{{ valueOrDefault .DeploymentMeta.Namespace `default` }}"
        {{ end -}}
        - --proxyLogLevel={{ annotation .ObjectMeta `sidecar.istio.io/logLevel` .Values.global.proxy.logLevel}}
        - --proxyComponentLogLevel={{ annotation .ObjectMeta `sidecar.istio.io/componentLogLevel` .Values.global.proxy.componentLogLevel}}
      {{- if (ne (annotation .ObjectMeta "status.sidecar.istio.io/port" .Values.global.proxy.statusPort) "0") }}
        - --statusPort
        - "{{ annotation .ObjectMeta `status.sidecar.istio.io/port` .Values.global.proxy.statusPort }}"
      {{- end }}
      {{- if .Values.global.sts.servicePort }}
        - --stsPort={{ .Values.global.sts.servicePort }}
      {{- end }}
      {{- if .Values.global.trustDomain }}
        - --trust-domain={{ .Values.global.trustDomain }}
      {{- end }}
      {{- if .Values.global.logAsJson }}
        - --log_as_json
      {{- end }}
        - --controlPlaneBootstrap=false
      {{- if .Values.global.proxy.lifecycle }}
        lifecycle:
          {{ toYaml .Values.global.proxy.lifecycle | indent 4 }}
        {{- end }}
        env:
        - name: JWT_POLICY
          value: {{ .Values.global.jwtPolicy }}
        - name: PILOT_CERT_PROVIDER
          value: {{ .Values.global.pilotCertProvider }}
        # Temp, pending PR to make it default or based on the istiodAddr env
        - name: CA_ADDR
        {{- if .Values.global.configNamespace }}
          value: istiod.{{ .Values.global.configNamespace }}.svc:15012
        {{- else }}
          value: istiod.istio-system.svc:15012
        {{- end }}
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: INSTANCE_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: SERVICE_ACCOUNT
          valueFrom:
            fieldRef:
              fieldPath: spec.serviceAccountName
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: MESH_CONFIG
          value: |
                 {{ protoToJSON .MeshConfig }}
        - name: ISTIO_META_POD_PORTS
          value: |-
            [
            {{- $first := true }}
            {{- range $index1, $c := .Spec.Containers }}
              {{- range $index2, $p := $c.Ports }}
                {{- if (structToJSON $p) }}
                {{if not $first}},{{end}}{{ structToJSON $p }}
                {{- $first = false }}
                {{- end }}
              {{- end}}
            {{- end}}
            ]
        - name: ISTIO_META_CLUSTER_ID
          value: "{{ valueOrDefault .Values.global.multiCluster.clusterName `Kubernetes` }}"
        - name: ISTIO_META_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: ISTIO_META_CONFIG_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: ISTIO_META_INTERCEPTION_MODE
          value: "{{ or (index .ObjectMeta.Annotations `sidecar.istio.io/interceptionMode`) .ProxyConfig.InterceptionMode.String }}"
        {{- if .Values.global.network }}
        - name: ISTIO_META_NETWORK
          value: "{{ .Values.global.network }}"
        {{- end }}
        {{ if .ObjectMeta.Annotations }}
        - name: ISTIO_METAJSON_ANNOTATIONS
          value: |
                 {{ toJSON .ObjectMeta.Annotations }}
        {{ end }}
        {{- if .DeploymentMeta.Name }}
        - name: ISTIO_META_WORKLOAD_NAME
          value: {{ .DeploymentMeta.Name }}
        {{ end }}
        {{- if and .TypeMeta.APIVersion .DeploymentMeta.Name }}
        - name: ISTIO_META_OWNER
          value: kubernetes://apis/{{ .TypeMeta.APIVersion }}/namespaces/{{ valueOrDefault .DeploymentMeta.Namespace `default` }}/{{ toLower .TypeMeta.Kind}}s/{{ .DeploymentMeta.Name }}
        {{- end}}
        {{- if (isset .ObjectMeta.Annotations `sidecar.istio.io/bootstrapOverride`) }}
        - name: ISTIO_BOOTSTRAP_OVERRIDE
          value: "/etc/istio/custom-bootstrap/custom_bootstrap.json"
        {{- end }}
        {{- if .Values.global.meshID }}
        - name: ISTIO_META_MESH_ID
          value: "{{ .Values.global.meshID }}"
        {{- else if .Values.global.trustDomain }}
        - name: ISTIO_META_MESH_ID
          value: "{{ .Values.global.trustDomain }}"
        {{- end }}
        {{- if and (eq .Values.global.proxy.tracer "datadog") (isset .ObjectMeta.Annotations `apm.datadoghq.com/env`) }}
        {{- range $key, $value := fromJSON (index .ObjectMeta.Annotations `apm.datadoghq.com/env`) }}
          - name: {{ $key }}
            value: "{{ $value }}"
        {{- end }}
        {{- end }}
        {{- range $key, $value := .ProxyConfig.ProxyMetadata }}
        - name: {{ $key }}
          value: "{{ $value }}"
        {{- end }}
        imagePullPolicy: "{{ valueOrDefault .Values.global.imagePullPolicy `Always` }}"
        {{ if ne (annotation .ObjectMeta `status.sidecar.istio.io/port` .Values.global.proxy.statusPort) `0` }}
        readinessProbe:
          httpGet:
            path: /healthz/ready
            port: {{ annotation .ObjectMeta `status.sidecar.istio.io/port` .Values.global.proxy.statusPort }}
          initialDelaySeconds: {{ annotation .ObjectMeta `readiness.status.sidecar.istio.io/initialDelaySeconds` .Values.global.proxy.readinessInitialDelaySeconds }}
          periodSeconds: {{ annotation .ObjectMeta `readiness.status.sidecar.istio.io/periodSeconds` .Values.global.proxy.readinessPeriodSeconds }}
          failureThreshold: {{ annotation .ObjectMeta `readiness.status.sidecar.istio.io/failureThreshold` .Values.global.proxy.readinessFailureThreshold }}
        {{ end -}}
        securityContext:
          allowPrivilegeEscalation: {{ .Values.global.proxy.privileged }}
          capabilities:
            {{ if or (eq (annotation .ObjectMeta `sidecar.istio.io/interceptionMode` .ProxyConfig.InterceptionMode) `TPROXY`) (eq (annotation .ObjectMeta `sidecar.istio.io/capNetBindService` .Values.global.proxy.capNetBindService) `true`) -}}
            add:
            {{ if eq (annotation .ObjectMeta `sidecar.istio.io/interceptionMode` .ProxyConfig.InterceptionMode) `TPROXY` -}}
            - NET_ADMIN
            {{- end }}
            {{ if eq (annotation .ObjectMeta `sidecar.istio.io/capNetBindService` .Values.global.proxy.capNetBindService) `true` -}}
            - NET_BIND_SERVICE
            {{- end }}
            {{- end }}
            drop:
            - ALL
          privileged: {{ .Values.global.proxy.privileged }}
          readOnlyRootFilesystem: {{ not .Values.global.proxy.enableCoreDump }}
          runAsGroup: 1337
          fsGroup: 1337
          {{ if or (eq (annotation .ObjectMeta `sidecar.istio.io/interceptionMode` .ProxyConfig.InterceptionMode) `TPROXY`) (eq (annotation .ObjectMeta `sidecar.istio.io/capNetBindService` .Values.global.proxy.capNetBindService) `true`) -}}
          runAsNonRoot: false
          runAsUser: 0
          {{- else -}}
          runAsNonRoot: true
          runAsUser: 1337
          {{- end }}
        resources:
          {{ if or (isset .ObjectMeta.Annotations `sidecar.istio.io/proxyCPU`) (isset .ObjectMeta.Annotations `sidecar.istio.io/proxyMemory`) -}}
          requests:
            {{ if (isset .ObjectMeta.Annotations `sidecar.istio.io/proxyCPU`) -}}
            cpu: "{{ index .ObjectMeta.Annotations `sidecar.istio.io/proxyCPU` }}"
            {{ end}}
            {{ if (isset .ObjectMeta.Annotations `sidecar.istio.io/proxyMemory`) -}}
            memory: "{{ index .ObjectMeta.Annotations `sidecar.istio.io/proxyMemory` }}"
            {{ end }}
        {{ else -}}
      {{- if .Values.global.proxy.resources }}
          {{ toYaml .Values.global.proxy.resources | indent 4 }}
      {{- end }}
        {{  end -}}
        volumeMounts:
        {{- if eq .Values.global.pilotCertProvider "istiod" }}
        - mountPath: /var/run/secrets/istio
          name: istiod-ca-cert
        {{- end }}
        {{ if (isset .ObjectMeta.Annotations `sidecar.istio.io/bootstrapOverride`) }}
        - mountPath: /etc/istio/custom-bootstrap
          name: custom-bootstrap-volume
        {{- end }}
        # SDS channel between istioagent and Envoy
        - mountPath: /etc/istio/proxy
          name: istio-envoy
        {{- if eq .Values.global.jwtPolicy "third-party-jwt" }}
        - mountPath: /var/run/secrets/tokens
          name: istio-token
        {{- end }}
        {{- if .Values.global.mountMtlsCerts }}
        # Use the key and cert mounted to /etc/certs/ for the in-cluster mTLS communications.
        - mountPath: /etc/certs/
          name: istio-certs
          readOnly: true
        {{- end }}
        - name: podinfo
          mountPath: /etc/istio/pod
        {{- if and (eq .Values.global.proxy.tracer "lightstep") .Values.global.tracer.lightstep.cacertPath }}
        - mountPath: {{ directory .ProxyConfig.GetTracing.GetLightstep.GetCacertPath }}
          name: lightstep-certs
          readOnly: true
        {{- end }}
          {{- if isset .ObjectMeta.Annotations `sidecar.istio.io/userVolumeMount` }}
          {{ range $index, $value := fromJSON (index .ObjectMeta.Annotations `sidecar.istio.io/userVolumeMount`) }}
        - name: "{{  $index }}"
          {{ toYaml $value | indent 4 }}
          {{ end }}
          {{- end }}
      volumes:
      {{- if (isset .ObjectMeta.Annotations `sidecar.istio.io/bootstrapOverride`) }}
      - name: custom-bootstrap-volume
        configMap:
          name: {{ annotation .ObjectMeta `sidecar.istio.io/bootstrapOverride` "" }}
      {{- end }}
      # SDS channel between istioagent and Envoy
      - emptyDir:
          medium: Memory
        name: istio-envoy
      - name: podinfo
        downwardAPI:
          items:
            - path: "labels"
              fieldRef:
                fieldPath: metadata.labels
            - path: "annotations"
              fieldRef:
                fieldPath: metadata.annotations
      {{- if eq .Values.global.jwtPolicy "third-party-jwt" }}
      - name: istio-token
        projected:
          sources:
          - serviceAccountToken:
              path: istio-token
              expirationSeconds: 43200
              audience: {{ .Values.global.sds.token.aud }}
      {{- end }}
      {{- if eq .Values.global.pilotCertProvider "istiod" }}
      - name: istiod-ca-cert
        configMap:
          name: istio-ca-root-cert
      {{- end }}
      {{- if .Values.global.mountMtlsCerts }}
      # Use the key and cert mounted to /etc/certs/ for the in-cluster mTLS communications.
      - name: istio-certs
        secret:
          optional: true
          {{ if eq .Spec.ServiceAccountName "" }}
          secretName: istio.default
          {{ else -}}
          secretName: {{  printf "istio.%s" .Spec.ServiceAccountName }}
          {{  end -}}
      {{- end }}
        {{- if isset .ObjectMeta.Annotations `sidecar.istio.io/userVolume` }}
        {{range $index, $value := fromJSON (index .ObjectMeta.Annotations `sidecar.istio.io/userVolume`) }}
      - name: "{{ $index }}"
        {{ toYaml $value | indent 2 }}
        {{ end }}
        {{ end }}
      {{- if and (eq .Values.global.proxy.tracer "lightstep") .Values.global.tracer.lightstep.cacertPath }}
      - name: lightstep-certs
        secret:
          optional: true
          secretName: lightstep.cacert
      {{- end }}
      {{- if .Values.global.podDNSSearchNamespaces }}
      dnsConfig:
        searches:
          {{- range .Values.global.podDNSSearchNamespaces }}
          - {{ render . }}
          {{- end }}
      {{- end }}
      podRedirectAnnot:
        sidecar.istio.io/interceptionMode: "{{ annotation .ObjectMeta `sidecar.istio.io/interceptionMode` .ProxyConfig.InterceptionMode }}"
        traffic.sidecar.istio.io/includeOutboundIPRanges: "{{ annotation .ObjectMeta `traffic.sidecar.istio.io/includeOutboundIPRanges` .Values.global.proxy.includeIPRanges }}"
        traffic.sidecar.istio.io/excludeOutboundIPRanges: "{{ annotation .ObjectMeta `traffic.sidecar.istio.io/excludeOutboundIPRanges` .Values.global.proxy.excludeIPRanges }}"
        traffic.sidecar.istio.io/includeInboundPorts: "{{ annotation .ObjectMeta `traffic.sidecar.istio.io/includeInboundPorts` (includeInboundPorts .Spec.Containers) }}"
        traffic.sidecar.istio.io/excludeInboundPorts: "{{ excludeInboundPort (annotation .ObjectMeta `status.sidecar.istio.io/port` .Values.global.proxy.statusPort) (annotation .ObjectMeta `traffic.sidecar.istio.io/excludeInboundPorts` .Values.global.proxy.excludeInboundPorts) }}"
      {{ if or (isset .ObjectMeta.Annotations `traffic.sidecar.istio.io/excludeOutboundPorts`) (ne .Values.global.proxy.excludeOutboundPorts "") }}
        traffic.sidecar.istio.io/excludeOutboundPorts: "{{ annotation .ObjectMeta `traffic.sidecar.istio.io/excludeOutboundPorts` .Values.global.proxy.excludeOutboundPorts }}"
      {{- end }}
        traffic.sidecar.istio.io/kubevirtInterfaces: "{{ index .ObjectMeta.Annotations `traffic.sidecar.istio.io/kubevirtInterfaces` }}"
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: metadata-exchange-1.4
  namespace: istio-control
spec:
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: ANY # inbound, outbound, and gateway
        proxy:
          proxyVersion: '^1\.4.*'
        listener:
          filterChain:
            filter:
              name: "envoy.http_connection_manager"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.wasm
          config:
            config:
              configuration: envoy.wasm.metadata_exchange
              vm_config:
                runtime: envoy.wasm.runtime.null
                code:
                  inline_string: envoy.wasm.metadata_exchange
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: metadata-exchange-1.5
  namespace: istio-control
spec:
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: ANY # inbound, outbound, and gateway
        proxy:
          proxyVersion: '^1\.5.*'
        listener:
          filterChain:
            filter:
              name: "envoy.http_connection_manager"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.wasm
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.config.filter.http.wasm.v2.Wasm
            value:
              config:
                configuration: envoy.wasm.metadata_exchange
                vm_config:
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: envoy.wasm.metadata_exchange
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: metadata-exchange-1.6
  namespace: istio-control
spec:
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: ANY # inbound, outbound, and gateway
        proxy:
          proxyVersion: '^1\.6.*'
        listener:
          filterChain:
            filter:
              name: "envoy.http_connection_manager"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.wasm
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.config.filter.http.wasm.v2.Wasm
            value:
              config:
                configuration: envoy.wasm.metadata_exchange
                vm_config:
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: envoy.wasm.metadata_exchange
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: stats-filter-1.4
  namespace: istio-control
spec:
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_OUTBOUND
        proxy:
          proxyVersion: '^1\.4.*'
        listener:
          filterChain:
            filter:
              name: "envoy.http_connection_manager"
              subFilter:
                name: "envoy.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.wasm
          config:
            config:
              root_id: stats_outbound
              configuration: |
                {
                  "debug": "false",
                  "stat_prefix": "istio",
                }
              vm_config:
                vm_id: stats_outbound
                runtime: envoy.wasm.runtime.null
                code:
                  inline_string: envoy.wasm.stats
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_INBOUND
        proxy:
          proxyVersion: '^1\.4.*'
        listener:
          filterChain:
            filter:
              name: "envoy.http_connection_manager"
              subFilter:
                name: "envoy.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.wasm
          config:
            config:
              root_id: stats_inbound
              configuration: |
                {
                  "debug": "false",
                  "stat_prefix": "istio",
                }
              vm_config:
                vm_id: stats_inbound
                runtime: envoy.wasm.runtime.null
                code:
                  inline_string: envoy.wasm.stats
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        proxy:
          proxyVersion: '^1\.4.*'
        listener:
          filterChain:
            filter:
              name: "envoy.http_connection_manager"
              subFilter:
                name: "envoy.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.wasm
          config:
            config:
              root_id: stats_outbound
              configuration: |
                {
                  "debug": "false",
                  "stat_prefix": "istio",
                }
              vm_config:
                vm_id: stats_outbound
                runtime: envoy.wasm.runtime.null
                code:
                  inline_string: envoy.wasm.stats
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: stats-filter-1.5
  namespace: istio-control
spec:
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_OUTBOUND
        proxy:
          proxyVersion: '^1\.5.*'
        listener:
          filterChain:
            filter:
              name: "envoy.http_connection_manager"
              subFilter:
                name: "envoy.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.wasm
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.config.filter.http.wasm.v2.Wasm
            value:
              config:
                root_id: stats_outbound
                configuration: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                  }
                vm_config:
                  vm_id: stats_outbound
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: envoy.wasm.stats
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_INBOUND
        proxy:
          proxyVersion: '^1\.5.*'
        listener:
          filterChain:
            filter:
              name: "envoy.http_connection_manager"
              subFilter:
                name: "envoy.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.wasm
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.config.filter.http.wasm.v2.Wasm
            value:
              config:
                root_id: stats_inbound
                configuration: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                  }
                vm_config:
                  vm_id: stats_inbound
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: envoy.wasm.stats
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        proxy:
          proxyVersion: '^1\.5.*'
        listener:
          filterChain:
            filter:
              name: "envoy.http_connection_manager"
              subFilter:
                name: "envoy.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.wasm
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.config.filter.http.wasm.v2.Wasm
            value:
              config:
                root_id: stats_outbound
                configuration: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                  }
                vm_config:
                  vm_id: stats_outbound
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: envoy.wasm.stats
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: stats-filter-1.6
  namespace: istio-control
spec:
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_OUTBOUND
        proxy:
          proxyVersion: '^1\.6.*'
        listener:
          filterChain:
            filter:
              name: "envoy.http_connection_manager"
              subFilter:
                name: "envoy.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.wasm
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.config.filter.http.wasm.v2.Wasm
            value:
              config:
                root_id: stats_outbound
                configuration: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                  }
                vm_config:
                  vm_id: stats_outbound
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: envoy.wasm.stats
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_INBOUND
        proxy:
          proxyVersion: '^1\.6.*'
        listener:
          filterChain:
            filter:
              name: "envoy.http_connection_manager"
              subFilter:
                name: "envoy.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.wasm
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.config.filter.http.wasm.v2.Wasm
            value:
              config:
                root_id: stats_inbound
                configuration: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                  }
                vm_config:
                  vm_id: stats_inbound
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: envoy.wasm.stats
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        proxy:
          proxyVersion: '^1\.6.*'
        listener:
          filterChain:
            filter:
              name: "envoy.http_connection_manager"
              subFilter:
                name: "envoy.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.wasm
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.config.filter.http.wasm.v2.Wasm
            value:
              config:
                root_id: stats_outbound
                configuration: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                  }
                vm_config:
                  vm_id: stats_outbound
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: envoy.wasm.stats
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: tcp-metadata-exchange-1.5
  namespace: istio-control
spec:
  configPatches:
    - applyTo: NETWORK_FILTER
      match:
        context: SIDECAR_INBOUND
        proxy:
          proxyVersion: '^1\.5.*'
        listener: {}
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.network.metadata_exchange
          config:
            protocol: istio-peer-exchange
    - applyTo: CLUSTER
      match:
        context: SIDECAR_OUTBOUND
        proxy:
          proxyVersion: '^1\.5.*'
        cluster: {}
      patch:
        operation: MERGE
        value:
          filters:
          - name: envoy.filters.network.upstream.metadata_exchange
            typed_config:
              "@type": type.googleapis.com/udpa.type.v1.TypedStruct
              type_url: type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange
              value:
                protocol: istio-peer-exchange
    - applyTo: CLUSTER
      match:
        context: GATEWAY
        proxy:
          proxyVersion: '^1\.5.*'
        cluster: {}
      patch:
        operation: MERGE
        value:
          filters:
          - name: envoy.filters.network.upstream.metadata_exchange
            typed_config:
              "@type": type.googleapis.com/udpa.type.v1.TypedStruct
              type_url: type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange
              value:
                protocol: istio-peer-exchange
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: tcp-metadata-exchange-1.6
  namespace: istio-control
spec:
  configPatches:
    - applyTo: NETWORK_FILTER
      match:
        context: SIDECAR_INBOUND
        proxy:
          proxyVersion: '^1\.6.*'
        listener: {}
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.network.metadata_exchange
          config:
            protocol: istio-peer-exchange
    - applyTo: CLUSTER
      match:
        context: SIDECAR_OUTBOUND
        proxy:
          proxyVersion: '^1\.6.*'
        cluster: {}
      patch:
        operation: MERGE
        value:
          filters:
          - name: envoy.filters.network.upstream.metadata_exchange
            typed_config:
              "@type": type.googleapis.com/udpa.type.v1.TypedStruct
              type_url: type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange
              value:
                protocol: istio-peer-exchange
    - applyTo: CLUSTER
      match:
        context: GATEWAY
        proxy:
          proxyVersion: '^1\.6.*'
        cluster: {}
      patch:
        operation: MERGE
        value:
          filters:
          - name: envoy.filters.network.upstream.metadata_exchange
            typed_config:
              "@type": type.googleapis.com/udpa.type.v1.TypedStruct
              type_url: type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange
              value:
                protocol: istio-peer-exchange
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: tcp-stats-filter-1.5
  namespace: istio-control
spec:
  configPatches:
    - applyTo: NETWORK_FILTER
      match:
        context: SIDECAR_INBOUND
        proxy:
          proxyVersion: '^1\.5.*'
        listener:
          filterChain:
            filter:
              name: "envoy.tcp_proxy"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.network.wasm
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.config.filter.network.wasm.v2.Wasm
            value:
              config:
                root_id: stats_inbound
                configuration: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                  }
                vm_config:
                  vm_id: stats_inbound
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: "envoy.wasm.stats"
    - applyTo: NETWORK_FILTER
      match:
        context: SIDECAR_OUTBOUND
        proxy:
          proxyVersion: '^1\.5.*'
        listener:
          filterChain:
            filter:
              name: "envoy.tcp_proxy"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.network.wasm
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.config.filter.network.wasm.v2.Wasm
            value:
              config:
                root_id: stats_outbound
                configuration: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                  }
                vm_config:
                  vm_id: stats_outbound
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: "envoy.wasm.stats"
    - applyTo: NETWORK_FILTER
      match:
        context: GATEWAY
        proxy:
          proxyVersion: '^1\.5.*'
        listener:
          filterChain:
            filter:
              name: "envoy.tcp_proxy"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.network.wasm
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.config.filter.network.wasm.v2.Wasm
            value:
              config:
                root_id: stats_outbound
                configuration: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                  }
                vm_config:
                  vm_id: stats_outbound
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: "envoy.wasm.stats"
---
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: tcp-stats-filter-1.6
  namespace: istio-control
spec:
  configPatches:
    - applyTo: NETWORK_FILTER
      match:
        context: SIDECAR_INBOUND
        proxy:
          proxyVersion: '^1\.6.*'
        listener:
          filterChain:
            filter:
              name: "envoy.tcp_proxy"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.network.wasm
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.config.filter.network.wasm.v2.Wasm
            value:
              config:
                root_id: stats_inbound
                configuration: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                  }
                vm_config:
                  vm_id: stats_inbound
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: "envoy.wasm.stats"
    - applyTo: NETWORK_FILTER
      match:
        context: SIDECAR_OUTBOUND
        proxy:
          proxyVersion: '^1\.6.*'
        listener:
          filterChain:
            filter:
              name: "envoy.tcp_proxy"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.network.wasm
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.config.filter.network.wasm.v2.Wasm
            value:
              config:
                root_id: stats_outbound
                configuration: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                  }
                vm_config:
                  vm_id: stats_outbound
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: "envoy.wasm.stats"
    - applyTo: NETWORK_FILTER
      match:
        context: GATEWAY
        proxy:
          proxyVersion: '^1\.6.*'
        listener:
          filterChain:
            filter:
              name: "envoy.tcp_proxy"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.network.wasm
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.config.filter.network.wasm.v2.Wasm
            value:
              config:
                root_id: stats_outbound
                configuration: |
                  {
                    "debug": "false",
                    "stat_prefix": "istio",
                  }
                vm_config:
                  vm_id: stats_outbound
                  runtime: envoy.wasm.runtime.null
                  code:
                    local:
                      inline_string: "envoy.wasm.stats"
---
apiVersion: autoscaling/v2beta1
kind: HorizontalPodAutoscaler
metadata:
  name: istiod
  namespace: istio-control
  labels:
    app: istiod
    release: istio
spec:
  maxReplicas: 5
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: istiod
  metrics:
  - type: Resource
    resource:
      name: cpu
      targetAverageUtilization: 80
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: istio-sidecar-injector-istio-control
  labels:
    app: sidecar-injector
    release: istio
webhooks:
  - name: sidecar-injector.istio.io
    clientConfig:
      service:
        name: istiod
        namespace: istio-control
        path: "/inject"
      caBundle: ""
    rules:
      - operations: [ "CREATE" ]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["pods"]
    failurePolicy: Fail
    namespaceSelector:
      matchLabels:
        istio-injection: enabled
---
apiVersion: policy/v1beta1
kind: PodDisruptionBudget
metadata:
  name: istiod
  namespace: istio-control
  labels:
    app: istiod
    release: istio
    istio: pilot
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: istiod
      release: istio
      istio: pilot
---
apiVersion: v1
kind: Service
metadata:
  name: istiod
  namespace: istio-control
  labels:
    app: istiod
    release: istio
spec:
  ports:
    - port: 15012
      name: https-dns # mTLS with k8s-signed cert
    - port: 443
      name: https-webhook # validation and injection
      targetPort: 15017
  selector:
    app: istiod
    # Label used by the 'default' service. For versioned deployments we match with app and version.
    # This avoids default deployment picking the canary
    istio: pilot
---


2020-03-03T12:20:02.479901Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:20:02.480024Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:20:02.480044Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:02.480096Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:02.645010Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:20:02.645065Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:20:02.645084Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:02.645103Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:02.721631Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:20:02.721689Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:20:02.721711Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:02.721730Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:02.959637Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:20:02.959738Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:20:02.959792Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:02.959834Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:03.120996Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:20:03.121051Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:20:03.121074Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:03.121158Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:03.283183Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:20:03.283300Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:20:03.283384Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:03.283399Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:03.413045Z	info	installer	Applying Kubernetes overlay: 
- kind: handler
  name: prometheus
  patches:
  - path: spec.params.metrics.[name:requests_total].label_names.[reporter]
    value: new_metric
- kind: Deployment
  name: istio-telemetry
  patches:
  - path: spec.template.spec.containers.[name:mixer].args.[--trace_zipkin_url]
    value: --trace_zipkin_url=http://zipkin.istio-telemetry:1234/api/v1/spans


2020-03-03T12:20:03.432600Z	info	installer	Manifest after resources and overlay: 
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: istio-mixer
    istio: mixer
    release: istio
  name: istio-telemetry
  namespace: istio-system
spec:
  replicas: 1
  selector:
    matchLabels:
      istio: mixer
      istio-mixer-type: telemetry
  strategy:
    rollingUpdate:
      maxSurge: 100%
      maxUnavailable: 25%
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
      labels:
        app: telemetry
        istio: mixer
        istio-mixer-type: telemetry
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - preference:
              matchExpressions:
              - key: beta.kubernetes.io/arch
                operator: In
                values:
                - amd64
            weight: 2
          - preference:
              matchExpressions:
              - key: beta.kubernetes.io/arch
                operator: In
                values:
                - ppc64le
            weight: 2
          - preference:
              matchExpressions:
              - key: beta.kubernetes.io/arch
                operator: In
                values:
                - s390x
            weight: 2
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: beta.kubernetes.io/arch
                operator: In
                values:
                - amd64
                - ppc64le
                - s390x
      containers:
      - args:
        - --monitoringPort=15014
        - --address
        - unix:///sock/mixer.socket
        - --log_output_level=default:info
        - --configStoreURL=k8s://
        - --configDefaultNamespace=istio-system
        - --useAdapterCRDs=false
        - --useTemplateCRDs=false
        - --trace_zipkin_url=http://zipkin.istio-telemetry:1234/api/v1/spans
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: GOMAXPROCS
          value: "6"
        image: gcr.io/istio-testing/mixer:latest
        livenessProbe:
          httpGet:
            path: /version
            port: 15014
          initialDelaySeconds: 5
          periodSeconds: 5
        name: mixer
        ports:
        - containerPort: 9091
        - containerPort: 15014
        - containerPort: 42422
        resources:
          limits:
            cpu: 4800m
            memory: 4G
          requests:
            cpu: 1000m
            memory: 1G
        securityContext:
          capabilities:
            drop:
            - ALL
          runAsGroup: 1337
          runAsNonRoot: true
          runAsUser: 1337
        volumeMounts:
        - mountPath: /sock
          name: uds-socket
        - mountPath: /var/run/secrets/istio.io/telemetry/adapter
          name: telemetry-adapter-secret
          readOnly: true
      - args:
        - proxy
        - --domain
        - $(POD_NAMESPACE).svc.cluster.local
        - --serviceCluster
        - istio-telemetry
        - --templateFile
        - /var/lib/envoy/envoy.yaml.tmpl
        - --controlPlaneAuthPolicy
        - MUTUAL_TLS
        - --trust-domain=cluster.local
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: INSTANCE_IP
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: status.podIP
        image: gcr.io/istio-testing/proxyv2:latest
        name: istio-proxy
        ports:
        - containerPort: 15004
        - containerPort: 15090
          name: http-envoy-prom
          protocol: TCP
        resources:
          limits:
            cpu: 2000m
            memory: 1024Mi
          requests:
            cpu: 100m
            memory: 128Mi
        volumeMounts:
        - mountPath: /var/lib/envoy
          name: telemetry-envoy-config
        - mountPath: /etc/certs
          name: istio-certs
          readOnly: true
        - mountPath: /sock
          name: uds-socket
      securityContext:
        fsGroup: 1337
      serviceAccountName: istio-mixer-service-account
      volumes:
      - name: istio-certs
        secret:
          optional: true
          secretName: istio.istio-mixer-service-account
      - emptyDir: {}
        name: uds-socket
      - name: telemetry-adapter-secret
        secret:
          optional: true
          secretName: telemetry-adapter-secret
      - configMap:
          name: telemetry-envoy-config
        name: telemetry-envoy-config

---
apiVersion: config.istio.io/v1alpha2
kind: handler
metadata:
  labels:
    app: istio-telemetry
    release: istio
  name: prometheus
  namespace: istio-system
spec:
  compiledAdapter: prometheus
  params:
    metrics:
    - instance_name: requestcount.instance.istio-system
      kind: COUNTER
      label_names:
      - new_metric
      - source_app
      - source_principal
      - source_workload
      - source_workload_namespace
      - source_version
      - destination_app
      - destination_principal
      - destination_workload
      - destination_workload_namespace
      - destination_version
      - destination_service
      - destination_service_name
      - destination_service_namespace
      - request_protocol
      - grpc_response_status
      - response_code
      - response_flags
      - connection_security_policy
      name: requests_total
    - buckets:
        explicit_buckets:
          bounds:
          - 0.005
          - 0.01
          - 0.025
          - 0.05
          - 0.1
          - 0.25
          - 0.5
          - 1
          - 2.5
          - 5
          - 10
      instance_name: requestduration.instance.istio-system
      kind: DISTRIBUTION
      label_names:
      - reporter
      - source_app
      - source_principal
      - source_workload
      - source_workload_namespace
      - source_version
      - destination_app
      - destination_principal
      - destination_workload
      - destination_workload_namespace
      - destination_version
      - destination_service
      - destination_service_name
      - destination_service_namespace
      - request_protocol
      - response_code
      - grpc_response_status
      - response_flags
      - connection_security_policy
      name: request_duration_seconds
    - buckets:
        exponentialBuckets:
          growthFactor: 10
          numFiniteBuckets: 8
          scale: 1
      instance_name: requestsize.instance.istio-system
      kind: DISTRIBUTION
      label_names:
      - reporter
      - source_app
      - source_principal
      - source_workload
      - source_workload_namespace
      - source_version
      - destination_app
      - destination_principal
      - destination_workload
      - destination_workload_namespace
      - destination_version
      - destination_service
      - destination_service_name
      - destination_service_namespace
      - request_protocol
      - response_code
      - grpc_response_status
      - response_flags
      - connection_security_policy
      name: request_bytes
    - buckets:
        exponentialBuckets:
          growthFactor: 10
          numFiniteBuckets: 8
          scale: 1
      instance_name: responsesize.instance.istio-system
      kind: DISTRIBUTION
      label_names:
      - reporter
      - source_app
      - source_principal
      - source_workload
      - source_workload_namespace
      - source_version
      - destination_app
      - destination_principal
      - destination_workload
      - destination_workload_namespace
      - destination_version
      - destination_service
      - destination_service_name
      - destination_service_namespace
      - request_protocol
      - response_code
      - grpc_response_status
      - response_flags
      - connection_security_policy
      name: response_bytes
    - instance_name: tcpbytesent.instance.istio-system
      kind: COUNTER
      label_names:
      - reporter
      - source_app
      - source_principal
      - source_workload
      - source_workload_namespace
      - source_version
      - destination_app
      - destination_principal
      - destination_workload
      - destination_workload_namespace
      - destination_version
      - destination_service
      - destination_service_name
      - destination_service_namespace
      - connection_security_policy
      - response_flags
      name: tcp_sent_bytes_total
    - instance_name: tcpbytereceived.instance.istio-system
      kind: COUNTER
      label_names:
      - reporter
      - source_app
      - source_principal
      - source_workload
      - source_workload_namespace
      - source_version
      - destination_app
      - destination_principal
      - destination_workload
      - destination_workload_namespace
      - destination_version
      - destination_service
      - destination_service_name
      - destination_service_namespace
      - connection_security_policy
      - response_flags
      name: tcp_received_bytes_total
    - instance_name: tcpconnectionsopened.instance.istio-system
      kind: COUNTER
      label_names:
      - reporter
      - source_app
      - source_principal
      - source_workload
      - source_workload_namespace
      - source_version
      - destination_app
      - destination_principal
      - destination_workload
      - destination_workload_namespace
      - destination_version
      - destination_service
      - destination_service_name
      - destination_service_namespace
      - connection_security_policy
      - response_flags
      name: tcp_connections_opened_total
    - instance_name: tcpconnectionsclosed.instance.istio-system
      kind: COUNTER
      label_names:
      - reporter
      - source_app
      - source_principal
      - source_workload
      - source_workload_namespace
      - source_version
      - destination_app
      - destination_principal
      - destination_workload
      - destination_workload_namespace
      - destination_version
      - destination_service
      - destination_service_name
      - destination_service_namespace
      - connection_security_policy
      - response_flags
      name: tcp_connections_closed_total
    metricsExpirationPolicy:
      metricsExpiryDuration: 10m

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: istio-mixer-istio-system
  labels:
    app: istio-telemetry
    release: istio
rules:
- apiGroups: ["config.istio.io"] # istio CRD watcher
  resources: ["*"]
  verbs: ["create", "get", "list", "watch", "patch"]
- apiGroups: ["apiextensions.k8s.io"]
  resources: ["customresourcedefinitions"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["configmaps", "endpoints", "pods", "services", "namespaces", "secrets", "replicationcontrollers"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["extensions", "apps"]
  resources: ["replicasets"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: istio-mixer-admin-role-binding-istio-system
  labels:
    app: istio-telemetry
    release: istio
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: istio-mixer-istio-system
subjects:
  - kind: ServiceAccount
    name: istio-mixer-service-account
    namespace: istio-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: istio-system
  name: telemetry-envoy-config
  labels:
    release: istio
data:
  # Explicitly defined - moved from istio/istio/pilot/docker.
  envoy.yaml.tmpl: |-
    admin:
      access_log_path: /dev/null
      address:
        socket_address:
          address: 127.0.0.1
          port_value: 15000
    stats_config:
      use_all_default_tags: false
      stats_tags:
      - tag_name: cluster_name
        regex: '^cluster\.((.+?(\..+?\.svc\.cluster\.local)?)\.)'
      - tag_name: tcp_prefix
        regex: '^tcp\.((.*?)\.)\w+?$'
      - tag_name: response_code
        regex: '_rq(_(\d{3}))$'
      - tag_name: response_code_class
        regex: '_rq(_(\dxx))$'
      - tag_name: http_conn_manager_listener_prefix
        regex: '^listener(?=\.).*?\.http\.(((?:[_.[:digit:]]*|[_\[\]aAbBcCdDeEfF[:digit:]]*))\.)'
      - tag_name: http_conn_manager_prefix
        regex: '^http\.(((?:[_.[:digit:]]*|[_\[\]aAbBcCdDeEfF[:digit:]]*))\.)'
      - tag_name: listener_address
        regex: '^listener\.(((?:[_.[:digit:]]*|[_\[\]aAbBcCdDeEfF[:digit:]]*))\.)'

    static_resources:
      clusters:
      - name: prometheus_stats
        type: STATIC
        connect_timeout: 0.250s
        lb_policy: ROUND_ROBIN
        hosts:
        - socket_address:
            protocol: TCP
            address: 127.0.0.1
            port_value: 15000

      - name: inbound_9092
        circuit_breakers:
          thresholds:
          - max_connections: 100000
            max_pending_requests: 100000
            max_requests: 100000
            max_retries: 3
        connect_timeout: 1.000s
        hosts:
        - pipe:
            path: /sock/mixer.socket
        http2_protocol_options: {}

      - name: out.galley.15019
        http2_protocol_options: {}
        connect_timeout: 1.000s
        type: STRICT_DNS

        circuit_breakers:
          thresholds:
            - max_connections: 100000
              max_pending_requests: 100000
              max_requests: 100000
              max_retries: 3

        tls_context:
          common_tls_context:
            tls_certificates:
            - certificate_chain:
                filename: /etc/certs/cert-chain.pem
              private_key:
                filename: /etc/certs/key.pem
            validation_context:
              trusted_ca:
                filename: /etc/certs/root-cert.pem
              verify_subject_alt_name:
              - spiffe://cluster.local/ns/istio-system/sa/istio-galley-service-account

        hosts:
          - socket_address:
              address: istio-galley.istio-system
              port_value: 15019


      listeners:
      - name: "15090"
        address:
          socket_address:
            protocol: TCP
            address: 0.0.0.0
            port_value: 15090
        filter_chains:
        - filters:
          - name: envoy.http_connection_manager
            config:
              codec_type: AUTO
              stat_prefix: stats
              route_config:
                virtual_hosts:
                - name: backend
                  domains:
                  - '*'
                  routes:
                  - match:
                      prefix: /stats/prometheus
                    route:
                      cluster: prometheus_stats
              http_filters:
              - name: envoy.router

      - name: "15004"
        address:
          socket_address:
            address: 0.0.0.0
            port_value: 15004
        filter_chains:
        - filters:
          - config:
              codec_type: HTTP2
              http2_protocol_options:
                max_concurrent_streams: 1073741824
              generate_request_id: true
              http_filters:
              - config:
                  default_destination_service: istio-telemetry.istio-system.svc.cluster.local
                  service_configs:
                    istio-telemetry.istio-system.svc.cluster.local:
                      disable_check_calls: true
    {{- if .DisableReportCalls }}
                      disable_report_calls: true
    {{- end }}
                      mixer_attributes:
                        attributes:
                          destination.service.host:
                            string_value: istio-telemetry.istio-system.svc.cluster.local
                          destination.service.uid:
                            string_value: istio://istio-system/services/istio-telemetry
                          destination.service.name:
                            string_value: istio-telemetry
                          destination.service.namespace:
                            string_value: istio-system
                          destination.uid:
                            string_value: kubernetes://{{ .PodName }}.istio-system
                          destination.namespace:
                            string_value: istio-system
                          destination.ip:
                            bytes_value: {{ .PodIP }}
                          destination.port:
                            int64_value: 15004
                          context.reporter.kind:
                            string_value: inbound
                          context.reporter.uid:
                            string_value: kubernetes://{{ .PodName }}.istio-system
                  transport:
                    check_cluster: mixer_check_server
                    report_cluster: inbound_9092
                name: mixer
              - name: envoy.router
              route_config:
                name: "15004"
                virtual_hosts:
                - domains:
                  - '*'
                  name: istio-telemetry.istio-system.svc.cluster.local
                  routes:
                  - decorator:
                      operation: Report
                    match:
                      prefix: /
                    route:
                      cluster: inbound_9092
                      timeout: 0.000s
              stat_prefix: "15004"
            name: envoy.http_connection_manager
          tls_context:
            common_tls_context:
              alpn_protocols:
              - h2
              tls_certificates:
              - certificate_chain:
                  filename: /etc/certs/cert-chain.pem
                private_key:
                  filename: /etc/certs/key.pem
              validation_context:
                trusted_ca:
                  filename: /etc/certs/root-cert.pem
            require_client_certificate: true

      - name: "9091"
        address:
          socket_address:
            address: 0.0.0.0
            port_value: 9091
        filter_chains:
        - filters:
          - config:
              codec_type: HTTP2
              http2_protocol_options:
                max_concurrent_streams: 1073741824
              generate_request_id: true
              http_filters:
              - config:
                  default_destination_service: istio-telemetry.istio-system.svc.cluster.local
                  service_configs:
                    istio-telemetry.istio-system.svc.cluster.local:
                      disable_check_calls: true
    {{- if .DisableReportCalls }}
                      disable_report_calls: true
    {{- end }}
                      mixer_attributes:
                        attributes:
                          destination.service.host:
                            string_value: istio-telemetry.istio-system.svc.cluster.local
                          destination.service.uid:
                            string_value: istio://istio-system/services/istio-telemetry
                          destination.service.name:
                            string_value: istio-telemetry
                          destination.service.namespace:
                            string_value: istio-system
                          destination.uid:
                            string_value: kubernetes://{{ .PodName }}.istio-system
                          destination.namespace:
                            string_value: istio-system
                          destination.ip:
                            bytes_value: {{ .PodIP }}
                          destination.port:
                            int64_value: 9091
                          context.reporter.kind:
                            string_value: inbound
                          context.reporter.uid:
                            string_value: kubernetes://{{ .PodName }}.istio-system
                  transport:
                    check_cluster: mixer_check_server
                    report_cluster: inbound_9092
                name: mixer
              - name: envoy.router
              route_config:
                name: "9091"
                virtual_hosts:
                - domains:
                  - '*'
                  name: istio-telemetry.istio-system.svc.cluster.local
                  routes:
                  - decorator:
                      operation: Report
                    match:
                      prefix: /
                    route:
                      cluster: inbound_9092
                      timeout: 0.000s
              stat_prefix: "9091"
            name: envoy.http_connection_manager

      - name: "local.15019"
        address:
          socket_address:
            address: 127.0.0.1
            port_value: 15019
        filter_chains:
          - filters:
              - name: envoy.http_connection_manager
                config:
                  codec_type: HTTP2
                  stat_prefix: "15019"
                  stream_idle_timeout: 0s
                  http2_protocol_options:
                    max_concurrent_streams: 1073741824

                  access_log:
                    - name: envoy.file_access_log
                      config:
                        path: /dev/stdout

                  http_filters:
                    - name: envoy.router

                  route_config:
                    name: "15019"

                    virtual_hosts:
                      - name: istio-galley

                        domains:
                          - '*'

                        routes:
                          - match:
                              prefix: /
                            route:
                              cluster: out.galley.15019
                              timeout: 0.000s
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: istio-telemetry
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  host: istio-telemetry.istio-system.svc.cluster.local
  trafficPolicy:
    portLevelSettings:
    - port:
        number: 15004 # grpc-mixer-mtls
      tls:
        mode: ISTIO_MUTUAL
    - port:
        number: 9091 # grpc-mixer
      tls:
        mode: DISABLE
    connectionPool:
      http:
        http2MaxRequests: 10000
        maxRequestsPerConnection: 10000
---
apiVersion: autoscaling/v2beta1
kind: HorizontalPodAutoscaler
metadata:
  labels:
    app: mixer
    release: istio
  name: istio-telemetry
  namespace: istio-system
spec:
  maxReplicas: 5
  metrics:
  - resource:
      name: cpu
      targetAverageUtilization: 80
    type: Resource
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: istio-telemetry
---
apiVersion: policy/v1beta1
kind: PodDisruptionBudget
metadata:
  name: istio-telemetry
  namespace: istio-system
  labels:
    app: telemetry
    release: istio
    istio: mixer
    istio-mixer-type: telemetry
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: telemetry
      istio: mixer
      istio-mixer-type: telemetry
---
apiVersion: v1
kind: Service
metadata:
  name: istio-telemetry
  namespace: istio-system
  labels:
    app: mixer
    istio: mixer
    release: istio
spec:
  ports:
  - name: grpc-mixer
    port: 9091
  - name: grpc-mixer-mtls
    port: 15004
  - name: http-monitoring
    port: 15014
  - name: prometheus
    port: 42422
  selector:
    istio: mixer
    istio-mixer-type: telemetry
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: istio-mixer-service-account
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
---
apiVersion: "config.istio.io/v1alpha2"
kind: attributemanifest
metadata:
  name: istioproxy
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  attributes:
    origin.ip:
      valueType: IP_ADDRESS
    origin.uid:
      valueType: STRING
    origin.user:
      valueType: STRING
    request.headers:
      valueType: STRING_MAP
    request.id:
      valueType: STRING
    request.host:
      valueType: STRING
    request.method:
      valueType: STRING
    request.path:
      valueType: STRING
    request.url_path:
      valueType: STRING
    request.query_params:
      valueType: STRING_MAP
    request.reason:
      valueType: STRING
    request.referer:
      valueType: STRING
    request.scheme:
      valueType: STRING
    request.total_size:
      valueType: INT64
    request.size:
      valueType: INT64
    request.time:
      valueType: TIMESTAMP
    request.useragent:
      valueType: STRING
    response.code:
      valueType: INT64
    response.duration:
      valueType: DURATION
    response.headers:
      valueType: STRING_MAP
    response.total_size:
      valueType: INT64
    response.size:
      valueType: INT64
    response.time:
      valueType: TIMESTAMP
    response.grpc_status:
      valueType: STRING
    response.grpc_message:
      valueType: STRING
    source.uid:
      valueType: STRING
    source.user: # DEPRECATED
      valueType: STRING
    source.principal:
      valueType: STRING
    destination.uid:
      valueType: STRING
    destination.principal:
      valueType: STRING
    destination.port:
      valueType: INT64
    connection.event:
      valueType: STRING
    connection.id:
      valueType: STRING
    connection.received.bytes:
      valueType: INT64
    connection.received.bytes_total:
      valueType: INT64
    connection.sent.bytes:
      valueType: INT64
    connection.sent.bytes_total:
      valueType: INT64
    connection.duration:
      valueType: DURATION
    connection.mtls:
      valueType: BOOL
    connection.requested_server_name:
      valueType: STRING
    context.protocol:
      valueType: STRING
    context.proxy_error_code:
      valueType: STRING
    context.timestamp:
      valueType: TIMESTAMP
    context.time:
      valueType: TIMESTAMP
    # Deprecated, kept for compatibility
    context.reporter.local:
      valueType: BOOL
    context.reporter.kind:
      valueType: STRING
    context.reporter.uid:
      valueType: STRING
    context.proxy_version:
      valueType: STRING
    api.service:
      valueType: STRING
    api.version:
      valueType: STRING
    api.operation:
      valueType: STRING
    api.protocol:
      valueType: STRING
    request.auth.principal:
      valueType: STRING
    request.auth.audiences:
      valueType: STRING
    request.auth.presenter:
      valueType: STRING
    request.auth.claims:
      valueType: STRING_MAP
    request.auth.raw_claims:
      valueType: STRING
    request.api_key:
      valueType: STRING
    rbac.permissive.response_code:
      valueType: STRING
    rbac.permissive.effective_policy_id:
      valueType: STRING
    check.error_code:
      valueType: INT64
    check.error_message:
      valueType: STRING
    check.cache_hit:
      valueType: BOOL
    quota.cache_hit:
      valueType: BOOL
---
apiVersion: "config.istio.io/v1alpha2"
kind: attributemanifest
metadata:
  name: kubernetes
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  attributes:
    source.ip:
      valueType: IP_ADDRESS
    source.labels:
      valueType: STRING_MAP
    source.metadata:
      valueType: STRING_MAP
    source.name:
      valueType: STRING
    source.namespace:
      valueType: STRING
    source.owner:
      valueType: STRING
    source.serviceAccount:
      valueType: STRING
    source.services:
      valueType: STRING
    source.workload.uid:
      valueType: STRING
    source.workload.name:
      valueType: STRING
    source.workload.namespace:
      valueType: STRING
    destination.ip:
      valueType: IP_ADDRESS
    destination.labels:
      valueType: STRING_MAP
    destination.metadata:
      valueType: STRING_MAP
    destination.owner:
      valueType: STRING
    destination.name:
      valueType: STRING
    destination.container.name:
      valueType: STRING
    destination.namespace:
      valueType: STRING
    destination.service.uid:
      valueType: STRING
    destination.service.name:
      valueType: STRING
    destination.service.namespace:
      valueType: STRING
    destination.service.host:
      valueType: STRING
    destination.serviceAccount:
      valueType: STRING
    destination.workload.uid:
      valueType: STRING
    destination.workload.name:
      valueType: STRING
    destination.workload.namespace:
      valueType: STRING
---
apiVersion: "config.istio.io/v1alpha2"
kind: handler
metadata:
  name: kubernetesenv
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  compiledAdapter: kubernetesenv
  params: {}
    # when running from mixer root, use the following config after adding a
    # symbolic link to a kubernetes config file via:
    #
    # $ ln -s ~/.kube/config mixer/adapter/kubernetes/kubeconfig
    #
    # kubeconfig_path: "mixer/adapter/kubernetes/kubeconfig"
---
apiVersion: "config.istio.io/v1alpha2"
kind: instance
metadata:
  name: attributes
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  compiledTemplate: kubernetes
  params:
    # Pass the required attribute data to the adapter
    source_uid: source.uid | ""
    source_ip: source.ip | ip("0.0.0.0") # default to unspecified ip addr
    destination_uid: destination.uid | ""
    destination_port: destination.port | 0
  attributeBindings:
    # Fill the new attributes from the adapter produced output.
    # $out refers to an instance of OutputTemplate message
    source.ip: $out.source_pod_ip | ip("0.0.0.0")
    source.uid: $out.source_pod_uid | "unknown"
    source.labels: $out.source_labels | emptyStringMap()
    source.name: $out.source_pod_name | "unknown"
    source.namespace: $out.source_namespace | "default"
    source.owner: $out.source_owner | "unknown"
    source.serviceAccount: $out.source_service_account_name | "unknown"
    source.workload.uid: $out.source_workload_uid | "unknown"
    source.workload.name: $out.source_workload_name | "unknown"
    source.workload.namespace: $out.source_workload_namespace | "unknown"
    destination.ip: $out.destination_pod_ip | ip("0.0.0.0")
    destination.uid: $out.destination_pod_uid | "unknown"
    destination.labels: $out.destination_labels | emptyStringMap()
    destination.name: $out.destination_pod_name | "unknown"
    destination.container.name: $out.destination_container_name | "unknown"
    destination.namespace: $out.destination_namespace | "default"
    destination.owner: $out.destination_owner | "unknown"
    destination.serviceAccount: $out.destination_service_account_name | "unknown"
    destination.workload.uid: $out.destination_workload_uid | "unknown"
    destination.workload.name: $out.destination_workload_name | "unknown"
    destination.workload.namespace: $out.destination_workload_namespace | "unknown"
---
apiVersion: "config.istio.io/v1alpha2"
kind: instance
metadata:
  name: requestcount
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  compiledTemplate: metric
  params:
    value: "1"
    dimensions:
      reporter: conditional((context.reporter.kind | "inbound") == "outbound", "source", "destination")
      source_workload: source.workload.name | "unknown"
      source_workload_namespace: source.workload.namespace | "unknown"
      source_principal: source.principal | "unknown"
      source_app: source.labels["app"] | "unknown"
      source_version: source.labels["version"] | "unknown"
      destination_workload: destination.workload.name | "unknown"
      destination_workload_namespace: destination.workload.namespace | "unknown"
      destination_principal: destination.principal | "unknown"
      destination_app: destination.labels["app"] | "unknown"
      destination_version: destination.labels["version"] | "unknown"
      destination_service: destination.service.host | conditional((destination.service.name | "unknown") == "unknown", "unknown", request.host)
      destination_service_name: destination.service.name | "unknown"
      destination_service_namespace: destination.service.namespace | "unknown"
      request_protocol: api.protocol | context.protocol | "unknown"
      response_code: response.code | 200
      grpc_response_status: response.grpc_status | ""
      response_flags: context.proxy_error_code | "-"
      connection_security_policy: conditional((context.reporter.kind | "inbound") == "outbound", "unknown", conditional(connection.mtls | false, "mutual_tls", "none"))
    monitored_resource_type: '"UNSPECIFIED"'
---
apiVersion: "config.istio.io/v1alpha2"
kind: instance
metadata:
  name: requestduration
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  compiledTemplate: metric
  params:
    value: response.duration | "0ms"
    dimensions:
      reporter: conditional((context.reporter.kind | "inbound") == "outbound", "source", "destination")
      source_workload: source.workload.name | "unknown"
      source_workload_namespace: source.workload.namespace | "unknown"
      source_principal: source.principal | "unknown"
      source_app: source.labels["app"] | "unknown"
      source_version: source.labels["version"] | "unknown"
      destination_workload: destination.workload.name | "unknown"
      destination_workload_namespace: destination.workload.namespace | "unknown"
      destination_principal: destination.principal | "unknown"
      destination_app: destination.labels["app"] | "unknown"
      destination_version: destination.labels["version"] | "unknown"
      destination_service: destination.service.host | conditional((destination.service.name | "unknown") == "unknown", "unknown", request.host)
      destination_service_name: destination.service.name | "unknown"
      destination_service_namespace: destination.service.namespace | "unknown"
      request_protocol: api.protocol | context.protocol | "unknown"
      response_code: response.code | 200
      grpc_response_status: response.grpc_status | ""
      response_flags: context.proxy_error_code | "-"
      connection_security_policy: conditional((context.reporter.kind | "inbound") == "outbound", "unknown", conditional(connection.mtls | false, "mutual_tls", "none"))
    monitored_resource_type: '"UNSPECIFIED"'
---
apiVersion: "config.istio.io/v1alpha2"
kind: instance
metadata:
  name: requestsize
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  compiledTemplate: metric
  params:
    value: request.size | 0
    dimensions:
      reporter: conditional((context.reporter.kind | "inbound") == "outbound", "source", "destination")
      source_workload: source.workload.name | "unknown"
      source_workload_namespace: source.workload.namespace | "unknown"
      source_principal: source.principal | "unknown"
      source_app: source.labels["app"] | "unknown"
      source_version: source.labels["version"] | "unknown"
      destination_workload: destination.workload.name | "unknown"
      destination_workload_namespace: destination.workload.namespace | "unknown"
      destination_principal: destination.principal | "unknown"
      destination_app: destination.labels["app"] | "unknown"
      destination_version: destination.labels["version"] | "unknown"
      destination_service: destination.service.host | conditional((destination.service.name | "unknown") == "unknown", "unknown", request.host)
      destination_service_name: destination.service.name | "unknown"
      destination_service_namespace: destination.service.namespace | "unknown"
      request_protocol: api.protocol | context.protocol | "unknown"
      response_code: response.code | 200
      grpc_response_status: response.grpc_status | ""
      response_flags: context.proxy_error_code | "-"
      connection_security_policy: conditional((context.reporter.kind | "inbound") == "outbound", "unknown", conditional(connection.mtls | false, "mutual_tls", "none"))
    monitored_resource_type: '"UNSPECIFIED"'
---
apiVersion: "config.istio.io/v1alpha2"
kind: instance
metadata:
  name: responsesize
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  compiledTemplate: metric
  params:
    value: response.size | 0
    dimensions:
      reporter: conditional((context.reporter.kind | "inbound") == "outbound", "source", "destination")
      source_workload: source.workload.name | "unknown"
      source_workload_namespace: source.workload.namespace | "unknown"
      source_principal: source.principal | "unknown"
      source_app: source.labels["app"] | "unknown"
      source_version: source.labels["version"] | "unknown"
      destination_workload: destination.workload.name | "unknown"
      destination_workload_namespace: destination.workload.namespace | "unknown"
      destination_principal: destination.principal | "unknown"
      destination_app: destination.labels["app"] | "unknown"
      destination_version: destination.labels["version"] | "unknown"
      destination_service: destination.service.host | conditional((destination.service.name | "unknown") == "unknown", "unknown", request.host)
      destination_service_name: destination.service.name | "unknown"
      destination_service_namespace: destination.service.namespace | "unknown"
      request_protocol: api.protocol | context.protocol | "unknown"
      response_code: response.code | 200
      grpc_response_status: response.grpc_status | ""
      response_flags: context.proxy_error_code | "-"
      connection_security_policy: conditional((context.reporter.kind | "inbound") == "outbound", "unknown", conditional(connection.mtls | false, "mutual_tls", "none"))
    monitored_resource_type: '"UNSPECIFIED"'
---
apiVersion: "config.istio.io/v1alpha2"
kind: instance
metadata:
  name: tcpbytereceived
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  compiledTemplate: metric
  params:
    value: connection.received.bytes | 0
    dimensions:
      reporter: conditional((context.reporter.kind | "inbound") == "outbound", "source", "destination")
      source_workload: source.workload.name | "unknown"
      source_workload_namespace: source.workload.namespace | "unknown"
      source_principal: source.principal | "unknown"
      source_app: source.labels["app"] | "unknown"
      source_version: source.labels["version"] | "unknown"
      destination_workload: destination.workload.name | "unknown"
      destination_workload_namespace: destination.workload.namespace | "unknown"
      destination_principal: destination.principal | "unknown"
      destination_app: destination.labels["app"] | "unknown"
      destination_version: destination.labels["version"] | "unknown"
      destination_service: destination.service.host | "unknown"
      destination_service_name: destination.service.name | "unknown"
      destination_service_namespace: destination.service.namespace | "unknown"
      connection_security_policy: conditional((context.reporter.kind | "inbound") == "outbound", "unknown", conditional(connection.mtls | false, "mutual_tls", "none"))
      response_flags: context.proxy_error_code | "-"
    monitored_resource_type: '"UNSPECIFIED"'
---
apiVersion: "config.istio.io/v1alpha2"
kind: instance
metadata:
  name: tcpbytesent
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  compiledTemplate: metric
  params:
    value: connection.sent.bytes | 0
    dimensions:
      reporter: conditional((context.reporter.kind | "inbound") == "outbound", "source", "destination")
      source_workload: source.workload.name | "unknown"
      source_workload_namespace: source.workload.namespace | "unknown"
      source_principal: source.principal | "unknown"
      source_app: source.labels["app"] | "unknown"
      source_version: source.labels["version"] | "unknown"
      destination_workload: destination.workload.name | "unknown"
      destination_workload_namespace: destination.workload.namespace | "unknown"
      destination_principal: destination.principal | "unknown"
      destination_app: destination.labels["app"] | "unknown"
      destination_version: destination.labels["version"] | "unknown"
      destination_service: destination.service.host | "unknown"
      destination_service_name: destination.service.name | "unknown"
      destination_service_namespace: destination.service.namespace | "unknown"
      connection_security_policy: conditional((context.reporter.kind | "inbound") == "outbound", "unknown", conditional(connection.mtls | false, "mutual_tls", "none"))
      response_flags: context.proxy_error_code | "-"
    monitored_resource_type: '"UNSPECIFIED"'
---
apiVersion: "config.istio.io/v1alpha2"
kind: instance
metadata:
  name: tcpconnectionsclosed
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  compiledTemplate: metric
  params:
    value: "1"
    dimensions:
      reporter: conditional((context.reporter.kind | "inbound") == "outbound", "source", "destination")
      source_workload: source.workload.name | "unknown"
      source_workload_namespace: source.workload.namespace | "unknown"
      source_principal: source.principal | "unknown"
      source_app: source.labels["app"] | "unknown"
      source_version: source.labels["version"] | "unknown"
      destination_workload: destination.workload.name | "unknown"
      destination_workload_namespace: destination.workload.namespace | "unknown"
      destination_principal: destination.principal | "unknown"
      destination_app: destination.labels["app"] | "unknown"
      destination_version: destination.labels["version"] | "unknown"
      destination_service: destination.service.host | "unknown"
      destination_service_name: destination.service.name | "unknown"
      destination_service_namespace: destination.service.namespace | "unknown"
      connection_security_policy: conditional((context.reporter.kind | "inbound") == "outbound", "unknown", conditional(connection.mtls | false, "mutual_tls", "none"))
      response_flags: context.proxy_error_code | "-"
    monitored_resource_type: '"UNSPECIFIED"'
---
apiVersion: "config.istio.io/v1alpha2"
kind: instance
metadata:
  name: tcpconnectionsopened
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  compiledTemplate: metric
  params:
    value: "1"
    dimensions:
      reporter: conditional((context.reporter.kind | "inbound") == "outbound", "source", "destination")
      source_workload: source.workload.name | "unknown"
      source_workload_namespace: source.workload.namespace | "unknown"
      source_principal: source.principal | "unknown"
      source_app: source.labels["app"] | "unknown"
      source_version: source.labels["version"] | "unknown"
      destination_workload: destination.workload.name | "unknown"
      destination_workload_namespace: destination.workload.namespace | "unknown"
      destination_principal: destination.principal | "unknown"
      destination_app: destination.labels["app"] | "unknown"
      destination_version: destination.labels["version"] | "unknown"
      destination_service: destination.service.host | "unknown"
      destination_service_name: destination.service.name | "unknown"
      destination_service_namespace: destination.service.namespace | "unknown"
      connection_security_policy: conditional((context.reporter.kind | "inbound") == "outbound", "unknown", conditional(connection.mtls | false, "mutual_tls", "none"))
      response_flags: context.proxy_error_code | "-"
    monitored_resource_type: '"UNSPECIFIED"'
---
apiVersion: "config.istio.io/v1alpha2"
kind: rule
metadata:
  name: kubeattrgenrulerule
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  actions:
  - handler: kubernetesenv
    instances:
    - attributes
---
apiVersion: "config.istio.io/v1alpha2"
kind: rule
metadata:
  name: promhttp
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  match: (context.protocol == "http" || context.protocol == "grpc") && (match((request.useragent | "-"), "kube-probe*") == false) && (match((request.useragent | "-"), "Prometheus*") == false)
  actions:
  - handler: prometheus
    instances:
    - requestcount
    - requestduration
    - requestsize
    - responsesize
---
apiVersion: "config.istio.io/v1alpha2"
kind: rule
metadata:
  name: promtcp
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  match: context.protocol == "tcp"
  actions:
  - handler: prometheus
    instances:
    - tcpbytesent
    - tcpbytereceived
---
apiVersion: "config.istio.io/v1alpha2"
kind: rule
metadata:
  name: promtcpconnectionclosed
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  match: context.protocol == "tcp" && ((connection.event | "na") == "close")
  actions:
  - handler: prometheus
    instances:
    - tcpconnectionsclosed
---
apiVersion: "config.istio.io/v1alpha2"
kind: rule
metadata:
  name: promtcpconnectionopen
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  match: context.protocol == "tcp" && ((connection.event | "na") == "open")
  actions:
  - handler: prometheus
    instances:
    - tcpconnectionsopened
---
apiVersion: "config.istio.io/v1alpha2"
kind: rule
metadata:
  name: tcpkubeattrgenrulerule
  namespace: istio-system
  labels:
    app: istio-telemetry
    release: istio
spec:
  match: context.protocol == "tcp"
  actions:
  - handler: kubernetesenv
    instances:
    - attributes
---


2020-03-03T12:20:03.500065Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:03.500123Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:03.873884Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:03.874319Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:04.383016Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:04.383074Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:04.900590Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:04.900706Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:05.436081Z	info	installer	ReadProfileYAML for profile name: empty
2020-03-03T12:20:05.436114Z	info	installer	Loading values from compiled in VFS at path profiles/empty.yaml
2020-03-03T12:20:05.436135Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:05.436154Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:05.582845Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:05.583023Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:05.589489Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:05.589612Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:06.038973Z	info	Input file has IstioControlPlane format.
Using operator Deployment image: foo.io/istio/operator:1.2.3
2020-03-03T12:20:06.113121Z	info	installer	Installing operator charts with the following values:

operatorNamespace: operator-test-namespace
istioNamespace: istio-test-namespace
hub: foo.io/istio
tag: 1.2.3

2020-03-03T12:20:06.113731Z	info	installer	Using the following manifest to install operator:
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  creationTimestamp: null
  name: istio-operator
rules:
# istio groups
- apiGroups:
  - authentication.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - config.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - install.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - networking.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - rbac.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - security.istio.io
  resources:
  - '*'
  verbs:
  - '*'
# k8s groups
- apiGroups:
  - admissionregistration.k8s.io
  resources:
  - mutatingwebhookconfigurations
  - validatingwebhookconfigurations
  verbs:
  - '*'
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions.apiextensions.k8s.io
  - customresourcedefinitions
  verbs:
  - '*'
- apiGroups:
  - apps
  - extensions
  resources:
  - daemonsets
  - deployments
  - deployments/finalizers
  - ingresses
  - replicasets
  - statefulsets
  verbs:
  - '*'
- apiGroups:
  - autoscaling
  resources:
  - horizontalpodautoscalers
  verbs:
  - '*'
- apiGroups:
  - monitoring.coreos.com
  resources:
  - servicemonitors
  verbs:
  - get
  - create
- apiGroups:
  - policy
  resources:
  - poddisruptionbudgets
  verbs:
  - '*'
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  - clusterrolebindings
  - clusterroles
  - roles
  - rolebindings
  verbs:
  - '*'
- apiGroups:
  - ""
  resources:
  - configmaps
  - endpoints
  - events
  - namespaces
  - pods
  - persistentvolumeclaims
  - secrets
  - services
  - serviceaccounts
  verbs:
  - '*'
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: istio-operator
subjects:
- kind: ServiceAccount
  name: istio-operator
  namespace: operator-test-namespace
roleRef:
  kind: ClusterRole
  name: istio-operator
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: istiooperators.install.istio.io
spec:
  group: install.istio.io
  names:
    kind: IstioOperator
    plural: istiooperators
    singular: istiooperator
    shortNames:
    - iop
  scope: Namespaced
  subresources:
    status: {}
  validation:
    openAPIV3Schema:
      properties:
        apiVersion:
          description: 'APIVersion defines the versioned schema of this representation
            of an object. Servers should convert recognized schemas to the latest
            internal value, and may reject unrecognized values.
            More info: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#resources'
          type: string
        kind:
          description: 'Kind is a string value representing the REST resource this
            object represents. Servers may infer this from the endpoint the client
            submits requests to. Cannot be updated. In CamelCase.
            More info: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
          type: string
        spec:
          description: 'Specification of the desired state of the istio control plane resource.
            More info: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status'
          type: object
        status:
          description: 'Status describes each of istio control plane component status at the current time.
            0 means NONE, 1 means UPDATING, 2 means HEALTHY, 3 means ERROR, 4 means RECONCILING.
            More info: https://github.com/istio/api/blob/master/operator/v1alpha1/istio.operator.v1alpha1.pb.html &
            https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status'
          type: object
  versions:
  - name: v1alpha1
    served: true
    storage: true
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: operator-test-namespace
  name: istio-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      name: istio-operator
  template:
    metadata:
      labels:
        name: istio-operator
    spec:
      serviceAccountName: istio-operator
      containers:
        - name: istio-operator
          image: foo.io/istio/operator:1.2.3
          command:
          - operator
          - server
          imagePullPolicy: IfNotPresent
          resources:
            limits:
              cpu: 200m
              memory: 256Mi
            requests:
              cpu: 50m
              memory: 128Mi
          env:
            - name: WATCH_NAMESPACE
              value: istio-test-namespace
            - name: LEADER_ELECTION_NAMESPACE
              value: operator-test-namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: OPERATOR_NAME
              value: operator-test-namespace
---
apiVersion: v1
kind: Namespace
metadata:
  name: istio-operator
  labels:
    istio-operator-managed: Reconcile
    istio-injection: disabled
---
apiVersion: v1
kind: Service
metadata:
  namespace: operator-test-namespace
  labels:
    name: istio-operator
  name: istio-operator
spec:
  ports:
  - name: http-metrics
    port: 8383
    targetPort: 8383
  selector:
    name: istio-operator
---
apiVersion: v1
kind: ServiceAccount
metadata:
  namespace: operator-test-namespace
  name: istio-operator
---



*** Success. ***

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  creationTimestamp: null
  name: istio-operator
rules:
# istio groups
- apiGroups:
  - authentication.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - config.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - install.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - networking.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - rbac.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - security.istio.io
  resources:
  - '*'
  verbs:
  - '*'
# k8s groups
- apiGroups:
  - admissionregistration.k8s.io
  resources:
  - mutatingwebhookconfigurations
  - validatingwebhookconfigurations
  verbs:
  - '*'
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions.apiextensions.k8s.io
  - customresourcedefinitions
  verbs:
  - '*'
- apiGroups:
  - apps
  - extensions
  resources:
  - daemonsets
  - deployments
  - deployments/finalizers
  - ingresses
  - replicasets
  - statefulsets
  verbs:
  - '*'
- apiGroups:
  - autoscaling
  resources:
  - horizontalpodautoscalers
  verbs:
  - '*'
- apiGroups:
  - monitoring.coreos.com
  resources:
  - servicemonitors
  verbs:
  - get
  - create
- apiGroups:
  - policy
  resources:
  - poddisruptionbudgets
  verbs:
  - '*'
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  - clusterrolebindings
  - clusterroles
  - roles
  - rolebindings
  verbs:
  - '*'
- apiGroups:
  - ""
  resources:
  - configmaps
  - endpoints
  - events
  - namespaces
  - pods
  - persistentvolumeclaims
  - secrets
  - services
  - serviceaccounts
  verbs:
  - '*'
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: istio-operator
subjects:
- kind: ServiceAccount
  name: istio-operator
  namespace: operator-test-namespace
roleRef:
  kind: ClusterRole
  name: istio-operator
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: istiooperators.install.istio.io
spec:
  group: install.istio.io
  names:
    kind: IstioOperator
    plural: istiooperators
    singular: istiooperator
    shortNames:
    - iop
  scope: Namespaced
  subresources:
    status: {}
  validation:
    openAPIV3Schema:
      properties:
        apiVersion:
          description: 'APIVersion defines the versioned schema of this representation
            of an object. Servers should convert recognized schemas to the latest
            internal value, and may reject unrecognized values.
            More info: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#resources'
          type: string
        kind:
          description: 'Kind is a string value representing the REST resource this
            object represents. Servers may infer this from the endpoint the client
            submits requests to. Cannot be updated. In CamelCase.
            More info: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
          type: string
        spec:
          description: 'Specification of the desired state of the istio control plane resource.
            More info: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status'
          type: object
        status:
          description: 'Status describes each of istio control plane component status at the current time.
            0 means NONE, 1 means UPDATING, 2 means HEALTHY, 3 means ERROR, 4 means RECONCILING.
            More info: https://github.com/istio/api/blob/master/operator/v1alpha1/istio.operator.v1alpha1.pb.html &
            https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status'
          type: object
  versions:
  - name: v1alpha1
    served: true
    storage: true
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: operator-test-namespace
  name: istio-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      name: istio-operator
  template:
    metadata:
      labels:
        name: istio-operator
    spec:
      serviceAccountName: istio-operator
      containers:
        - name: istio-operator
          image: foo.io/istio/operator:1.2.3
          command:
          - operator
          - server
          imagePullPolicy: IfNotPresent
          resources:
            limits:
              cpu: 200m
              memory: 256Mi
            requests:
              cpu: 50m
              memory: 128Mi
          env:
            - name: WATCH_NAMESPACE
              value: istio-test-namespace
            - name: LEADER_ELECTION_NAMESPACE
              value: operator-test-namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: OPERATOR_NAME
              value: operator-test-namespace
---
apiVersion: v1
kind: Namespace
metadata:
  name: istio-operator
  labels:
    istio-operator-managed: Reconcile
    istio-injection: disabled
---
apiVersion: v1
kind: Service
metadata:
  namespace: operator-test-namespace
  labels:
    name: istio-operator
  name: istio-operator
spec:
  ports:
  - name: http-metrics
    port: 8383
    targetPort: 8383
  selector:
    name: istio-operator
---
apiVersion: v1
kind: ServiceAccount
metadata:
  namespace: operator-test-namespace
  name: istio-operator
---

Operator controller is not installed in operator-test-namespace namespace (no Deployment detected).
Using operator Deployment image: foo.io/istio/operator:1.2.3
2020-03-03T12:20:06.121985Z	info	installer	Installing operator charts with the following values:

operatorNamespace: operator-test-namespace
istioNamespace: istio-test-namespace
hub: foo.io/istio
tag: 1.2.3

2020-03-03T12:20:06.122912Z	info	installer	Using the following manifest to remove operator:
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  creationTimestamp: null
  name: istio-operator
rules:
# istio groups
- apiGroups:
  - authentication.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - config.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - install.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - networking.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - rbac.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - security.istio.io
  resources:
  - '*'
  verbs:
  - '*'
# k8s groups
- apiGroups:
  - admissionregistration.k8s.io
  resources:
  - mutatingwebhookconfigurations
  - validatingwebhookconfigurations
  verbs:
  - '*'
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions.apiextensions.k8s.io
  - customresourcedefinitions
  verbs:
  - '*'
- apiGroups:
  - apps
  - extensions
  resources:
  - daemonsets
  - deployments
  - deployments/finalizers
  - ingresses
  - replicasets
  - statefulsets
  verbs:
  - '*'
- apiGroups:
  - autoscaling
  resources:
  - horizontalpodautoscalers
  verbs:
  - '*'
- apiGroups:
  - monitoring.coreos.com
  resources:
  - servicemonitors
  verbs:
  - get
  - create
- apiGroups:
  - policy
  resources:
  - poddisruptionbudgets
  verbs:
  - '*'
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  - clusterrolebindings
  - clusterroles
  - roles
  - rolebindings
  verbs:
  - '*'
- apiGroups:
  - ""
  resources:
  - configmaps
  - endpoints
  - events
  - namespaces
  - pods
  - persistentvolumeclaims
  - secrets
  - services
  - serviceaccounts
  verbs:
  - '*'
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: istio-operator
subjects:
- kind: ServiceAccount
  name: istio-operator
  namespace: operator-test-namespace
roleRef:
  kind: ClusterRole
  name: istio-operator
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: istiooperators.install.istio.io
spec:
  group: install.istio.io
  names:
    kind: IstioOperator
    plural: istiooperators
    singular: istiooperator
    shortNames:
    - iop
  scope: Namespaced
  subresources:
    status: {}
  validation:
    openAPIV3Schema:
      properties:
        apiVersion:
          description: 'APIVersion defines the versioned schema of this representation
            of an object. Servers should convert recognized schemas to the latest
            internal value, and may reject unrecognized values.
            More info: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#resources'
          type: string
        kind:
          description: 'Kind is a string value representing the REST resource this
            object represents. Servers may infer this from the endpoint the client
            submits requests to. Cannot be updated. In CamelCase.
            More info: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
          type: string
        spec:
          description: 'Specification of the desired state of the istio control plane resource.
            More info: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status'
          type: object
        status:
          description: 'Status describes each of istio control plane component status at the current time.
            0 means NONE, 1 means UPDATING, 2 means HEALTHY, 3 means ERROR, 4 means RECONCILING.
            More info: https://github.com/istio/api/blob/master/operator/v1alpha1/istio.operator.v1alpha1.pb.html &
            https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status'
          type: object
  versions:
  - name: v1alpha1
    served: true
    storage: true
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: operator-test-namespace
  name: istio-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      name: istio-operator
  template:
    metadata:
      labels:
        name: istio-operator
    spec:
      serviceAccountName: istio-operator
      containers:
        - name: istio-operator
          image: foo.io/istio/operator:1.2.3
          command:
          - operator
          - server
          imagePullPolicy: IfNotPresent
          resources:
            limits:
              cpu: 200m
              memory: 256Mi
            requests:
              cpu: 50m
              memory: 128Mi
          env:
            - name: WATCH_NAMESPACE
              value: istio-test-namespace
            - name: LEADER_ELECTION_NAMESPACE
              value: operator-test-namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: OPERATOR_NAME
              value: operator-test-namespace
---
apiVersion: v1
kind: Namespace
metadata:
  name: istio-operator
  labels:
    istio-operator-managed: Reconcile
    istio-injection: disabled
---
apiVersion: v1
kind: Service
metadata:
  namespace: operator-test-namespace
  labels:
    name: istio-operator
  name: istio-operator
spec:
  ports:
  - name: http-metrics
    port: 8383
    targetPort: 8383
  selector:
    name: istio-operator
---
apiVersion: v1
kind: ServiceAccount
metadata:
  namespace: operator-test-namespace
  name: istio-operator
---



*** Success. ***

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  creationTimestamp: null
  name: istio-operator
rules:
# istio groups
- apiGroups:
  - authentication.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - config.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - install.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - networking.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - rbac.istio.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - security.istio.io
  resources:
  - '*'
  verbs:
  - '*'
# k8s groups
- apiGroups:
  - admissionregistration.k8s.io
  resources:
  - mutatingwebhookconfigurations
  - validatingwebhookconfigurations
  verbs:
  - '*'
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions.apiextensions.k8s.io
  - customresourcedefinitions
  verbs:
  - '*'
- apiGroups:
  - apps
  - extensions
  resources:
  - daemonsets
  - deployments
  - deployments/finalizers
  - ingresses
  - replicasets
  - statefulsets
  verbs:
  - '*'
- apiGroups:
  - autoscaling
  resources:
  - horizontalpodautoscalers
  verbs:
  - '*'
- apiGroups:
  - monitoring.coreos.com
  resources:
  - servicemonitors
  verbs:
  - get
  - create
- apiGroups:
  - policy
  resources:
  - poddisruptionbudgets
  verbs:
  - '*'
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  - clusterrolebindings
  - clusterroles
  - roles
  - rolebindings
  verbs:
  - '*'
- apiGroups:
  - ""
  resources:
  - configmaps
  - endpoints
  - events
  - namespaces
  - pods
  - persistentvolumeclaims
  - secrets
  - services
  - serviceaccounts
  verbs:
  - '*'
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: istio-operator
subjects:
- kind: ServiceAccount
  name: istio-operator
  namespace: operator-test-namespace
roleRef:
  kind: ClusterRole
  name: istio-operator
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: istiooperators.install.istio.io
spec:
  group: install.istio.io
  names:
    kind: IstioOperator
    plural: istiooperators
    singular: istiooperator
    shortNames:
    - iop
  scope: Namespaced
  subresources:
    status: {}
  validation:
    openAPIV3Schema:
      properties:
        apiVersion:
          description: 'APIVersion defines the versioned schema of this representation
            of an object. Servers should convert recognized schemas to the latest
            internal value, and may reject unrecognized values.
            More info: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#resources'
          type: string
        kind:
          description: 'Kind is a string value representing the REST resource this
            object represents. Servers may infer this from the endpoint the client
            submits requests to. Cannot be updated. In CamelCase.
            More info: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
          type: string
        spec:
          description: 'Specification of the desired state of the istio control plane resource.
            More info: https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status'
          type: object
        status:
          description: 'Status describes each of istio control plane component status at the current time.
            0 means NONE, 1 means UPDATING, 2 means HEALTHY, 3 means ERROR, 4 means RECONCILING.
            More info: https://github.com/istio/api/blob/master/operator/v1alpha1/istio.operator.v1alpha1.pb.html &
            https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status'
          type: object
  versions:
  - name: v1alpha1
    served: true
    storage: true
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: operator-test-namespace
  name: istio-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      name: istio-operator
  template:
    metadata:
      labels:
        name: istio-operator
    spec:
      serviceAccountName: istio-operator
      containers:
        - name: istio-operator
          image: foo.io/istio/operator:1.2.3
          command:
          - operator
          - server
          imagePullPolicy: IfNotPresent
          resources:
            limits:
              cpu: 200m
              memory: 256Mi
            requests:
              cpu: 50m
              memory: 128Mi
          env:
            - name: WATCH_NAMESPACE
              value: istio-test-namespace
            - name: LEADER_ELECTION_NAMESPACE
              value: operator-test-namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: OPERATOR_NAME
              value: operator-test-namespace
---
apiVersion: v1
kind: Namespace
metadata:
  name: istio-operator
  labels:
    istio-operator-managed: Reconcile
    istio-injection: disabled
---
apiVersion: v1
kind: Service
metadata:
  namespace: operator-test-namespace
  labels:
    name: istio-operator
  name: istio-operator
spec:
  ports:
  - name: http-metrics
    port: 8383
    targetPort: 8383
  selector:
    name: istio-operator
---
apiVersion: v1
kind: ServiceAccount
metadata:
  namespace: operator-test-namespace
  name: istio-operator
---

2020-03-03T12:20:06.132148Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:06.132201Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
2020-03-03T12:20:06.228322Z	info	installer	ReadProfileYAML for profile name: default
2020-03-03T12:20:06.228377Z	info	installer	Loading values from compiled in VFS at path profiles/default.yaml
--- FAIL: TestProfileDump (0.16s)
    --- FAIL: TestProfileDump/all_off (0.09s)
        profile-dump_test.go:61: profile-dump command(all_off): got:
            apiVersion: install.istio.io/v1alpha1
            kind: IstioOperator
            spec:
              addonComponents:
                grafana:
                  enabled: false
                  k8s:
                    replicaCount: 1
                istiocoredns:
                  enabled: false
                kiali:
                  enabled: false
                  k8s:
                    replicaCount: 1
                prometheus:
                  enabled: true
                  k8s:
                    replicaCount: 1
                tracing:
                  enabled: false
              components:
                base:
                  enabled: true
                citadel:
                  enabled: false
                  k8s:
                    strategy:
                      rollingUpdate:
                        maxSurge: 100%
                        maxUnavailable: 25%
                cni:
                  enabled: false
                egressGateways:
                - enabled: false
                  k8s:
                    hpaSpec:
                      maxReplicas: 5
                      metrics:
                      - resource:
                          name: cpu
                          targetAverageUtilization: 80
                        type: Resource
                      minReplicas: 1
                      scaleTargetRef:
                        apiVersion: apps/v1
                        kind: Deployment
                        name: istio-ingressgateway
                    resources:
                      limits:
                        cpu: 2000m
                        memory: 1024Mi
                      requests:
                        cpu: 100m
                        memory: 128Mi
                    strategy:
                      rollingUpdate:
                        maxSurge: 100%
                        maxUnavailable: 25%
                  name: istio-egressgateway
                galley:
                  enabled: false
                  k8s:
                    replicaCount: 1
                    resources:
                      requests:
                        cpu: 100m
                    strategy:
                      rollingUpdate:
                        maxSurge: 100%
                        maxUnavailable: 25%
                ingressGateways:
                - enabled: true
                  k8s:
                    hpaSpec:
                      maxReplicas: 5
                      metrics:
                      - resource:
                          name: cpu
                          targetAverageUtilization: 80
                        type: Resource
                      minReplicas: 1
                      scaleTargetRef:
                        apiVersion: apps/v1
                        kind: Deployment
                        name: istio-ingressgateway
                    resources:
                      limits:
                        cpu: 2000m
                        memory: 1024Mi
                      requests:
                        cpu: 100m
                        memory: 128Mi
                    strategy:
                      rollingUpdate:
                        maxSurge: 100%
                        maxUnavailable: 25%
                  name: istio-ingressgateway
                pilot:
                  enabled: false
                  k8s:
                    env:
                    - name: POD_NAME
                      valueFrom:
                        fieldRef:
                          apiVersion: v1
                          fieldPath: metadata.name
                    - name: POD_NAMESPACE
                      valueFrom:
                        fieldRef:
                          apiVersion: v1
                          fieldPath: metadata.namespace
                    readinessProbe:
                      httpGet:
                        path: /ready
                        port: 8080
                      initialDelaySeconds: 5
                      periodSeconds: 5
                      timeoutSeconds: 5
                    strategy:
                      rollingUpdate:
                        maxSurge: 100%
                        maxUnavailable: 25%
                policy:
                  enabled: false
                  k8s:
                    env:
                    - name: POD_NAMESPACE
                      valueFrom:
                        fieldRef:
                          apiVersion: v1
                          fieldPath: metadata.namespace
                    hpaSpec:
                      maxReplicas: 5
                      metrics:
                      - resource:
                          name: cpu
                          targetAverageUtilization: 80
                        type: Resource
                      minReplicas: 1
                      scaleTargetRef:
                        apiVersion: apps/v1
                        kind: Deployment
                        name: istio-policy
                    strategy:
                      rollingUpdate:
                        maxSurge: 100%
                        maxUnavailable: 25%
                proxy:
                  enabled: false
                sidecarInjector:
                  enabled: false
                telemetry:
                  enabled: false
                  k8s:
                    env:
                    - name: POD_NAMESPACE
                      valueFrom:
                        fieldRef:
                          apiVersion: v1
                          fieldPath: metadata.namespace
                    - name: GOMAXPROCS
                      value: "6"
                    hpaSpec:
                      maxReplicas: 5
                      metrics:
                      - resource:
                          name: cpu
                          targetAverageUtilization: 80
                        type: Resource
                      minReplicas: 1
                      scaleTargetRef:
                        apiVersion: apps/v1
                        kind: Deployment
                        name: istio-telemetry
                    replicaCount: 1
                    resources:
                      limits:
                        cpu: 4800m
                        memory: 4G
                      requests:
                        cpu: 1000m
                        memory: 1G
                    strategy:
                      rollingUpdate:
                        maxSurge: 100%
                        maxUnavailable: 25%
              hub: gcr.io/istio-testing
              profile: default
              tag: latest
              values:
                clusterResources: true
                galley:
                  enableAnalysis: false
                  image: galley
                gateways:
                  istio-egressgateway:
                    autoscaleEnabled: true
                    env:
                      ISTIO_META_ROUTER_MODE: sni-dnat
                    ports:
                    - name: http2
                      port: 80
                    - name: https
                      port: 443
                    - name: tls
                      port: 15443
                      targetPort: 15443
                    secretVolumes:
                    - mountPath: /etc/istio/egressgateway-certs
                      name: egressgateway-certs
                      secretName: istio-egressgateway-certs
                    - mountPath: /etc/istio/egressgateway-ca-certs
                      name: egressgateway-ca-certs
                      secretName: istio-egressgateway-ca-certs
                    type: ClusterIP
                  istio-ingressgateway:
                    applicationPorts: ""
                    autoscaleEnabled: true
                    debug: info
                    domain: ""
                    env:
                      ISTIO_META_ROUTER_MODE: sni-dnat
                    meshExpansionPorts:
                    - name: tcp-pilot-grpc-tls
                      port: 15011
                      targetPort: 15011
                    - name: tcp-citadel-grpc-tls
                      port: 8060
                      targetPort: 8060
                    - name: tcp-dns-tls
                      port: 853
                      targetPort: 8853
                    ports:
                    - name: status-port
                      port: 15020
                      targetPort: 15020
                    - name: http2
                      port: 80
                      targetPort: 8080
                    - name: https
                      port: 443
                      targetPort: 8443
                    - name: kiali
                      port: 15029
                      targetPort: 15029
                    - name: prometheus
                      port: 15030
                      targetPort: 15030
                    - name: grafana
                      port: 15031
                      targetPort: 15031
                    - name: tracing
                      port: 15032
                      targetPort: 15032
                    - name: tls
                      port: 15443
                      targetPort: 15443
                    secretVolumes:
                    - mountPath: /etc/istio/ingressgateway-certs
                      name: ingressgateway-certs
                      secretName: istio-ingressgateway-certs
                    - mountPath: /etc/istio/ingressgateway-ca-certs
                      name: ingressgateway-ca-certs
                      secretName: istio-ingressgateway-ca-certs
                    type: LoadBalancer
                global:
                  arch:
                    amd64: 2
                    ppc64le: 2
                    s390x: 2
                  certificates: []
                  configValidation: true
                  controlPlaneSecurityEnabled: true
                  defaultNodeSelector: {}
                  defaultPodDisruptionBudget:
                    enabled: true
                  defaultResources:
                    requests:
                      cpu: 10m
                  disablePolicyChecks: true
                  enableHelmTest: false
                  enableTracing: true
                  imagePullPolicy: ""
                  imagePullSecrets: []
                  istioNamespace: istio-system
                  istiod:
                    enabled: true
                  jwtPolicy: third-party-jwt
                  k8sIngress:
                    enableHttps: false
                    enabled: false
                    gatewayName: ingressgateway
                  localityLbSetting:
                    enabled: true
                  logAsJson: false
                  logging:
                    level: default:info
                  meshExpansion:
                    enabled: false
                    useILB: false
                  meshNetworks: {}
                  mountMtlsCerts: false
                  mtls:
                    auto: true
                    enabled: false
                  multiCluster:
                    clusterName: ""
                    enabled: false
                  network: ""
                  omitSidecarInjectorConfigMap: false
                  oneNamespace: false
                  operatorManageWebhooks: false
                  outboundTrafficPolicy:
                    mode: ALLOW_ANY
                  pilotCertProvider: istiod
                  policyCheckFailOpen: false
                  priorityClassName: ""
                  proxy:
                    accessLogEncoding: TEXT
                    accessLogFile: ""
                    accessLogFormat: ""
                    autoInject: enabled
                    clusterDomain: cluster.local
                    componentLogLevel: misc:error
                    concurrency: 2
                    dnsRefreshRate: 300s
                    enableCoreDump: false
                    envoyAccessLogService:
                      enabled: false
                    envoyMetricsService:
                      enabled: false
                      tcpKeepalive:
                        interval: 10s
                        probes: 3
                        time: 10s
                      tlsSettings:
                        mode: DISABLE
                        subjectAltNames: []
                    envoyStatsd:
                      enabled: false
                    excludeIPRanges: ""
                    excludeInboundPorts: ""
                    excludeOutboundPorts: ""
                    image: proxyv2
                    includeIPRanges: '*'
                    includeInboundPorts: '*'
                    kubevirtInterfaces: ""
                    logLevel: warning
                    privileged: false
                    protocolDetectionTimeout: 100ms
                    readinessFailureThreshold: 30
                    readinessInitialDelaySeconds: 1
                    readinessPeriodSeconds: 2
                    resources:
                      limits:
                        cpu: 2000m
                        memory: 1024Mi
                      requests:
                        cpu: 100m
                        memory: 128Mi
                    statusPort: 15020
                    tracer: zipkin
                  proxy_init:
                    image: proxyv2
                    resources:
                      limits:
                        cpu: 100m
                        memory: 50Mi
                      requests:
                        cpu: 10m
                        memory: 10Mi
                  sds:
                    token:
                      aud: istio-ca
                  sts:
                    servicePort: 0
                  tracer:
                    datadog:
                      address: $(HOST_IP):8126
                    lightstep:
                      accessToken: ""
                      address: ""
                      cacertPath: ""
                      secure: true
                    stackdriver:
                      debug: false
                      maxNumberOfAnnotations: 200
                      maxNumberOfAttributes: 200
                      maxNumberOfMessageEvents: 200
                    zipkin:
                      address: ""
                  trustDomain: cluster.local
                  useMCP: false
                grafana:
                  accessMode: ReadWriteMany
                  contextPath: /grafana
                  dashboardProviders:
                    dashboardproviders.yaml:
                      apiVersion: 1
                      providers:
                      - disableDeletion: false
                        folder: istio
                        name: istio
                        options:
                          path: /var/lib/grafana/dashboards/istio
                        orgId: 1
                        type: file
                  datasources:
                    datasources.yaml:
                      apiVersion: 1
                  env: {}
                  envSecrets: {}
                  image:
                    repository: grafana/grafana
                    tag: 6.5.2
                  ingress:
                    enabled: false
                    hosts:
                    - grafana.local
                  nodeSelector: {}
                  persist: false
                  podAntiAffinityLabelSelector: []
                  podAntiAffinityTermLabelSelector: []
                  security:
                    enabled: false
                    passphraseKey: passphrase
                    secretName: grafana
                    usernameKey: username
                  service:
                    annotations: {}
                    externalPort: 3000
                    name: http
                    type: ClusterIP
                  storageClassName: ""
                  tolerations: []
                istiocoredns:
                  coreDNSImage: coredns/coredns
                  coreDNSPluginImage: istio/coredns-plugin:0.2-istio-1.1
                  coreDNSTag: 1.6.2
                kiali:
                  contextPath: /kiali
                  createDemoSecret: false
                  dashboard:
                    grafanaInClusterURL: http://grafana:3000
                    jaegerInClusterURL: http://tracing/jaeger
                    passphraseKey: passphrase
                    secretName: kiali
                    usernameKey: username
                    viewOnlyMode: false
                  hub: quay.io/kiali
                  ingress:
                    enabled: false
                    hosts:
                    - kiali.local
                  nodeSelector: {}
                  podAntiAffinityLabelSelector: []
                  podAntiAffinityTermLabelSelector: []
                  security:
                    cert_file: /kiali-cert/cert-chain.pem
                    enabled: false
                    private_key_file: /kiali-cert/key.pem
                  tag: v1.14
                mixer:
                  adapters:
                    kubernetesenv:
                      enabled: true
                    prometheus:
                      enabled: true
                      metricsExpiryDuration: 10m
                    stackdriver:
                      auth:
                        apiKey: ""
                        appCredentials: false
                        serviceAccountPath: ""
                      enabled: false
                      tracer:
                        enabled: false
                        sampleProbability: 1
                    stdio:
                      enabled: false
                      outputAsJson: false
                    useAdapterCRDs: false
                  policy:
                    adapters:
                      kubernetesenv:
                        enabled: true
                      useAdapterCRDs: false
                    autoscaleEnabled: true
                    image: mixer
                    sessionAffinityEnabled: false
                  telemetry:
                    autoscaleEnabled: true
                    env:
                      GOMAXPROCS: "6"
                    image: mixer
                    loadshedding:
                      latencyThreshold: 100ms
                      mode: enforce
                    nodeSelector: {}
                    podAntiAffinityLabelSelector: []
                    podAntiAffinityTermLabelSelector: []
                    replicaCount: 1
                    reportBatchMaxEntries: 100
                    reportBatchMaxTime: 1s
                    sessionAffinityEnabled: false
                    tolerations: []
                pilot:
                  appNamespaces: []
                  autoscaleEnabled: true
                  autoscaleMax: 5
                  autoscaleMin: 1
                  configMap: true
                  configNamespace: istio-config
                  cpu:
                    targetAverageUtilization: 80
                  enableProtocolSniffingForInbound: false
                  enableProtocolSniffingForOutbound: true
                  env: {}
                  image: pilot
                  ingress:
                    ingressClass: istio
                    ingressControllerMode: STRICT
                    ingressService: istio-ingressgateway
                  keepaliveMaxServerConnectionAge: 30m
                  meshNetworks:
                    networks: {}
                  nodeSelector: {}
                  podAntiAffinityLabelSelector: []
                  podAntiAffinityTermLabelSelector: []
                  policy:
                    enabled: false
                  replicaCount: 1
                  tolerations: []
                  traceSampling: 1
                prometheus:
                  contextPath: /prometheus
                  hub: docker.io/prom
                  ingress:
                    enabled: false
                    hosts:
                    - prometheus.local
                  nodeSelector: {}
                  podAntiAffinityLabelSelector: []
                  podAntiAffinityTermLabelSelector: []
                  provisionPrometheusCert: true
                  retention: 6h
                  scrapeInterval: 15s
                  security:
                    enabled: true
                  tag: v2.15.1
                  tolerations: []
                security:
                  dnsCerts:
                    istio-pilot-service-account.istio-control: istio-pilot.istio-control
                  enableNamespacesByDefault: true
                  image: citadel
                  selfSigned: true
                sidecarInjectorWebhook:
                  enableNamespacesByDefault: false
                  injectLabel: istio-injection
                  objectSelector:
                    autoInject: true
                    enabled: false
                  rewriteAppHTTPProbe: false
                telemetry:
                  enabled: true
                  v1:
                    enabled: false
                  v2:
                    enabled: true
                    prometheus:
                      enabled: true
                    stackdriver:
                      configOverride: {}
                      enabled: false
                      logging: false
                      monitoring: false
                      topology: false
                tracing:
                  ingress:
                    enabled: false
                  jaeger:
                    accessMode: ReadWriteMany
                    hub: docker.io/jaegertracing
                    memory:
                      max_traces: 50000
                    persist: false
                    spanStorageType: badger
                    storageClassName: ""
                    tag: "1.16"
                  nodeSelector: {}
                  opencensus:
                    exporters:
                      stackdriver:
                        enable_tracing: true
                    hub: docker.io/omnition
                    resources:
                      limits:
                        cpu: "1"
                        memory: 2Gi
                      requests:
                        cpu: 200m
                        memory: 400Mi
                    tag: 0.1.9
                  podAntiAffinityLabelSelector: []
                  podAntiAffinityTermLabelSelector: []
                  provider: jaeger
                  service:
                    annotations: {}
                    externalPort: 9411
                    name: http-query
                    type: ClusterIP
                  zipkin:
                    hub: docker.io/openzipkin
                    javaOptsHeap: 700
                    maxSpans: 500000
                    node:
                      cpus: 2
                    probeStartupDelay: 10
                    queryPort: 9411
                    resources:
                      limits:
                        cpu: 1000m
                        memory: 2048Mi
                      requests:
                        cpu: 150m
                        memory: 900Mi
                    tag: 2.20.0
                version: ""
            
            
            
            want:
            apiVersion: install.istio.io/v1alpha1
            kind: IstioOperator
            spec:
              addonComponents:
                grafana:
                  enabled: false
                  k8s:
                    replicaCount: 1
                istiocoredns:
                  enabled: false
                kiali:
                  enabled: false
                  k8s:
                    replicaCount: 1
                prometheus:
                  enabled: true
                  k8s:
                    replicaCount: 1
                tracing:
                  enabled: false
              components:
                base:
                  enabled: true
                citadel:
                  enabled: false
                  k8s:
                    strategy:
                      rollingUpdate:
                        maxSurge: 100%
                        maxUnavailable: 25%
                cni:
                  enabled: false
                egressGateways:
                - enabled: false
                  k8s:
                    hpaSpec:
                      maxReplicas: 5
                      metrics:
                      - resource:
                          name: cpu
                          targetAverageUtilization: 80
                        type: Resource
                      minReplicas: 1
                      scaleTargetRef:
                        apiVersion: apps/v1
                        kind: Deployment
                        name: istio-ingressgateway
                    resources:
                      limits:
                        cpu: 2000m
                        memory: 1024Mi
                      requests:
                        cpu: 100m
                        memory: 128Mi
                    strategy:
                      rollingUpdate:
                        maxSurge: 100%
                        maxUnavailable: 25%
                  name: istio-egressgateway
                galley:
                  enabled: false
                  k8s:
                    replicaCount: 1
                    resources:
                      requests:
                        cpu: 100m
                    strategy:
                      rollingUpdate:
                        maxSurge: 100%
                        maxUnavailable: 25%
                ingressGateways:
                - enabled: true
                  k8s:
                    hpaSpec:
                      maxReplicas: 5
                      metrics:
                      - resource:
                          name: cpu
                          targetAverageUtilization: 80
                        type: Resource
                      minReplicas: 1
                      scaleTargetRef:
                        apiVersion: apps/v1
                        kind: Deployment
                        name: istio-ingressgateway
                    resources:
                      limits:
                        cpu: 2000m
                        memory: 1024Mi
                      requests:
                        cpu: 100m
                        memory: 128Mi
                    strategy:
                      rollingUpdate:
                        maxSurge: 100%
                        maxUnavailable: 25%
                  name: istio-ingressgateway
                pilot:
                  enabled: false
                  k8s:
                    env:
                    - name: POD_NAME
                      valueFrom:
                        fieldRef:
                          apiVersion: v1
                          fieldPath: metadata.name
                    - name: POD_NAMESPACE
                      valueFrom:
                        fieldRef:
                          apiVersion: v1
                          fieldPath: metadata.namespace
                    readinessProbe:
                      httpGet:
                        path: /ready
                        port: 8080
                      initialDelaySeconds: 5
                      periodSeconds: 5
                      timeoutSeconds: 5
                    strategy:
                      rollingUpdate:
                        maxSurge: 100%
                        maxUnavailable: 25%
                policy:
                  enabled: false
                  k8s:
                    env:
                    - name: POD_NAMESPACE
                      valueFrom:
                        fieldRef:
                          apiVersion: v1
                          fieldPath: metadata.namespace
                    hpaSpec:
                      maxReplicas: 5
                      metrics:
                      - resource:
                          name: cpu
                          targetAverageUtilization: 80
                        type: Resource
                      minReplicas: 1
                      scaleTargetRef:
                        apiVersion: apps/v1
                        kind: Deployment
                        name: istio-policy
                    strategy:
                      rollingUpdate:
                        maxSurge: 100%
                        maxUnavailable: 25%
                proxy:
                  enabled: false
                sidecarInjector:
                  enabled: false
                telemetry:
                  enabled: false
                  k8s:
                    env:
                    - name: POD_NAMESPACE
                      valueFrom:
                        fieldRef:
                          apiVersion: v1
                          fieldPath: metadata.namespace
                    - name: GOMAXPROCS
                      value: "6"
                    hpaSpec:
                      maxReplicas: 5
                      metrics:
                      - resource:
                          name: cpu
                          targetAverageUtilization: 80
                        type: Resource
                      minReplicas: 1
                      scaleTargetRef:
                        apiVersion: apps/v1
                        kind: Deployment
                        name: istio-telemetry
                    replicaCount: 1
                    resources:
                      limits:
                        cpu: 4800m
                        memory: 4G
                      requests:
                        cpu: 1000m
                        memory: 1G
                    strategy:
                      rollingUpdate:
                        maxSurge: 100%
                        maxUnavailable: 25%
              hub: gcr.io/istio-testing
              profile: default
              tag: latest
              values:
                clusterResources: true
                galley:
                  enableAnalysis: false
                  image: galley
                gateways:
                  istio-egressgateway:
                    autoscaleEnabled: true
                    env:
                      ISTIO_META_ROUTER_MODE: sni-dnat
                    ports:
                    - name: http2
                      port: 80
                    - name: https
                      port: 443
                    - name: tls
                      port: 15443
                      targetPort: 15443
                    secretVolumes:
                    - mountPath: /etc/istio/egressgateway-certs
                      name: egressgateway-certs
                      secretName: istio-egressgateway-certs
                    - mountPath: /etc/istio/egressgateway-ca-certs
                      name: egressgateway-ca-certs
                      secretName: istio-egressgateway-ca-certs
                    type: ClusterIP
                  istio-ingressgateway:
                    applicationPorts: ""
                    autoscaleEnabled: true
                    debug: info
                    domain: ""
                    env:
                      ISTIO_META_ROUTER_MODE: sni-dnat
                    meshExpansionPorts:
                    - name: tcp-pilot-grpc-tls
                      port: 15011
                      targetPort: 15011
                    - name: tcp-citadel-grpc-tls
                      port: 8060
                      targetPort: 8060
                    - name: tcp-dns-tls
                      port: 853
                      targetPort: 8853
                    ports:
                    - name: status-port
                      port: 15020
                      targetPort: 15020
                    - name: http2
                      port: 80
                      targetPort: 8080
                    - name: https
                      port: 443
                      targetPort: 8443
                    - name: kiali
                      port: 15029
                      targetPort: 15029
                    - name: prometheus
                      port: 15030
                      targetPort: 15030
                    - name: grafana
                      port: 15031
                      targetPort: 15031
                    - name: tracing
                      port: 15032
                      targetPort: 15032
                    - name: tls
                      port: 15443
                      targetPort: 15443
                    secretVolumes:
                    - mountPath: /etc/istio/ingressgateway-certs
                      name: ingressgateway-certs
                      secretName: istio-ingressgateway-certs
                    - mountPath: /etc/istio/ingressgateway-ca-certs
                      name: ingressgateway-ca-certs
                      secretName: istio-ingressgateway-ca-certs
                    type: LoadBalancer
                global:
                  arch:
                    amd64: 2
                    ppc64le: 2
                    s390x: 2
                  certificates: []
                  configValidation: true
                  controlPlaneSecurityEnabled: true
                  defaultNodeSelector: {}
                  defaultPodDisruptionBudget:
                    enabled: true
                  defaultResources:
                    requests:
                      cpu: 10m
                  disablePolicyChecks: true
                  enableHelmTest: false
                  enableTracing: true
                  imagePullPolicy: ""
                  imagePullSecrets: []
                  istioNamespace: istio-system
                  istiod:
                    enabled: true
                  jwtPolicy: third-party-jwt
                  k8sIngress:
                    enableHttps: false
                    enabled: false
                    gatewayName: ingressgateway
                  localityLbSetting:
                    enabled: true
                  logAsJson: false
                  logging:
                    level: default:info
                  meshExpansion:
                    enabled: false
                    useILB: false
                  meshNetworks: {}
                  mountMtlsCerts: false
                  mtls:
                    auto: true
                    enabled: false
                  multiCluster:
                    clusterName: ""
                    enabled: false
                  network: ""
                  omitSidecarInjectorConfigMap: false
                  oneNamespace: false
                  operatorManageWebhooks: false
                  outboundTrafficPolicy:
                    mode: ALLOW_ANY
                  pilotCertProvider: istiod
                  policyCheckFailOpen: false
                  priorityClassName: ""
                  proxy:
                    accessLogEncoding: TEXT
                    accessLogFile: ""
                    accessLogFormat: ""
                    autoInject: enabled
                    clusterDomain: cluster.local
                    componentLogLevel: misc:error
                    concurrency: 2
                    dnsRefreshRate: 300s
                    enableCoreDump: false
                    envoyAccessLogService:
                      enabled: false
                    envoyMetricsService:
                      enabled: false
                      tcpKeepalive:
                        interval: 10s
                        probes: 3
                        time: 10s
                      tlsSettings:
                        mode: DISABLE
                        subjectAltNames: []
                    envoyStatsd:
                      enabled: false
                    excludeIPRanges: ""
                    excludeInboundPorts: ""
                    excludeOutboundPorts: ""
                    image: proxyv2
                    includeIPRanges: '*'
                    includeInboundPorts: '*'
                    kubevirtInterfaces: ""
                    logLevel: warning
                    privileged: false
                    protocolDetectionTimeout: 100ms
                    readinessFailureThreshold: 30
                    readinessInitialDelaySeconds: 1
                    readinessPeriodSeconds: 2
                    resources:
                      limits:
                        cpu: 2000m
                        memory: 1024Mi
                      requests:
                        cpu: 100m
                        memory: 128Mi
                    statusPort: 15020
                    tracer: zipkin
                  proxy_init:
                    image: proxyv2
                    resources:
                      limits:
                        cpu: 100m
                        memory: 50Mi
                      requests:
                        cpu: 10m
                        memory: 10Mi
                  sds:
                    token:
                      aud: istio-ca
                  sts:
                    servicePort: 0
                  tracer:
                    datadog:
                      address: $(HOST_IP):8126
                    lightstep:
                      accessToken: ""
                      address: ""
                      cacertPath: ""
                      secure: true
                    stackdriver:
                      debug: false
                      maxNumberOfAnnotations: 200
                      maxNumberOfAttributes: 200
                      maxNumberOfMessageEvents: 200
                    zipkin:
                      address: ""
                  trustDomain: cluster.local
                  useMCP: false
                grafana:
                  accessMode: ReadWriteMany
                  contextPath: /grafana
                  dashboardProviders:
                    dashboardproviders.yaml:
                      apiVersion: 1
                      providers:
                      - disableDeletion: false
                        folder: istio
                        name: istio
                        options:
                          path: /var/lib/grafana/dashboards/istio
                        orgId: 1
                        type: file
                  datasources:
                    datasources.yaml:
                      apiVersion: 1
                  env: {}
                  envSecrets: {}
                  image:
                    repository: grafana/grafana
                    tag: 6.5.2
                  ingress:
                    enabled: false
                    hosts:
                    - grafana.local
                  nodeSelector: {}
                  persist: false
                  podAntiAffinityLabelSelector: []
                  podAntiAffinityTermLabelSelector: []
                  security:
                    enabled: false
                    passphraseKey: passphrase
                    secretName: grafana
                    usernameKey: username
                  service:
                    annotations: {}
                    externalPort: 3000
                    name: http
                    type: ClusterIP
                  storageClassName: ""
                  tolerations: []
                istiocoredns:
                  coreDNSImage: coredns/coredns
                  coreDNSPluginImage: istio/coredns-plugin:0.2-istio-1.1
                  coreDNSTag: 1.6.2
                kiali:
                  contextPath: /kiali
                  createDemoSecret: false
                  dashboard:
                    grafanaInClusterURL: http://grafana:3000
                    jaegerInClusterURL: http://tracing/jaeger
                    passphraseKey: passphrase
                    secretName: kiali
                    usernameKey: username
                    viewOnlyMode: false
                  hub: quay.io/kiali
                  ingress:
                    enabled: false
                    hosts:
                    - kiali.local
                  nodeSelector: {}
                  podAntiAffinityLabelSelector: []
                  podAntiAffinityTermLabelSelector: []
                  security:
                    cert_file: /kiali-cert/cert-chain.pem
                    enabled: false
                    private_key_file: /kiali-cert/key.pem
                  tag: v1.14
                mixer:
                  adapters:
                    kubernetesenv:
                      enabled: true
                    prometheus:
                      enabled: true
                      metricsExpiryDuration: 10m
                    stackdriver:
                      auth:
                        apiKey: ""
                        appCredentials: false
                        serviceAccountPath: ""
                      enabled: false
                      tracer:
                        enabled: false
                        sampleProbability: 1
                    stdio:
                      enabled: false
                      outputAsJson: false
                    useAdapterCRDs: false
                  policy:
                    adapters:
                      kubernetesenv:
                        enabled: true
                      useAdapterCRDs: false
                    autoscaleEnabled: true
                    image: mixer
                    sessionAffinityEnabled: false
                  telemetry:
                    autoscaleEnabled: true
                    env:
                      GOMAXPROCS: "6"
                    image: mixer
                    loadshedding:
                      latencyThreshold: 100ms
                      mode: enforce
                    nodeSelector: {}
                    podAntiAffinityLabelSelector: []
                    podAntiAffinityTermLabelSelector: []
                    replicaCount: 1
                    reportBatchMaxEntries: 100
                    reportBatchMaxTime: 1s
                    sessionAffinityEnabled: false
                    tolerations: []
                pilot:
                  appNamespaces: []
                  autoscaleEnabled: true
                  autoscaleMax: 5
                  autoscaleMin: 1
                  configMap: true
                  configNamespace: istio-config
                  cpu:
                    targetAverageUtilization: 80
                  enableProtocolSniffingForInbound: false
                  enableProtocolSniffingForOutbound: true
                  env: {}
                  image: pilot
                  ingress:
                    ingressClass: istio
                    ingressControllerMode: STRICT
                    ingressService: istio-ingressgateway
                  keepaliveMaxServerConnectionAge: 30m
                  meshNetworks:
                    networks: {}
                  nodeSelector: {}
                  podAntiAffinityLabelSelector: []
                  podAntiAffinityTermLabelSelector: []
                  policy:
                    enabled: false
                  replicaCount: 1
                  tolerations: []
                  traceSampling: 1
                prometheus:
                  contextPath: /prometheus
                  hub: docker.io/prom
                  ingress:
                    enabled: false
                    hosts:
                    - prometheus.local
                  nodeSelector: {}
                  podAntiAffinityLabelSelector: []
                  podAntiAffinityTermLabelSelector: []
                  provisionPrometheusCert: true
                  retention: 6h
                  scrapeInterval: 15s
                  security:
                    enabled: true
                  tag: v2.15.1
                  tolerations: []
                security:
                  dnsCerts:
                    istio-pilot-service-account.istio-control: istio-pilot.istio-control
                  enableNamespacesByDefault: true
                  image: citadel
                  selfSigned: true
                sidecarInjectorWebhook:
                  enableNamespacesByDefault: false
                  injectLabel: istio-injection
                  objectSelector:
                    autoInject: true
                    enabled: false
                  rewriteAppHTTPProbe: true
                telemetry:
                  enabled: true
                  v1:
                    enabled: false
                  v2:
                    enabled: true
                    prometheus:
                      enabled: true
                    stackdriver:
                      configOverride: {}
                      enabled: false
                      logging: false
                      monitoring: false
                      topology: false
                tracing:
                  ingress:
                    enabled: false
                  jaeger:
                    accessMode: ReadWriteMany
                    hub: docker.io/jaegertracing
                    memory:
                      max_traces: 50000
                    persist: false
                    spanStorageType: badger
                    storageClassName: ""
                    tag: "1.16"
                  nodeSelector: {}
                  opencensus:
                    exporters:
                      stackdriver:
                        enable_tracing: true
                    hub: docker.io/omnition
                    resources:
                      limits:
                        cpu: "1"
                        memory: 2Gi
                      requests:
                        cpu: 200m
                        memory: 400Mi
                    tag: 0.1.9
                  podAntiAffinityLabelSelector: []
                  podAntiAffinityTermLabelSelector: []
                  provider: jaeger
                  service:
                    annotations: {}
                    externalPort: 9411
                    name: http-query
                    type: ClusterIP
                  zipkin:
                    hub: docker.io/openzipkin
                    javaOptsHeap: 700
                    maxSpans: 500000
                    node:
                      cpus: 2
                    probeStartupDelay: 10
                    queryPort: 9411
                    resources:
                      limits:
                        cpu: 1000m
                        memory: 2048Mi
                      requests:
                        cpu: 150m
                        memory: 900Mi
                    tag: 2.20.0
                version: ""
            
            
            Diff:
             apiVersion: install.istio.io/v1alpha1
             kind: IstioOperator
             spec:
               addonComponents:
                 grafana:
                   enabled: false
                   k8s:
                     replicaCount: 1
                 istiocoredns:
                   enabled: false
                 kiali:
                   enabled: false
                   k8s:
                     replicaCount: 1
                 prometheus:
                   enabled: true
                   k8s:
                     replicaCount: 1
                 tracing:
                   enabled: false
               components:
                 base:
                   enabled: true
                 citadel:
                   enabled: false
                   k8s:
                     strategy:
                       rollingUpdate:
                         maxSurge: 100%
                         maxUnavailable: 25%
                 cni:
                   enabled: false
                 egressGateways:
                 - enabled: false
                   k8s:
                     hpaSpec:
                       maxReplicas: 5
                       metrics:
                       - resource:
                           name: cpu
                           targetAverageUtilization: 80
                         type: Resource
                       minReplicas: 1
                       scaleTargetRef:
                         apiVersion: apps/v1
                         kind: Deployment
                         name: istio-ingressgateway
                     resources:
                       limits:
                         cpu: 2000m
                         memory: 1024Mi
                       requests:
                         cpu: 100m
                         memory: 128Mi
                     strategy:
                       rollingUpdate:
                         maxSurge: 100%
                         maxUnavailable: 25%
                   name: istio-egressgateway
                 galley:
                   enabled: false
                   k8s:
                     replicaCount: 1
                     resources:
                       requests:
                         cpu: 100m
                     strategy:
                       rollingUpdate:
                         maxSurge: 100%
                         maxUnavailable: 25%
                 ingressGateways:
                 - enabled: true
                   k8s:
                     hpaSpec:
                       maxReplicas: 5
                       metrics:
                       - resource:
                           name: cpu
                           targetAverageUtilization: 80
                         type: Resource
                       minReplicas: 1
                       scaleTargetRef:
                         apiVersion: apps/v1
                         kind: Deployment
                         name: istio-ingressgateway
                     resources:
                       limits:
                         cpu: 2000m
                         memory: 1024Mi
                       requests:
                         cpu: 100m
                         memory: 128Mi
                     strategy:
                       rollingUpdate:
                         maxSurge: 100%
                         maxUnavailable: 25%
                   name: istio-ingressgateway
                 pilot:
                   enabled: false
                   k8s:
                     env:
                     - name: POD_NAME
                       valueFrom:
                         fieldRef:
                           apiVersion: v1
                           fieldPath: metadata.name
                     - name: POD_NAMESPACE
                       valueFrom:
                         fieldRef:
                           apiVersion: v1
                           fieldPath: metadata.namespace
                     readinessProbe:
                       httpGet:
                         path: /ready
                         port: 8080
                       initialDelaySeconds: 5
                       periodSeconds: 5
                       timeoutSeconds: 5
                     strategy:
                       rollingUpdate:
                         maxSurge: 100%
                         maxUnavailable: 25%
                 policy:
                   enabled: false
                   k8s:
                     env:
                     - name: POD_NAMESPACE
                       valueFrom:
                         fieldRef:
                           apiVersion: v1
                           fieldPath: metadata.namespace
                     hpaSpec:
                       maxReplicas: 5
                       metrics:
                       - resource:
                           name: cpu
                           targetAverageUtilization: 80
                         type: Resource
                       minReplicas: 1
                       scaleTargetRef:
                         apiVersion: apps/v1
                         kind: Deployment
                         name: istio-policy
                     strategy:
                       rollingUpdate:
                         maxSurge: 100%
                         maxUnavailable: 25%
                 proxy:
                   enabled: false
                 sidecarInjector:
                   enabled: false
                 telemetry:
                   enabled: false
                   k8s:
                     env:
                     - name: POD_NAMESPACE
                       valueFrom:
                         fieldRef:
                           apiVersion: v1
                           fieldPath: metadata.namespace
                     - name: GOMAXPROCS
                       value: "6"
                     hpaSpec:
                       maxReplicas: 5
                       metrics:
                       - resource:
                           name: cpu
                           targetAverageUtilization: 80
                         type: Resource
                       minReplicas: 1
                       scaleTargetRef:
                         apiVersion: apps/v1
                         kind: Deployment
                         name: istio-telemetry
                     replicaCount: 1
                     resources:
                       limits:
                         cpu: 4800m
                         memory: 4G
                       requests:
                         cpu: 1000m
                         memory: 1G
                     strategy:
                       rollingUpdate:
                         maxSurge: 100%
                         maxUnavailable: 25%
               hub: gcr.io/istio-testing
               profile: default
               tag: latest
               values:
                 clusterResources: true
                 galley:
                   enableAnalysis: false
                   image: galley
                 gateways:
                   istio-egressgateway:
                     autoscaleEnabled: true
                     env:
                       ISTIO_META_ROUTER_MODE: sni-dnat
                     ports:
                     - name: http2
                       port: 80
                     - name: https
                       port: 443
                     - name: tls
                       port: 15443
                       targetPort: 15443
                     secretVolumes:
                     - mountPath: /etc/istio/egressgateway-certs
                       name: egressgateway-certs
                       secretName: istio-egressgateway-certs
                     - mountPath: /etc/istio/egressgateway-ca-certs
                       name: egressgateway-ca-certs
                       secretName: istio-egressgateway-ca-certs
                     type: ClusterIP
                   istio-ingressgateway:
                     applicationPorts: ""
                     autoscaleEnabled: true
                     debug: info
                     domain: ""
                     env:
                       ISTIO_META_ROUTER_MODE: sni-dnat
                     meshExpansionPorts:
                     - name: tcp-pilot-grpc-tls
                       port: 15011
                       targetPort: 15011
                     - name: tcp-citadel-grpc-tls
                       port: 8060
                       targetPort: 8060
                     - name: tcp-dns-tls
                       port: 853
                       targetPort: 8853
                     ports:
                     - name: status-port
                       port: 15020
                       targetPort: 15020
                     - name: http2
                       port: 80
                       targetPort: 8080
                     - name: https
                       port: 443
                       targetPort: 8443
                     - name: kiali
                       port: 15029
                       targetPort: 15029
                     - name: prometheus
                       port: 15030
                       targetPort: 15030
                     - name: grafana
                       port: 15031
                       targetPort: 15031
                     - name: tracing
                       port: 15032
                       targetPort: 15032
                     - name: tls
                       port: 15443
                       targetPort: 15443
                     secretVolumes:
                     - mountPath: /etc/istio/ingressgateway-certs
                       name: ingressgateway-certs
                       secretName: istio-ingressgateway-certs
                     - mountPath: /etc/istio/ingressgateway-ca-certs
                       name: ingressgateway-ca-certs
                       secretName: istio-ingressgateway-ca-certs
                     type: LoadBalancer
                 global:
                   arch:
                     amd64: 2
                     ppc64le: 2
                     s390x: 2
                   certificates: []
                   configValidation: true
                   controlPlaneSecurityEnabled: true
                   defaultNodeSelector: {}
                   defaultPodDisruptionBudget:
                     enabled: true
                   defaultResources:
                     requests:
                       cpu: 10m
                   disablePolicyChecks: true
                   enableHelmTest: false
                   enableTracing: true
                   imagePullPolicy: ""
                   imagePullSecrets: []
                   istioNamespace: istio-system
                   istiod:
                     enabled: true
                   jwtPolicy: third-party-jwt
                   k8sIngress:
                     enableHttps: false
                     enabled: false
                     gatewayName: ingressgateway
                   localityLbSetting:
                     enabled: true
                   logAsJson: false
                   logging:
                     level: default:info
                   meshExpansion:
                     enabled: false
                     useILB: false
                   meshNetworks: {}
                   mountMtlsCerts: false
                   mtls:
                     auto: true
                     enabled: false
                   multiCluster:
                     clusterName: ""
                     enabled: false
                   network: ""
                   omitSidecarInjectorConfigMap: false
                   oneNamespace: false
                   operatorManageWebhooks: false
                   outboundTrafficPolicy:
                     mode: ALLOW_ANY
                   pilotCertProvider: istiod
                   policyCheckFailOpen: false
                   priorityClassName: ""
                   proxy:
                     accessLogEncoding: TEXT
                     accessLogFile: ""
                     accessLogFormat: ""
                     autoInject: enabled
                     clusterDomain: cluster.local
                     componentLogLevel: misc:error
                     concurrency: 2
                     dnsRefreshRate: 300s
                     enableCoreDump: false
                     envoyAccessLogService:
                       enabled: false
                     envoyMetricsService:
                       enabled: false
                       tcpKeepalive:
                         interval: 10s
                         probes: 3
                         time: 10s
                       tlsSettings:
                         mode: DISABLE
                         subjectAltNames: []
                     envoyStatsd:
                       enabled: false
                     excludeIPRanges: ""
                     excludeInboundPorts: ""
                     excludeOutboundPorts: ""
                     image: proxyv2
                     includeIPRanges: '*'
                     includeInboundPorts: '*'
                     kubevirtInterfaces: ""
                     logLevel: warning
                     privileged: false
                     protocolDetectionTimeout: 100ms
                     readinessFailureThreshold: 30
                     readinessInitialDelaySeconds: 1
                     readinessPeriodSeconds: 2
                     resources:
                       limits:
                         cpu: 2000m
                         memory: 1024Mi
                       requests:
                         cpu: 100m
                         memory: 128Mi
                     statusPort: 15020
                     tracer: zipkin
                   proxy_init:
                     image: proxyv2
                     resources:
                       limits:
                         cpu: 100m
                         memory: 50Mi
                       requests:
                         cpu: 10m
                         memory: 10Mi
                   sds:
                     token:
                       aud: istio-ca
                   sts:
                     servicePort: 0
                   tracer:
                     datadog:
                       address: $(HOST_IP):8126
                     lightstep:
                       accessToken: ""
                       address: ""
                       cacertPath: ""
                       secure: true
                     stackdriver:
                       debug: false
                       maxNumberOfAnnotations: 200
                       maxNumberOfAttributes: 200
                       maxNumberOfMessageEvents: 200
                     zipkin:
                       address: ""
                   trustDomain: cluster.local
                   useMCP: false
                 grafana:
                   accessMode: ReadWriteMany
                   contextPath: /grafana
                   dashboardProviders:
                     dashboardproviders.yaml:
                       apiVersion: 1
                       providers:
                       - disableDeletion: false
                         folder: istio
                         name: istio
                         options:
                           path: /var/lib/grafana/dashboards/istio
                         orgId: 1
                         type: file
                   datasources:
                     datasources.yaml:
                       apiVersion: 1
                   env: {}
                   envSecrets: {}
                   image:
                     repository: grafana/grafana
                     tag: 6.5.2
                   ingress:
                     enabled: false
                     hosts:
                     - grafana.local
                   nodeSelector: {}
                   persist: false
                   podAntiAffinityLabelSelector: []
                   podAntiAffinityTermLabelSelector: []
                   security:
                     enabled: false
                     passphraseKey: passphrase
                     secretName: grafana
                     usernameKey: username
                   service:
                     annotations: {}
                     externalPort: 3000
                     name: http
                     type: ClusterIP
                   storageClassName: ""
                   tolerations: []
                 istiocoredns:
                   coreDNSImage: coredns/coredns
                   coreDNSPluginImage: istio/coredns-plugin:0.2-istio-1.1
                   coreDNSTag: 1.6.2
                 kiali:
                   contextPath: /kiali
                   createDemoSecret: false
                   dashboard:
                     grafanaInClusterURL: http://grafana:3000
                     jaegerInClusterURL: http://tracing/jaeger
                     passphraseKey: passphrase
                     secretName: kiali
                     usernameKey: username
                     viewOnlyMode: false
                   hub: quay.io/kiali
                   ingress:
                     enabled: false
                     hosts:
                     - kiali.local
                   nodeSelector: {}
                   podAntiAffinityLabelSelector: []
                   podAntiAffinityTermLabelSelector: []
                   security:
                     cert_file: /kiali-cert/cert-chain.pem
                     enabled: false
                     private_key_file: /kiali-cert/key.pem
                   tag: v1.14
                 mixer:
                   adapters:
                     kubernetesenv:
                       enabled: true
                     prometheus:
                       enabled: true
                       metricsExpiryDuration: 10m
                     stackdriver:
                       auth:
                         apiKey: ""
                         appCredentials: false
                         serviceAccountPath: ""
                       enabled: false
                       tracer:
                         enabled: false
                         sampleProbability: 1
                     stdio:
                       enabled: false
                       outputAsJson: false
                     useAdapterCRDs: false
                   policy:
                     adapters:
                       kubernetesenv:
                         enabled: true
                       useAdapterCRDs: false
                     autoscaleEnabled: true
                     image: mixer
                     sessionAffinityEnabled: false
                   telemetry:
                     autoscaleEnabled: true
                     env:
                       GOMAXPROCS: "6"
                     image: mixer
                     loadshedding:
                       latencyThreshold: 100ms
                       mode: enforce
                     nodeSelector: {}
                     podAntiAffinityLabelSelector: []
                     podAntiAffinityTermLabelSelector: []
                     replicaCount: 1
                     reportBatchMaxEntries: 100
                     reportBatchMaxTime: 1s
                     sessionAffinityEnabled: false
                     tolerations: []
                 pilot:
                   appNamespaces: []
                   autoscaleEnabled: true
                   autoscaleMax: 5
                   autoscaleMin: 1
                   configMap: true
                   configNamespace: istio-config
                   cpu:
                     targetAverageUtilization: 80
                   enableProtocolSniffingForInbound: false
                   enableProtocolSniffingForOutbound: true
                   env: {}
                   image: pilot
                   ingress:
                     ingressClass: istio
                     ingressControllerMode: STRICT
                     ingressService: istio-ingressgateway
                   keepaliveMaxServerConnectionAge: 30m
                   meshNetworks:
                     networks: {}
                   nodeSelector: {}
                   podAntiAffinityLabelSelector: []
                   podAntiAffinityTermLabelSelector: []
                   policy:
                     enabled: false
                   replicaCount: 1
                   tolerations: []
                   traceSampling: 1
                 prometheus:
                   contextPath: /prometheus
                   hub: docker.io/prom
                   ingress:
                     enabled: false
                     hosts:
                     - prometheus.local
                   nodeSelector: {}
                   podAntiAffinityLabelSelector: []
                   podAntiAffinityTermLabelSelector: []
                   provisionPrometheusCert: true
                   retention: 6h
                   scrapeInterval: 15s
                   security:
                     enabled: true
                   tag: v2.15.1
                   tolerations: []
                 security:
                   dnsCerts:
                     istio-pilot-service-account.istio-control: istio-pilot.istio-control
                   enableNamespacesByDefault: true
                   image: citadel
                   selfSigned: true
                 sidecarInjectorWebhook:
                   enableNamespacesByDefault: false
                   injectLabel: istio-injection
                   objectSelector:
                     autoInject: true
                     enabled: false
            -      rewriteAppHTTPProbe: false
            +      rewriteAppHTTPProbe: true
                 telemetry:
                   enabled: true
                   v1:
                     enabled: false
                   v2:
                     enabled: true
                     prometheus:
                       enabled: true
                     stackdriver:
                       configOverride: {}
                       enabled: false
                       logging: false
                       monitoring: false
                       topology: false
                 tracing:
                   ingress:
                     enabled: false
                   jaeger:
                     accessMode: ReadWriteMany
                     hub: docker.io/jaegertracing
                     memory:
                       max_traces: 50000
                     persist: false
                     spanStorageType: badger
                     storageClassName: ""
                     tag: "1.16"
                   nodeSelector: {}
                   opencensus:
                     exporters:
                       stackdriver:
                         enable_tracing: true
                     hub: docker.io/omnition
                     resources:
                       limits:
                         cpu: "1"
                         memory: 2Gi
                       requests:
                         cpu: 200m
                         memory: 400Mi
                     tag: 0.1.9
                   podAntiAffinityLabelSelector: []
                   podAntiAffinityTermLabelSelector: []
                   provider: jaeger
                   service:
                     annotations: {}
                     externalPort: 9411
                     name: http-query
                     type: ClusterIP
                   zipkin:
                     hub: docker.io/openzipkin
                     javaOptsHeap: 700
                     maxSpans: 500000
                     node:
                       cpus: 2
                     probeStartupDelay: 10
                     queryPort: 9411
                     resources:
                       limits:
                         cpu: 1000m
                         memory: 2048Mi
                       requests:
                         cpu: 150m
                         memory: 900Mi
                     tag: 2.20.0
                 version: ""
             
FAIL
FAIL	istio.io/istio/operator/cmd/mesh	12.678s
?   	istio.io/istio/operator/cmd/operator	[no test files]
?   	istio.io/istio/operator/pkg/apis	[no test files]
?   	istio.io/istio/operator/pkg/apis/istio	[no test files]
?   	istio.io/istio/operator/pkg/apis/istio/fixup_structs	[no test files]
?   	istio.io/istio/operator/pkg/apis/istio/v1alpha1	[no test files]
ok  	istio.io/istio/operator/pkg/apis/istio/v1alpha1/validation	(cached)
?   	istio.io/istio/operator/pkg/apis/istio/v1alpha2	[no test files]
ok  	istio.io/istio/operator/pkg/compare	(cached)
?   	istio.io/istio/operator/pkg/component	[no test files]
?   	istio.io/istio/operator/pkg/controller	[no test files]
ok  	istio.io/istio/operator/pkg/controller/istiocontrolplane	(cached)
?   	istio.io/istio/operator/pkg/controlplane	[no test files]
ok  	istio.io/istio/operator/pkg/helm	(cached)
?   	istio.io/istio/operator/pkg/helmreconciler	[no test files]
ok  	istio.io/istio/operator/pkg/hooks	(cached)
?   	istio.io/istio/operator/pkg/httprequest	[no test files]
ok  	istio.io/istio/operator/pkg/kubectlcmd	(cached)
ok  	istio.io/istio/operator/pkg/manifest	(cached)
ok  	istio.io/istio/operator/pkg/name	(cached)
ok  	istio.io/istio/operator/pkg/object	(cached)
ok  	istio.io/istio/operator/pkg/patch	(cached)
ok  	istio.io/istio/operator/pkg/tpath	(cached)
ok  	istio.io/istio/operator/pkg/translate	0.281s
ok  	istio.io/istio/operator/pkg/util	(cached)
?   	istio.io/istio/operator/pkg/util/fswatch	[no test files]
ok  	istio.io/istio/operator/pkg/validate	(cached)
ok  	istio.io/istio/operator/pkg/version	(cached)
?   	istio.io/istio/operator/pkg/vfs	[no test files]
ok  	istio.io/istio/operator/tests/codecov	(cached)
ok  	istio.io/istio/operator/version	(cached)
FAIL
Makefile.core.mk:445: recipe for target 'operator-test' failed
make[1]: *** [operator-test] Error 1
Makefile.core.mk:431: recipe for target 'test' failed
make: *** [test] Error 2
