# Params:
# * TARGET_OUT_LINUX: out/linux_${TARGET_ARCH}
# * SIDECAR: envoy


images:

# Base images
- name: base
  dockerfile: docker/Dockerfile.base

- name: distroless
  dockerfile: docker/Dockerfile.distroless

# Production images
- name: proxyv2
  dockerfile: pilot/docker/Dockerfile.proxyv2
  files:
  - tools/packaging/common/envoy_bootstrap.json
  - tools/packaging/common/gcp_envoy_bootstrap.json
  - ${TARGET_OUT_LINUX}/${SIDECAR}
  - ${TARGET_OUT_LINUX}/stats-filter.wasm
  - ${TARGET_OUT_LINUX}/stats-filter.compiled.wasm
  - ${TARGET_OUT_LINUX}/metadata-exchange-filter.wasm
  - ${TARGET_OUT_LINUX}/metadata-exchange-filter.compiled.wasm
  targets:
  - ${TARGET_OUT_LINUX}/pilot-agent
- name: pilot
  dockerfile: pilot/docker/Dockerfile.pilot
  files:
  - tools/packaging/common/envoy_bootstrap.json
  - tools/packaging/common/gcp_envoy_bootstrap.json
  targets:
  - ${TARGET_OUT_LINUX}/pilot-discovery

- name: istioctl
  dockerfile: istioctl/docker/Dockerfile.istioctl
  targets:
  - ${TARGET_OUT_LINUX}/istioctl

- name: operator
  dockerfile: operator/docker/Dockerfile.operator
  files:
  - manifests
  targets:
  - ${TARGET_OUT_LINUX}/operator

- name: install-cni
  dockerfile-cni: cni/deployments/kubernetes/Dockerfile.install-cni
  targets:
  - ${TARGET_OUT_LINUX}/istio-cni
  - ${TARGET_OUT_LINUX}/istio-iptables
  - ${TARGET_OUT_LINUX}/install-cni
  - ${TARGET_OUT_LINUX}/istio-cni-taint

# Test images
- name: app
  dockerfile: pkg/test/echo/docker/Dockerfile.app
  files:
  - tests/testdata/certs
  targets:
  - ${TARGET_OUT_LINUX}/client
  - ${TARGET_OUT_LINUX}/server

- name: app_sidecar_centos_8
  dockerfile: pkg/test/echo/docker/Dockerfile.app_sidecar_centos_8
  files:
  - tools/packaging/common/envoy_bootstrap.json
  - tests/testdata/certs
  - pkg/test/echo/docker/echo-start.sh
  targets:
  - ${TARGET_OUT_LINUX}/release/istio-sidecar.rpm
  - ${TARGET_OUT_LINUX}/client
  - ${TARGET_OUT_LINUX}/server
- name: app_sidecar_centos_7
  dockerfile: pkg/test/echo/docker/Dockerfile.app_sidecar_centos_7
  files:
  - tools/packaging/common/envoy_bootstrap.json
  - tests/testdata/certs
  - pkg/test/echo/docker/echo-start.sh
  targets:
  - ${TARGET_OUT_LINUX}/release/istio-sidecar.rpm
  - ${TARGET_OUT_LINUX}/client
  - ${TARGET_OUT_LINUX}/server

- name: app_sidecar_base_debian_9
  dockerfile: pkg/test/echo/docker/Dockerfile.app_sidecar_base
  files:
  - tools/packaging/common/envoy_bootstrap.json
  - tests/testdata/certs
  - pkg/test/echo/docker/echo-start.sh
  targets:
  - ${TARGET_OUT_LINUX}/release/istio-sidecar.deb
  - ${TARGET_OUT_LINUX}/client
  - ${TARGET_OUT_LINUX}/server
- name: app_sidecar_base_debian_10
  dockerfile: pkg/test/echo/docker/Dockerfile.app_sidecar_base
  files:
  - tools/packaging/common/envoy_bootstrap.json
  - tests/testdata/certs
  - pkg/test/echo/docker/echo-start.sh
  targets:
  - ${TARGET_OUT_LINUX}/release/istio-sidecar.deb
  - ${TARGET_OUT_LINUX}/client
  - ${TARGET_OUT_LINUX}/server
- name: app_sidecar_base_ubuntu_xenial
  dockerfile: pkg/test/echo/docker/Dockerfile.app_sidecar_base
  files:
  - tools/packaging/common/envoy_bootstrap.json
  - tests/testdata/certs
  - pkg/test/echo/docker/echo-start.sh
  targets:
  - ${TARGET_OUT_LINUX}/release/istio-sidecar.deb
  - ${TARGET_OUT_LINUX}/client
  - ${TARGET_OUT_LINUX}/server
# Test base images
# TODO: add args:
- name: app_sidecar_base_ubuntu_bionic
  dockerfile: pkg/test/echo/docker/Dockerfile.app_sidecar_base
- name: app_sidecar_base_ubuntu_focal
  dockerfile: pkg/test/echo/docker/Dockerfile.app_sidecar_base
- name: app_sidecar_base_centos_8
  dockerfile: pkg/test/echo/docker/Dockerfile.app_sidecar_base_centos
- name: app_sidecar_base_centos_7
  dockerfile: pkg/test/echo/docker/Dockerfile.app_sidecar_base_centos
