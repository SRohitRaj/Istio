apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: {{ .Release.Namespace }}
  labels:
    app: istiocoredns
    release: {{ .Release.Name }}
data:
  Corefile: |
    .:53 {
          errors
          health

          forward . /etc/resolv.conf {
            except {{- range $.Values.global.podDNSSearchNamespaces }}{{ . }} {{- end }}
          }
          
          prometheus :9153
          cache 30
          reload
        }

    {{- range $.Values.global.podDNSSearchNamespaces }}
    {{ . }}:53 {
          grpc . 127.0.0.1:8053
    }
    {{- end }}
---
