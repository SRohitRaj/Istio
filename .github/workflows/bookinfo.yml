name: Bookinfo

on: [pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@master
    - name: Setup k8s cluster
      uses: engineerd/setup-kind@v0.1.0
    - name: Build Productpage
      run: |
        sha=${GITHUB_SHA:0:7}
        app="${GITHUB_REPOSITORY#*/}"
        docker build -t $app:$sha $GITHUB_WORKSPACE/samples/bookinfo/src/productpage
        kind load docker-image $app:$sha
    - name: Deploy Productpage
      run: |
        export KUBECONFIG="$(kind get kubeconfig-path)"
        sha=${GITHUB_SHA:0:7} && app="${GITHUB_REPOSITORY#*/}" && kubectl create deployment $app --image=$app:$sha --dry-run -o yaml | kubectl apply -f 
        
#     - name: Deploy Bookinfo
#       run: |
#         export KUBECONFIG="$(kind get kubeconfig-path)"
#         kubectl apply -f $GITHUB_WORKSPACE/samples/bookinfo/platform/kube/bookinfo.yaml
    - name: Sleep for 60 seconds
      uses: jakejarvis/wait-action@master
      with:
        time: '60s'
    - name: Check
      run: |
        export KUBECONFIG="$(kind get kubeconfig-path)"
        kubectl get pods --all-namespaces
        kubectl get svc --all-namespaces
      
#     - name: Build the Docker image
#       run: docker build . --file Dockerfile --tag my-image-name:$(date +%s)
