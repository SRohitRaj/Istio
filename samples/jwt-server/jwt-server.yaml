# Copyright Istio Authors
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

# Example configurations for deploying a jwt-server server separately in the mesh.

apiVersion: v1
kind: Service
metadata:
  name: jwt-server
  labels:
    app: jwt-server
spec:
  ports:
  - name: http
    port: 8000
    targetPort: 8000
  - name: https
    port: 8443
    targetPort: 8443
  selector:
    app: jwt-server
---
apiVersion: v1
kind: Secret
metadata:
  name: jwt-cert-key-secret
stringData: 
  example.crt: |
    -----BEGIN CERTIFICATE-----
    MIIDRTCCAi2gAwIBAgIUBeTBvkDJcwG0pIYWP/VphzEGWVEwDQYJKoZIhvcNAQEL
    BQAwRjELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAkFaMRMwEQYDVQQKDApBY21lLCBJ
    bmMuMRUwEwYDVQQDDAxBY21lIFJvb3QgQ0EwHhcNMjExMDI5MTYwNjEwWhcNMjIx
    MDI5MTYwNjEwWjA/MQswCQYDVQQGEwJVUzELMAkGA1UECAwCQVoxEzARBgNVBAoM
    CkFjbWUsIEluYy4xDjAMBgNVBAMMBSouY29tMIIBIjANBgkqhkiG9w0BAQEFAAOC
    AQ8AMIIBCgKCAQEApJ5TZ4wD/J4GNbybLUjZ3I22ydogI+pEivuomTlqqJVoQVJl
    r6HtmRQ+Ii5YFBsKoJt7H94T4mO3kC9f6JHyc/na3BS8ZK1S43rps6p2jk7/iU8w
    BqF344YVFLdaij7cIm0ZsMu0ZegoLMewOCGoEDd6E4vybXMsJP2UtB1+p/IcX8ba
    S7hOjpoIV1Kmz4esyn39o0Zv4ROad07tWKM3OhcSEPY0A8Cr6th0V62UL/AGHqec
    VKUzFQMNX5nxYJOyY0rdjOB1LeMIn72Z2v8wuVT9iiDGVaeSgRAM9IRlF+6bROG5
    kIIdxTK+jXRJd0Os5oDw5e4L7z5mGQhOT/uhOwIDAQABozIwMDAuBgNVHREEJzAl
    gg8qLmxvY2FsaG9zdC5jb22CByoubG9jYWyCCWxvY2FsaG9zdDANBgkqhkiG9w0B
    AQsFAAOCAQEAMobpQMkO8K4rNVxcNlCBek/8t6kgSuRDQkylSF2ozzPa9tLVkyep
    PhA8wmryr3AY7qHf1Tybys3ZByuu6RBCivq8GqgqvjZWroczQcvzcQForhgf2gvG
    ePZ2qOxyNe5N1gaXG1afJuzGay5SEG70kQJS2z97Cpn+Kioca70gpM4ZySUcMTuK
    tqi3sxpuv0FSvpWN2il7FB8+3XZOkSqM6aaAY6ZS2l5an8aV+x6Y7HqfEXG5Jefb
    1Exd1p2jG1mtLzQ7g9AC53fyjV2Uef0F97GkxjyRXBMH7rnsYMa09vc8zTX1GmCs
    Yayl8f9F8jPeWWg7dg0OnH0X2sssgQIVdw==
    -----END CERTIFICATE----- 
  example.key: |
    -----BEGIN PRIVATE KEY-----
    MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCknlNnjAP8ngY1
    vJstSNncjbbJ2iAj6kSK+6iZOWqolWhBUmWvoe2ZFD4iLlgUGwqgm3sf3hPiY7eQ
    L1/okfJz+drcFLxkrVLjeumzqnaOTv+JTzAGoXfjhhUUt1qKPtwibRmwy7Rl6Cgs
    x7A4IagQN3oTi/Jtcywk/ZS0HX6n8hxfxtpLuE6OmghXUqbPh6zKff2jRm/hE5p3
    Tu1Yozc6FxIQ9jQDwKvq2HRXrZQv8AYep5xUpTMVAw1fmfFgk7JjSt2M4HUt4wif
    vZna/zC5VP2KIMZVp5KBEAz0hGUX7ptE4bmQgh3FMr6NdEl3Q6zmgPDl7gvvPmYZ
    CE5P+6E7AgMBAAECggEAdhEICNAnW9uK4KexND134/PQEd3cB2ZSWsw8FAlWMitW
    ZuNOAzXET3JxTdqnWWQ7rw1UtXp2EH0sfsE7rHZgykV9bzOAG0Ukmfrh+vZbqZ2H
    MVgWPes5LXpRTFZlHZoQELDnKCIx9JUZm2RtQxUAkQD5EWPiMBXWp4EoUjaFTLX2
    bTarJcTlMAZ3FwHvJM29/E7BwJ2yLSPyNQHNgZngPn9YUoyhFA5HJ3JW6xrbDQ1V
    dDWQQjOKc7yDZRVxCF68wI9jSTRB5ezM6sohHFKbbYFhnLNrwYygR7+CGdawvOxW
    vrEU0vVm4b+nVPTMhLzqrvKa26MerXXnRbA1ApJxgQKBgQDVLxzf5glN8B+6EkKZ
    9YtSsVKtDJwbunR19n7SAiPdcvvc3AbnCHG4T84LFnHdULo9k+pCrWr+DLf5FAMI
    5OgfuhI+Hfj5RlnEqpoTj2WQoYpp8D+0wfdl4kQPJ4c9U/XTye87QCU+wTC6kc/s
    9EDoOIPR9yLpYFOG0iz3iJ3eiwKBgQDFrjUIQBTxH+gWS4yV42+PQ+h3Tfh1KXxa
    2j3px4X8NR/rfxvalTnCOwY8vUqU/wPAH9gZoJV7/cbNnWOXj/QiRimMUv/pCYzd
    yU/Ql4YQPlNDSfFnu5jPdsc7bJsmkcW85dlbEKDgBbylIEjKFXdSvisUAY/NAQEc
    bjnOtsTOEQKBgQCYf5A3NhYX05rOfzt3aOfWKpTKx4dwamve6oqD7hX71sIGlrq1
    UBwRTb1FvzOKrrHbVNEyC13LCAweuEsHdL/72h4so0I0Bzg18Bgxv9VWpcgeyka4
    Jjy0fCxVbuBWZZYnf3+LsfIytv4FqELF7V/0/mCFtTUbHtYBTp3uIKNVywKBgA/8
    iqVkKU1muyoyaeglQHxhjYc4cwNmm3vtclxZmmhPE4nD+civkMA4bcSzujhadz8u
    VBeeePhSCaXPOKKlLaUn72w9uhxqfU3iXeYMmvbtU2Z5sGAnN7BvdqVDnzh7SXaB
    UBahPaFgVWU1Oy28lq3GW01+4tY9Yo2eDGa/OSNBAoGAfnSyuDuXiHqT6X4/pnnP
    40euo1B0nF4pEPweD2SCnhKBem9VHh5h3FmFM7IPDoCeYpRKkx5k50knSXeRhSHd
    tGqPTf22viKyetUBw0vwb4CUYzM3NG/TKUYSZs6gniL0KdOeXrOtZn/fCE7YXzFs
    mu3NmmdyM5cRoTNi80vy44g=
    -----END PRIVATE KEY-----
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jwt-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jwt-server
  template:
    metadata:
      labels:
        app: jwt-server
    spec:
      containers:
      - image: docker.io/istio/jwt-server:0.6
        imagePullPolicy: IfNotPresent
        name: jwt-server
        volumeMounts:
          - name: certkeysecretresource
            mountPath: "/app/https/secretresources"
            readOnly: true
        args: ["-https", "8443", "-cert", "/app/https/secretresources/example.crt", "-key", "/app/https/secretresources/example.key"]
        ports:
        - containerPort: 8000
        - containerPort: 8443
      volumes:
      - name: certkeysecretresource
        secret:
          secretName: jwt-cert-key-secret
          defaultMode: 0400
---