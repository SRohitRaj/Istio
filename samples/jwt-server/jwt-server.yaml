# Copyright Istio Authors
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

# Example configurations for deploying a jwt-server server separately in the mesh.

apiVersion: v1
kind: Service
metadata:
  name: jwt-server
  labels:
    app: jwt-server
spec:
  ports:
  - name: http
    port: 8000
    targetPort: 8000
  - name: https
    port: 8443
    targetPort: 8443
  selector:
    app: jwt-server
---
apiVersion: v1
kind: Secret
metadata:
  name: jwt-cert-key-secret
# command to generate certificate
# https://github.com/istio/istio/blob/master/samples/jwt-server/testdata/README.MD
stringData: 
  example.crt: |
    -----BEGIN CERTIFICATE-----
    MIIDNzCCAh+gAwIBAgIUaWsrhw0rt8BTBrx3yLpCJEc2BM0wDQYJKoZIhvcNAQEL
    BQAwRjELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAkFaMRMwEQYDVQQKDApBY21lLCBJ
    bmMuMRUwEwYDVQQDDAxBY21lIFJvb3QgQ0EwHhcNMjExMTEwMjExODMwWhcNMjIx
    MTEwMjExODMwWjA/MQswCQYDVQQGEwJVUzELMAkGA1UECAwCQVoxEzARBgNVBAoM
    CkFjbWUsIEluYy4xDjAMBgNVBAMMBSouY29tMIIBIjANBgkqhkiG9w0BAQEFAAOC
    AQ8AMIIBCgKCAQEA5IovdxgVfwqhk7HnGNTdhtNnKLeqsfNy15XUK/gWRAMnY8Im
    d8l+b2/QCk+zZvn8xf8ATe5klpMP85yuG8xi97pv2fZhzvZCbUyR9CJqnA5FQe7i
    itmrL7velvIHJpqdyxVUaUNPOII0NNL1w8ZDHNymNycc+BQZcGvXnRO66EXiBSv1
    346o4MX/qQ7T7WdPwKw6+8dQ1T55n3pA3mGeVCUfVlWG/3vh/uOmD/eZjLn68JWL
    VmYl9QY4UFbYsAmN4RCcNLDyTHoJ/QAenHlBOQ9ogIixH9nhQoyN1aspRjECoP0N
    33LoV2ugYK6+slqrTlC/i9IzBg5Fe6ld6PirpwIDAQABoyQwIjAgBgNVHREEGTAX
    ggpqd3Qtc2VydmVygglsb2NhbGhvc3QwDQYJKoZIhvcNAQELBQADggEBAFHjOubE
    rvkIMirO4iQFfMEyz5DvgLCXAfCLyPJvnYc2sgupuLypwWlmm/N2+iHBOwfJUGWS
    sV7LOVy63RV+Gg/CjDnNNSf6EZcEJpXQRKzC1QZ+5vzDIYQ+Agegm3CEaOBKm8Qh
    U+r+Uang1iw5Gxr0MMBIwmV4AZlkYOLnBgsAx0G4L4wkWEnSHsV7edcr1epU8Y3S
    OBWIJNY95iwFtLPrlUDYenxAjU8IlntlM5iF3hvqdZGObdpQQG3xuXNhHi7gEULN
    Z4s9kB70016WKXl5hgxnQt5Tt5BMKQAFuMoqqGLaG6I/OTS+ujHObHmGxebok9YH
    YuKt86BGxZynxsA=
    -----END CERTIFICATE-----
  example.key: |
    -----BEGIN PRIVATE KEY-----
    MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDkii93GBV/CqGT
    secY1N2G02cot6qx83LXldQr+BZEAydjwiZ3yX5vb9AKT7Nm+fzF/wBN7mSWkw/z
    nK4bzGL3um/Z9mHO9kJtTJH0ImqcDkVB7uKK2asvu96W8gcmmp3LFVRpQ084gjQ0
    0vXDxkMc3KY3Jxz4FBlwa9edE7roReIFK/Xfjqjgxf+pDtPtZ0/ArDr7x1DVPnmf
    ekDeYZ5UJR9WVYb/e+H+46YP95mMufrwlYtWZiX1BjhQVtiwCY3hEJw0sPJMegn9
    AB6ceUE5D2iAiLEf2eFCjI3VqylGMQKg/Q3fcuhXa6Bgrr6yWqtOUL+L0jMGDkV7
    qV3o+KunAgMBAAECggEAMNzKoS/pCKyBN07GFi0M4BK67521RS7D0wwZvPzh5dC2
    z0FncB0Ih1LkrA+2T8ILJVoL+p2JrBftRSyunQrp7gVSfMuMxe8o7K1+VzA0kwEK
    Fbq5fO5lB2Onh6ZfmQVdz1nUHl1hxrcv6ktgeGcfWkBi2U/nhbLmbX7hLphVUeuX
    keF6swYPd21yaAWB/l8VWWVDRL883o+noWbCPm7/BIMADNuRpV24Rb/tGFFrfgXf
    FrW23NYMPFd3PfoFIh7MKKHWPHwy5dzBd982nyY11p7T1pWrah2t/aC5O90mFINN
    uayIoX5OAXpc/LHa4sW2QhDW6SRO1xNbwkwN4l9T4QKBgQD7R5zqnNNFCa6mXUgA
    dBmMENFa7ure1apnYGg167ps/+nUa+JpAkBaEGFvosx+glHXrYGbLWAcmRTpNlY7
    1qrM10AnpRM+Ih0eWCQOMoEpHt8c0KuxNESyeggx8WQG1otFc7FBmqFFsXqbIYXp
    AOXTTasqaia2DVuzjsnsqEodawKBgQDo1Tez2PiV8i/xfsnJGUG2FdPGN1kXMynY
    fmMrFNT8yxikcRIFWBU0/s1JfvQ50U5kqH+hL+Bhc0K6W2LZSKwtbT1wR6kdlSO1
    /dvfVX3QGmVOlZmVTNUgQMHpzYGi4XsqV0aj5DnuEiqiwHWmU2Qpox7gu7y8RSwf
    q7BNZiZdtQKBgGvNKVCtvyWbJcZRtpYbOOqSPH7aiQDYgaagAZVAcFZa5CIxtox+
    XsVEychu+3Q6zInO8g90xAsA0avLl+tMCTKgFfHsK/k4AW4HOlCs8iSGDgn6q+32
    EpLPL7zdZqBYYp+FJsKSaCXSIltzYlO4AuFILOqhZ8IqsPCzjYVuHX3JAoGAZ62i
    SzyfnS2mObRKqHjNsQZRMh+tVU5cIOJOyH1TRmotw/PxoV2Su/GGembE3AYfEWWS
    x7TpBpvrp85P2w+oU+YkCJ5waRLjPwQW54FLL+LBH9gv9rKq6NzNPI5dXqlnTfhl
    JU/Yl/GQ+L4Y5YKWxI+1jT8sEO4Acu3h6OVGyk0CgYEA8hcYzt3G7WluRS0LkhAc
    LOdkdbWl/vE2nyyKf0hYBZTXmBeXHByFuMLZ6nuPhnLCGQzvkWPS2MzvUQkXXtWB
    OVGnrvPGzSwMS/NRUd5zjPrXCM29sht6R/ow3QkehCwcC63fup/zF+5/n4yXk6Th
    3Py+pPcI4s+sqlF+xuVPBIU=
    -----END PRIVATE KEY-----
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jwt-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jwt-server
  template:
    metadata:
      labels:
        app: jwt-server
    spec:
      containers:
      - image: docker.io/istio/jwt-server:0.6
        imagePullPolicy: IfNotPresent
        name: jwt-server
        volumeMounts:
          - name: certkeysecretresource
            mountPath: "/app/https/secretresources"
            readOnly: true
        args: ["-https", "8443", "-cert", "/app/https/secretresources/example.crt", "-key", "/app/https/secretresources/example.key"]
        ports:
        - containerPort: 8000
        - containerPort: 8443
      volumes:
      - name: certkeysecretresource
        secret:
          secretName: jwt-cert-key-secret
          defaultMode: 0400
---