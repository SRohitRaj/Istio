# Copyright Istio Authors
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

# Example configurations for deploying a jwt-server server separately in the mesh.

apiVersion: v1
kind: Service
metadata:
  name: jwt-server
  labels:
    app: jwt-server
spec:
  ports:
  - name: http
    port: 8000
    targetPort: 8000
  - name: https
    port: 8443
    targetPort: 8443
  selector:
    app: jwt-server
---
apiVersion: v1
kind: Secret
metadata:
  name: jwt-cert-key-secret
# command to generate certificate
# use the generated server.crt, server.key by following https://github.com/istio/istio/blob/master/samples/jwt-server/testdata/README.MD
stringData: 
  server.crt: |
    -----BEGIN CERTIFICATE-----
    MIIDbzCCAlegAwIBAgIUBqxnhknLA7ddC+GxO/NEPaFJpEMwDQYJKoZIhvcNAQEL
    BQAwRjELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAkFaMRMwEQYDVQQKDApBY21lLCBJ
    bmMuMRUwEwYDVQQDDAxBY21lIFJvb3QgQ0EwHhcNMjIwNTI0MjEwMjIxWhcNMzIw
    NTIxMjEwMjIxWjA/MQswCQYDVQQGEwJVUzELMAkGA1UECAwCQVoxEzARBgNVBAoM
    CkFjbWUsIEluYy4xDjAMBgNVBAMMBSouY29tMIIBIjANBgkqhkiG9w0BAQEFAAOC
    AQ8AMIIBCgKCAQEAvcETtRIexulYmujM7a/J7ejiE2EWRhtcxK0gDfr8SF4wick3
    Id3TU2RElOVzxPyRd9xDPaUMSHEu4JEBnTn+J6J5CCxY6BquF1h+61dfHAbv3wng
    8iNKzLt47ppBpPVuBVcOWrFRwNHCkkk1nvbbKVAw2PFsa5SUe82kBV1RWQs3DkcI
    bmshbxO97sCxT2FI7woCUsZNP0pkAVe08w00PfF9X+q/OrxdT+oB0Rbpz1ThhL0r
    r4hr0Er/PkX2T+7KN7XuyikpbeE5yNJZT643UIzucZ5xH+MxzpBwTuHebbDhhyOr
    YiptbpnY0WpkoJCPKbTR+oOAITFNlhImJOSo4wIDAQABo1wwWjBYBgNVHREEUTBP
    ggpqd3Qtc2VydmVygglsb2NhbGhvc3SCEWp3dC1zZXJ2ZXIuandrc25zgiNqd3Qt
    c2VydmVyLmp3a3Nucy5zdmMuY2x1c3Rlci5sb2NhbDANBgkqhkiG9w0BAQsFAAOC
    AQEAlKu5jTd/S+omBVAaB11oIMzu0DRPl06AG+ZkoIaod/2rvOHT2emfSAdjXMny
    UF8bTwhussIRg4lKMkx+eDWvIBfEhLNxvNQ0lnBLNgwIqwKeMrO6oY1ZxVEi50XG
    TMfxJse1oXvB1+3NHgNPMWApP8A+BEFQo4hcYP/DLPOus6177x1PlmcaKbi5sozh
    iYCjmAjEyYR/cUd1UEFeuQcAyrSod4fvd/xWOJwaVDXsNOFlVtCHYsczDyNqa0Mq
    U6fTJ9Pl5ZrsJ/fbZhZkzL2FIsE1/46yciUxcM0H20T/oYF9xB1+DlfjXQ+4k+es
    x5ixg7zF3n924efdTHXtRuPvsQ==
    -----END CERTIFICATE-----
  server.key: |
    -----BEGIN PRIVATE KEY-----
    MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC9wRO1Eh7G6Via
    6Mztr8nt6OITYRZGG1zErSAN+vxIXjCJyTch3dNTZESU5XPE/JF33EM9pQxIcS7g
    kQGdOf4nonkILFjoGq4XWH7rV18cBu/fCeDyI0rMu3jumkGk9W4FVw5asVHA0cKS
    STWe9tspUDDY8WxrlJR7zaQFXVFZCzcORwhuayFvE73uwLFPYUjvCgJSxk0/SmQB
    V7TzDTQ98X1f6r86vF1P6gHRFunPVOGEvSuviGvQSv8+RfZP7so3te7KKSlt4TnI
    0llPrjdQjO5xnnEf4zHOkHBO4d5tsOGHI6tiKm1umdjRamSgkI8ptNH6g4AhMU2W
    EiYk5KjjAgMBAAECggEBAIJ3MhmZL9gLsIQx9FSoPOp66JXyduIVBh+j+RojqzoG
    qNDTrDh40EfR9OV7LbIPBeWnaAQGav+T8mssyDNWIE0YBKd99lL/pRsgGYOuOxKG
    In7zx9o0McW6UFedb+z/YnoBdTkeGdu9XU4/T8LQb7dkD3HZ7HW7XqwQo+mcU8Yo
    I/aHEWRlqAHjMVD/T72vgZIS+0gdZfDj4E+d9653CdqdjxPTrJbsm5vhrrKR6xzT
    3QPEi8mkLCiUR3yqFJrpdNuKL4mX2xUD3u50uwQNvn52vmUgzmTq+9G2KTg0I/Bc
    HcaRKcSBq6w8sjWjQff1ddrUrL/0YUaXt0gNHoz2b2ECgYEA7UqWKTUEO0gZ+kEm
    rP4ZgqwhTjMr/Fl/9D+RjuC3UfuaUQVmqpSEuhivY1ThNI623AnZy6oGPm4JwzVn
    AikAD4OcTtjEZLguovVoqBGU1KFev9PsPGle5AM3lux1V9wpNd4YhYT3bJLlmaUa
    gpkplDLr8sJT6cVzfTvgqyMFleUCgYEAzLcEBi2ojMyUQVMyblM9ME+nnFujmVUt
    /TOo+TWilGpuY4ucDa47iCt+012MyBlJIdINq1fjRaZtmAVoY4uvQkypAO+CyN0Q
    TvSSKF0pB1muUy6Bh/fvW75h5l6wc1zgD0XJIQ8+Uct0FFhvp7KYSKj1gbllMHEB
    tM+FgPMSVycCgYAlzdE4hWrEKwuAdCq+OslDqTqxI7PpQzUAa7Q76A8sr4H5UHv3
    xyuSHmaq05YBco8tZSBesxrFjXBeuj5L+M46qoQXh69aQIGlkqV2yT5F1eOreg7T
    3RGyD9UmZUuYkMm7/EM52mI02P5dSRF9JvuZ0bcHePA3eS6aEBUODslQBQKBgEKS
    QXzA3E7tOEkGBSBbcUqEnLz8D/eM+6ebZRelmXkqIzu76sOIJVPi0RtrEJ0BnAaj
    iE5wBjhgJsOI/qlgg13MECl9ucoYGXWTkvQNV4pMX6QtO3I77lqnTq7bnAXn7fUJ
    fJ6DloCC6Py0xZqDOYJnb28AGyfll+h0k7WbVhuBAoGBAMKgssg6YNWnHvWSClpt
    gIg5AhmEcqf8UmQGleYMRIy6raavMYaZYxoz8eb5VY/aF+0CL1XUBujuliz4lE4A
    MGF4a0UMoxXjtdoEn0NwPGlCb6vFJE/k5iiuQEllJClgSQU+5AkaKPymYVwK/aCQ
    Ysx3Fo0N7jVEh1R4fNR4NSBt
    -----END PRIVATE KEY-----

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jwt-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jwt-server
  template:
    metadata:
      labels:
        app: jwt-server
    spec:
      containers:
      - image: docker.io/istio/jwt-server:0.6
        imagePullPolicy: IfNotPresent
        name: jwt-server
        volumeMounts:
          - name: certkeysecretresource
            mountPath: "/app/https/secretresources"
            readOnly: true
        args: ["-https", "8443", "-cert", "/app/https/secretresources/server.crt", "-key", "/app/https/secretresources/server.key"]
        ports:
        - containerPort: 8000
        - containerPort: 8443
      volumes:
      - name: certkeysecretresource
        secret:
          secretName: jwt-cert-key-secret
          defaultMode: 0400
---
# apiVersion: networking.istio.io/v1beta1
# kind: DestinationRule
# metadata:
#   name: jwks-server-rule
# spec:
#   host: jwt-server.jwksns.svc.cluster.local
#   trafficPolicy:
#     tls:
#       mode: SIMPLE