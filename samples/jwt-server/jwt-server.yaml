# Copyright Istio Authors
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

# Example configurations for deploying a jwt-server server separately in the mesh.

apiVersion: v1
kind: Service
metadata:
  name: jwt-server
  labels:
    app: jwt-server
spec:
  ports:
  - name: http
    port: 8000
    targetPort: 8000
  - name: https
    port: 8443
    targetPort: 8443
  selector:
    app: jwt-server
---
apiVersion: v1
kind: Secret
metadata:
  name: jwt-cert-key-secret
# command to generate certificate
# use the generated server.crt, server.key by following https://github.com/istio/istio/blob/master/samples/jwt-server/testdata/README.MD
stringData: 
  server.crt: |
    -----BEGIN CERTIFICATE-----
    MIIDNzCCAh+gAwIBAgIUHwGzTNIiabqPqcvi1zMOKnI58TQwDQYJKoZIhvcNAQEL
    BQAwRjELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAkFaMRMwEQYDVQQKDApBY21lLCBJ
    bmMuMRUwEwYDVQQDDAxBY21lIFJvb3QgQ0EwHhcNMjExMTExMjMzNzEwWhcNMzEx
    MTA5MjMzNzEwWjA/MQswCQYDVQQGEwJVUzELMAkGA1UECAwCQVoxEzARBgNVBAoM
    CkFjbWUsIEluYy4xDjAMBgNVBAMMBSouY29tMIIBIjANBgkqhkiG9w0BAQEFAAOC
    AQ8AMIIBCgKCAQEA88fGFszZuZxPJPS6PG0XQEwZfwFxizF3oUrlfFoBJL9UZprD
    XF3nS0W8PVd41mzfrTY6UaX8WT2Focj1/+L9W99zKJr8UOa2ev99zMH2C45rRHDP
    bdNpmDzVVb77t3kZH2CJoCmDkIJ87kJstKTnfScAAw4EXGjzNljY1eayRzZdSoMn
    PGmxOa0+deWa32hnrWA1RPNhnjQPOStm/yzqdTkTjF7GzCQL6KBF9GgiIdX1RhgQ
    eKJNEy/7FGeOFjEkVq/gTYOs5hbcAUsBhztv44Rq4wfXjNGFMMYAM8lKPOaGcWoH
    00iNf2XGTCx/FfBF+XfoSg1yzraYG/kkkJ0gpQIDAQABoyQwIjAgBgNVHREEGTAX
    ggpqd3Qtc2VydmVygglsb2NhbGhvc3QwDQYJKoZIhvcNAQELBQADggEBABjiQmNf
    LaIQCH7JXSZMBPAWJDBiTySSgNVPLMT1rB60NU/ycrpmaj7JJwH8jW2m1J1HCA27
    G8e+foatiHKnMAxqvlpxrtDheZKTliZerHNNxkQGfvUccmLoHshXFUkYGtnEFrIg
    hK3ZYQkGh3XvDaPswpMvMpg33RSWijbVZhrVmHArgM4EEwyKLz3sR5DZx7Z+cOLd
    IRq6eFA3V34ReKononkGZgKzDwmg21ZCKGYeHcujv5RHREPmm7vzS+VlPKtgAYeJ
    FO+KS+6eG86bQiLc9EfjYNHx3WYmtojcyRkO9XGj8AGaILE1SEziW8zsWdYlqK2H
    nJQcWI2cTD0qwoI=
    -----END CERTIFICATE-----
  server.key: |
    -----BEGIN PRIVATE KEY-----
    MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDzx8YWzNm5nE8k
    9Lo8bRdATBl/AXGLMXehSuV8WgEkv1RmmsNcXedLRbw9V3jWbN+tNjpRpfxZPYWh
    yPX/4v1b33MomvxQ5rZ6/33MwfYLjmtEcM9t02mYPNVVvvu3eRkfYImgKYOQgnzu
    Qmy0pOd9JwADDgRcaPM2WNjV5rJHNl1Kgyc8abE5rT515ZrfaGetYDVE82GeNA85
    K2b/LOp1OROMXsbMJAvooEX0aCIh1fVGGBB4ok0TL/sUZ44WMSRWr+BNg6zmFtwB
    SwGHO2/jhGrjB9eM0YUwxgAzyUo85oZxagfTSI1/ZcZMLH8V8EX5d+hKDXLOtpgb
    +SSQnSClAgMBAAECggEARbRClLRgMO1bx/Jd6fc7Zbwcsi8Ee0tarHjQ41yM5Sf8
    BxaLc7a58tDuwQ9o0s7wqgNOa5gtborj0d23UUJjNUjQEbU3Hh7J4KN7Iff31VgU
    nc4v0XRYxhnm2gywxsZOg6VD1NLp9oEJHctKb+CS/DsRis4QOygbGtgOsCK1qRx4
    bgEr8deuW7zvQ4j7V9HneiE8vF58vG74sCYNl8aB0T/BY2ppKMYHkoBZ4c8BoL2H
    pmX10W6P7wdbok6Qy/vS8hLOAaPlRsxuBiS+OwH8h6S8o/nLSfqZ7flf/F8YUy2v
    eQ/GsLbNjk3muB8SDllskZ79IjClzyvUJtptChSrgQKBgQD/BAPPD1ecZ9/REsXM
    FKRjZAA2pm9LrqFJ+A9cWQEdRQLYdnfPIC21y1XLp5BdWg49Wezg0YFo+2NTQ+0a
    y8DxtJ/thn922WV7Tae3GeUbMJ1ByJu+6Ps2u8EwZTfw/FC3sWLiD5ok26qNTWhs
    I1geEixr6i1ogLiHZtVpWJpVoQKBgQD0uKg4Sk+fefu5v2q978jZSzygkPJ7Slti
    wR6yB8CzvZXWfqWCEoPx+DAQqx8PsGPHxUs4E5gpyPuut8ofNhoJYI8+YwtGcodR
    HrR8OeK4n3yOo2YN57/LN+TNwtvgHQZJSD3n1K7UHKfEwB4rDd6YS3dGGHTk8X8U
    IJQD8eQkhQKBgDZnB9z7W+hc7I1woMu5t5wQcE84UFPn7DaYecZsomU5HLNLCqIg
    LkAzIZlxpMWVeaYy8erAJwhbYMQZoJJv1zh5HQkSAU08cX7NgTL5jjuvskyfXEJs
    93KkuUD2xuldGmclq3+obmzgg9DjK5yuKZU4sUtQSOGbXEJeeLahlUMhAoGBALMl
    mr/aZn9wZP6NSi7RIk8v7Kn+cgQfYtbgWQAq/L6XwuDKxY56z2yLK2SIYKyzi9fq
    bi4W6gVsxBIbKTO//z9uGG6rQs3HeZfAyo9GMNrGpgAlTchQJu81c6HNS/i8RqXO
    5MKZx4IvmAFIQs1x0cnbNO1zad9Pip/JWZGpukGhAoGAF5f8/HKHInQVQDUXkQch
    9lNsIkv/EyPjxp1rsxrKE5xWJ/ktF2Hp85jyM3V8HbHySlI5IpdP5JitpaH9XqtW
    Xm8I7kQIfGInq6WXWY3dKiPVrA8qlmPvQ/5knjZvEWTATygiY4+QdgzhZd7XW+pY
    07ztOiMKRiomyDjBDnDPFTI=
    -----END PRIVATE KEY-----
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jwt-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jwt-server
  template:
    metadata:
      labels:
        app: jwt-server
    spec:
      containers:
      - image: docker.io/istio/jwt-server:0.6
        imagePullPolicy: IfNotPresent
        name: jwt-server
        volumeMounts:
          - name: certkeysecretresource
            mountPath: "/app/https/secretresources"
            readOnly: true
        args: ["-https", "8443", "-cert", "/app/https/secretresources/server.crt", "-key", "/app/https/secretresources/server.key"]
        ports:
        - containerPort: 8000
        - containerPort: 8443
      volumes:
      - name: certkeysecretresource
        secret:
          secretName: jwt-cert-key-secret
          defaultMode: 0400
---