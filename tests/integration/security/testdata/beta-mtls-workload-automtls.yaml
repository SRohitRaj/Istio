# The following manifest is for testing auto mTLS.
# Serivce a consists of v1 and v2 deployment, and only v1 is mTLS enabled by workload selector policy.
# We use VirtualService and DestinationRule to ensure request hit the v1 and v2 subset.
# We expect both v1 and v2 requests can succeed.
---
apiVersion: "security.istio.io/v1beta1"
kind: "PeerAuthentication"
metadata:
  name: "default"
  namespace: {{ .Namespace }}
  annotations:
    test-suite: "beta-mtls-workload-automtls"
spec:
  selector:
    matchLabels:
      "app": "a"
      "version": "v1"
  mtls:
    mode: STRICT
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: a-route
spec:
  hosts:
  - a.{{ .Namespace }}.svc.cluster.local
  http:
  - name: "v1-route"
    match:
    - uri:
        prefix: "/v1-route"
    rewrite:
      uri: "/"
    route:
    - destination:
        host: a.{{ .Namespace }}.svc.cluster.local
        subset: v1
  - name: "v2-route"
    route:
    - destination:
        host: a.{{ .Namespace }}.svc.cluster.local
        subset: v2
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: a-subset
spec:
  host: a.{{ .Namespace }}.svc.cluster.local
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---