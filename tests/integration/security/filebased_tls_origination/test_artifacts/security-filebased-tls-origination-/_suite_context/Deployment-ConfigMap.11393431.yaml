apiVersion: apps/v1
kind: Deployment
metadata:
  name: external-service-v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: external-service
      version: v1
  template:
    metadata:
      labels:
        app: external-service
        version: v1
        test.istio.io/class: naked
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "15014"
        sidecar.istio.io/inject: "false"
    spec:
      containers:
      - name: app
        image: mcr.microsoft.com/oss/istio/app:1.18.0
        imagePullPolicy: Always
        securityContext:
          runAsUser: 1338
          runAsGroup: 1338
        args:
          - --metrics=15014
          - --cluster=cluster-0
          - --grpc=7070
          - --port=8080
          - --port=8443
          - --tls=8443
          - --port=3333
          - --version=v1
          - --istio-version=
          - --crt=/etc/certs/custom/cert-chain.pem
          - --key=/etc/certs/custom/key.pem
        ports:
        - containerPort: 7070
        - containerPort: 8080
        - containerPort: 8443
        - containerPort: 3333
          name: tcp-health-port
        env:
        - name: INSTANCE_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        readinessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 1
          periodSeconds: 2
          failureThreshold: 10
        livenessProbe:
          tcpSocket:
            port: tcp-health-port
          initialDelaySeconds: 10
          periodSeconds: 10
          failureThreshold: 10
        startupProbe:
          tcpSocket:
            port: tcp-health-port
          periodSeconds: 1
          failureThreshold: 10
        volumeMounts:
        - mountPath: /etc/certs/custom
          name: custom-certs
      volumes:
      - configMap:
          name: external-service-certs
        name: custom-certs
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: external-service-certs
data:
  root-cert.pem: |
    -----BEGIN CERTIFICATE-----
    MIIDEzCCAfugAwIBAgIUIgtwQ4vuXRX3K7JQA/D0aEg5uckwDQYJKoZIhvcNAQEL
    BQAwGDEWMBQGA1UEAwwNY2x1c3Rlci5sb2NhbDAgFw0yMjEwMjAxOTMxMjBaGA8y
    Mjk2MDgwNDE5MzEyMFowGDEWMBQGA1UEAwwNY2x1c3Rlci5sb2NhbDCCASIwDQYJ
    KoZIhvcNAQEBBQADggEPADCCAQoCggEBAMPRkwjqS5Aa+wANqY2GGm7zqRw/PVdf
    OpmMJgEMI3i8w9esFSNMlQzx6HeuXMeRURWTQzoiNw3xZd7TyuUYQKBtZSzXBcgG
    e8T+XYJawERdTq5nI9OzSwXh3zC7x5GcQ8VNFP/+4WUNlxX32IM2hzaoVocrT9Sd
    dopO0yhb8QGqbtK1KE0E7677WIcvvSORMI9kugX7F0m0JCRXtU17yeeJ44xXowFq
    C7NAEgeLd440uVWtbjONfI+mZRDbbUkTUApvlVzhZ+sh/EGpjqRSYS1WmrmqtPs7
    KVVasmb6gD2WUUr3RRf+fCLw+ImP3WPdTaJpn285jdyXVT0oL5cUOa0CAwEAAaNT
    MFEwHQYDVR0OBBYEFPJgj82D0mj8lifyRv1p/Ov4gUqlMB8GA1UdIwQYMBaAFPJg
    j82D0mj8lifyRv1p/Ov4gUqlMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQEL
    BQADggEBAA0dZYDBYZUfDJeidlyuu0eNo3NC0bjX5PmPYSh5XdPLw+XFDpNI00qm
    qP24s6onosfcJ8MxUGiC6EGMG/OUZ+7qd8NoPnWdB9EGLYY/aSwq4PleS4i2riz2
    7SgB69cG94s1MIKUYGUuPlodP4HYpTA5ajJRBRYvSDhatweWWXnGyRCPzeDothDe
    EOCHRV6zasozDAZ4SL/OQsQdZeScQ1snmAxpqZtSN4uSrvXALaobN8asgTAW9jyr
    1CSErWmveZ1TrlyFp2lBjZDcHiT1+aQz3FeUdpx6086m6JtEPRnqZjOYFCBDIogb
    PUE/j6He279FXirBVEKDzKfvkllrQMs=
    -----END CERTIFICATE-----
    
  cert-chain.pem: |
    -----BEGIN CERTIFICATE-----
    MIIDKzCCAhOgAwIBAgIUIf2Vv9QwxTJgEJObGbJvHMthI2cwDQYJKoZIhvcNAQEL
    BQAwGDEWMBQGA1UEAwwNY2x1c3Rlci5sb2NhbDAgFw0yMjEwMjAxOTMxMjBaGA8y
    Mjk2MDgwNDE5MzEyMFowKzEpMCcGA1UEAwwgc2VydmVyLmRlZmF1bHQuc3ZjLmNs
    dXN0ZXIubG9jYWwwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDWUW8g
    fPxCYfSSYjgCVsxIonHYfehuU6XSQNPOukfmZ7D6KEA8mqQebTvhjvnFW+y67ZGb
    ZsmfcxQj5IyX9bDPgcHbyf4nusPrb++hXm/E/LaYiUE45eZqazG6hbIb44IObgi8
    Fq1XdoWhJoNgN9RRLj7fb70Cl4VHXLvzmjdC0LLwFjdMldjzP9HqyEir1/HfA07P
    oP7ak/al3Y/s5IXsgaqNkyKsbBpRVRBPDs77uKLuGnHgisyKyI/TxKMbVyD0p8Z+
    egsO4QfWa8zpboLl+Dp3aU+CaDbJjzBu/yp+XvnCmXJIbn+sfCvJBar3SeSLLtGK
    fRDqIzNjlCtSXFW5AgMBAAGjWDBWMAkGA1UdEwQCMAAwCwYDVR0PBAQDAgXgMB0G
    A1UdJQQWMBQGCCsGAQUFBwMCBggrBgEFBQcDATAdBgNVHREEFjAUghJzZXJ2ZXIu
    ZGVmYXVsdC5zdmMwDQYJKoZIhvcNAQELBQADggEBAMCc/eIDm4GO+75od8QFa4y9
    pGNyXxKnUtqW8VR4kxqt3KHHBG9UToY0cx1QWmYU9I6gdEyc9B+1Tgab7j+oNccL
    Xs8agbfjMdvUwVDWn8lCY3gM/wNTmyEHH5cv+QhogGGjJGCWsviH2SK46WSlZCW3
    mh26VxDlvcOmi8eWs/hKgvLwvmAuhvJua9Wg4XAA2alz9yOFv6seSfNeld1o1DnM
    B3uE//OqARdtaqrWeprbnENpbEIUyBjbJHJLHnCOsbRfqd7oVBkzVIRoNihP14ww
    5qwiQQqncFxlMwvyg1mhtiR21/yeZiWoBsfQf9qsF/hThHQ5Cs3MVxMupPv9Uso=
    -----END CERTIFICATE-----
    
  key.pem: |
    -----BEGIN RSA PRIVATE KEY-----
    MIIEpAIBAAKCAQEA1lFvIHz8QmH0kmI4AlbMSKJx2H3oblOl0kDTzrpH5mew+ihA
    PJqkHm074Y75xVvsuu2Rm2bJn3MUI+SMl/Wwz4HB28n+J7rD62/voV5vxPy2mIlB
    OOXmamsxuoWyG+OCDm4IvBatV3aFoSaDYDfUUS4+32+9ApeFR1y785o3QtCy8BY3
    TJXY8z/R6shIq9fx3wNOz6D+2pP2pd2P7OSF7IGqjZMirGwaUVUQTw7O+7ii7hpx
    4IrMisiP08SjG1cg9KfGfnoLDuEH1mvM6W6C5fg6d2lPgmg2yY8wbv8qfl75wply
    SG5/rHwryQWq90nkiy7Rin0Q6iMzY5QrUlxVuQIDAQABAoIBAB2fD77rx2ndZBI/
    ZQJdwMphOV70uAVXplmTADNYZ8uelUVd/tLhhMF304jvW/I9LFEBuNhDsqZJH4V+
    dzghixiDFKouFuSi2aVWyUYCaWxOiWY3wj38+IXI3wyqod1c6oLYDnkAoWCvTvTg
    /9Nyo/O8cpArP3J2QsOEO64FqJGhSfoNgZ1eU38RRwRHVeGohoyh0GtYCih5Q8qh
    Y4hFhGOQa5LBB+glzdMsj5mgRWbC+qVvavZbmHLygzyrSlEM9kVsw51s7if7T4Sj
    wgii2BNzI1YktGj6u4FfB6yNjsLY1IqAypkUgN3qMKn0NRdDtVjrOKYJc+ZvKWGy
    cvwPTGkCgYEA652uUgsYp+fbRrugC1k7LcEJITxTXNlaE7/tyLsb0+bqfYP0GO5Q
    vUiNxsLgkqsWhu/I7AlYy6zd+oEB7GpFV52Kyy11eRyZEwS2R3dYek4N6X7Mra5C
    KXIzxOQTUtKMU6u2c7CnE0jFxZQ1prE4m9hBYT4l0gsjMC4fZpFLiqcCgYEA6NwO
    0ncE/uyfGc7xPI9O7QIZsGWsxyCAI5C4fg+rgpEu+ApzuLWi6QSkKeN1UIWHjzxE
    gstsJPiDI1YUpX+hfcGFEhctgXjTIlKphN6IMXPRetHVtNR0m43jY4cn5Bhclg4k
    7Xg1BrCc1XFTaCrpwYflbKUjW5a7SKc+tjaECJ8CgYEA0dw3eUIC6wLbz2usyI7o
    4/7s59p4kdnSnoaz/7eQuLQTpkpSr6YM6htmlGPdbSXQQc3v0zUcDwXhDY+8q9uX
    +csL5Z6O5JnxSfxHcu49M2q0f4X+PrBYo9vhenx/LaT1ck0ejHsKxWVrKmmxQ9DU
    EBOVYEzfmO9snyxlsZC2jT8CgYEAhPJGwCDVyFn+SDTfhEzpqeV+FzklmRbUMfoJ
    a2e06znK0DDfewCw/0r4EzZbH1rtV3j4QJi1qLH95SnbZdXltK/NMtPq1jXOjZUW
    VdbbeSh/3Bh7Y9+8p6ctwQBEZTUHf2CZ8r6jv6sMD8zA6wM9LJJTCWGLO1pmmQdr
    hYrAfU8CgYAEQ7hr8FfkCn2bUKQAVorjN3G85Ed+WYfhKZKq6oB4QtlBrsdQAOUI
    Og/pCyTfed2SW2NWuz/cGkUYlEB+eIBc2wU1+oPSnas0Jkmxp0wFv0jUVNP1liVy
    XbzXafv+msw0FQZBT9knWQSatF+6LKBCGS3kRkFFoq+NVaSKC15uPQ==
    -----END RSA PRIVATE KEY-----