apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: default
  namespace: aks-istio-system
spec:
  jwtRules:
    - issuer: "test-issuer-1@istio.io"
      jwksUri: "https://raw.githubusercontent.com/istio/istio/master/tests/common/jwt/jwks.json"
    - issuer: "test-issuer-2@istio.io"
      jwksUri: "https://raw.githubusercontent.com/istio/istio/master/tests/common/jwt/jwks.json"
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: aks-istio-egressgateway
  namespace: aks-istio-egress
spec:
  selector:
    matchLabels:
      app: aks-istio-egressgateway
  rules:
    - to: # only allow /allow for company.com
        - operation:
            paths: [ "/allow" ]
            hosts: [ "www.company.com" ]
    - to: # checks only a call 443 over istio mutual without JWT
        - operation:
            hosts: [ "a-echo1-3-36199-only.com" ]
      from:
        - source:
            principals: [ "cluster.local/ns/echo1-3-36199/sa/a" ]
    - to: # checks workload can call 443 over istio mutual with JWT
        - operation:
            hosts: [ "jwt-only.com" ]
      from:
        - source:
            requestPrincipals: [ "test-issuer-1@istio.io/sub-1" ]
    - to: # checks only a can call 443 over istio mutual with JWT
        - operation:
            hosts: [ "jwt-and-a-echo1-3-36199-only.com" ]
      from:
        - source:
            requestPrincipals: [ "test-issuer-1@istio.io/sub-1" ]
            principals: [ "cluster.local/ns/echo1-3-36199/sa/a" ]
---
# TODO(nmittler): Shouldn't need this. Workaround for https://github.com/istio/istio/issues/38704.
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: test-egress
  namespace: aks-istio-system
spec:
  host: "aks-istio-egressgateway.aks-istio-egress.svc.cluster.local"
  trafficPolicy:
    portLevelSettings:
      - port:
          number: 443
        tls:
          mode: ISTIO_MUTUAL